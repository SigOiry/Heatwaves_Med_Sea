<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
    <meta charset="utf-8">
    <meta name="generator" content="quarto-1.7.31">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

    <meta name="author" content="Simon Oiry">
    <meta name="author" content="Maria Laura Zoffoli">
    <meta name="author" content="Christian Marchese">
    <meta name="author" content="Laurent Barillé">
    <meta name="dcterms.date" content="2025-07-23">
    <meta name="keywords" content="Remote Sensing, Heatwaves">

    <title>Marine Heatwaves in a warming Mediterranean Sea</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        width: 0.8em;
        margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
        vertical-align: middle;
      }
      /* CSS for syntax highlighting */
      html { -webkit-text-size-adjust: 100%; }
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
        }
      pre.numberSource { margin-left: 3em;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      /* CSS for citations */
      div.csl-bib-body { }
      div.csl-entry {
        clear: both;
        margin-bottom: 0em;
      }
      .hanging-indent div.csl-entry {
        margin-left:2em;
        text-indent:-2em;
      }
      div.csl-left-margin {
        min-width:2em;
        float:left;
      }
      div.csl-right-inline {
        margin-left:2em;
        padding-left:1em;
      }
      div.csl-indent {
        margin-left: 2em;
      }    </style>

    <style>
      body.hypothesis-enabled #quarto-embed-header {
        padding-right: 36px;
      }

      #quarto-embed-header {
        height: 3em;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: solid 1px;
      }

      #quarto-embed-header h6 {
        font-size: 1.1em;
        padding-top: 0.6em;
        margin-left: 1em;
        margin-right: 1em;
        font-weight: 400;
      }

      #quarto-embed-header a.quarto-back-link,
      #quarto-embed-header a.quarto-download-embed {
        font-size: 0.8em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 1em;
      }

      .quarto-back-container {
        padding-left: 0.5em;
        display: flex;
      }

      .headroom {
          will-change: transform;
          transition: transform 200ms linear;
      }

      .headroom--pinned {
          transform: translateY(0%);
      }

      .headroom--unpinned {
          transform: translateY(-100%);
      }      
    </style>

    <script>
    window.document.addEventListener("DOMContentLoaded", function () {

      var header = window.document.querySelector("#quarto-embed-header");
      const titleBannerEl = window.document.querySelector("body > #title-block-header");
      if (titleBannerEl) {
        titleBannerEl.style.paddingTop = header.clientHeight + "px";
      }
      const contentEl = window.document.getElementById('quarto-content');
      for (const child of contentEl.children) {
        child.style.paddingTop = header.clientHeight + "px";
        child.style.marginTop = "1em";
      }

      // Use the article root if the `back` call doesn't work. This isn't perfect
      // but should typically work
      window.quartoBackToArticle = () => {
        var currentUrl = window.location.href;
        window.history.back();
        setTimeout(() => {
            // if location was not changed in 100 ms, then there is no history back
            if(currentUrl === window.location.href){              
                // redirect to site root
                window.location.href = "index";
            }
        }, 100);
      }

      const headroom = new window.Headroom(header, {
        tolerance: 5,
        onPin: function () {
        },
        onUnpin: function () {
        },
      });
      headroom.init();
    });
    </script>

    
<script src="site_libs/manuscript-notebook/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-1787b60bcbaecd18fb94062f4d294b29.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
     <script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>  
      <meta name="citation_title" content="Marine Heatwaves in a warming Mediterranean Sea">
<meta name="citation_abstract" content="TBD
">
<meta name="citation_keywords" content="Remote Sensing,Heatwaves">
<meta name="citation_author" content="Simon Oiry">
<meta name="citation_author" content="Maria Laura Zoffoli">
<meta name="citation_author" content="Christian Marchese">
<meta name="citation_author" content="Laurent Barillé">
<meta name="citation_publication_date" content="2025-07-23">
<meta name="citation_cover_date" content="2025-07-23">
<meta name="citation_year" content="2025">
<meta name="citation_online_date" content="2025-07-23">
<meta name="citation_language" content="en">
<meta name="citation_journal_title" content="Remote Sensing of Environment">
<meta name="citation_reference" content="citation_title=Copernicus open access hub;,citation_author=Copernicus;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://browser.dataspace.copernicus.eu/;">
<meta name="citation_reference" content="citation_title=The new mediterranean optimally interpolated pathfinder AVHRR SST dataset (1982–2012);,citation_author=Andrea Pisano;,citation_author=Bruno Buongiorno Nardelli;,citation_author=Cristiana Tronconi;,citation_author=Rosalia Santoleri;,citation_publication_date=2016;,citation_cover_date=2016;,citation_year=2016;,citation_doi=10.1016/j.rse.2016.01.019;,citation_volume=176;,citation_journal_title=Remote Sensing of Environment;">
<meta name="citation_reference" content="citation_title=Satellite-based time-series of sea-surface temperature since 1980 for climate applications;,citation_author=Owen Embury;,citation_author=Christopher J. Merchant;,citation_author=Simon A. Good;,citation_author=Nick A. Rayner;,citation_author=Jacob L. Høyer;,citation_author=Christopher Atkinson;,citation_author=Thomas Block;,citation_author=Emy Alerskans;,citation_author=Kevin J. Pearson;,citation_author=Mark Worsfold;,citation_author=Natalie McCarroll;,citation_author=Craig Donlon;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_doi=10.1038/s41597-024-03147-w;,citation_volume=11;,citation_journal_title=Scientific Data;">
<meta name="citation_reference" content="citation_title=A hierarchical approach to defining marine heatwaves;,citation_author=Alistair J Hobday;,citation_author=Lisa V Alexander;,citation_author=Sarah E Perkins;,citation_author=Dan A Smale;,citation_author=Sandra C Straub;,citation_author=Eric CJ Oliver;,citation_author=Jessica A Benthuysen;,citation_author=Michael T Burrows;,citation_author=Markus G Donat;,citation_author=Ming Feng;,citation_author=others;,citation_publication_date=2016;,citation_cover_date=2016;,citation_year=2016;,citation_volume=141;,citation_journal_title=Progress in oceanography;,citation_publisher=Elsevier;">
<meta name="citation_reference" content="citation_title=Categorizing and naming marine heatwaves;,citation_author=Alistair J Hobday;,citation_author=Eric CJ Oliver;,citation_author=Alex Sen Gupta;,citation_author=Jessica A Benthuysen;,citation_author=Michael T Burrows;,citation_author=Markus G Donat;,citation_author=Neil J Holbrook;,citation_author=Pippa J Moore;,citation_author=Mads S Thomsen;,citation_author=Thomas Wernberg;,citation_author=others;,citation_publication_date=2018;,citation_cover_date=2018;,citation_year=2018;,citation_issue=2;,citation_volume=31;,citation_journal_title=Oceanography;,citation_publisher=JSTOR;">
<meta name="citation_reference" content="citation_title=heatwaveR: A central algorithm for the detection of heatwaves and cold-spells;,citation_author=Robert W. Schlegel;,citation_author=Albertus J. Smit;,citation_publication_date=2018;,citation_cover_date=2018;,citation_year=2018;,citation_issue=27;,citation_doi=10.21105/joss.00821;,citation_volume=3;,citation_journal_title=Journal of Open Source Software;">
</head>

  <body class="quarto-notebook quarto-light">
    <div id="quarto-embed-header" class="headroom fixed-top bg-primary">
      
      <a onclick="window.quartoBackToArticle(); return false;" class="btn btn-primary quarto-back-link" href=""><i class="bi bi-caret-left"></i> Back to Article</a>
      <h6><i class="bi bi-journal-code"></i> Article Notebook</h6>

            <a href="./index.qmd" class="btn btn-primary quarto-download-embed" download="index.qmd">Download Source</a>
          </div>

     <header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Marine Heatwaves in a warming Mediterranean Sea</h1>
            <p class="subtitle lead">A temporale analysis</p>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
            <div class="quarto-title-meta-author">
          <div class="quarto-title-meta-heading">Authors</div>
          <div class="quarto-title-meta-heading">Affiliations</div>
          
                <div class="quarto-title-meta-contents">
            <p class="author">Simon Oiry <a href="mailto:oirysimon@gmail.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0001-7161-5246" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Institut des Substances et Organismes de la Mer, ISOMer, Nantes Université, UR 2160, F-44000 Nantes, France
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Maria Laura Zoffoli <a href="https://orcid.org/0000-0003-1892-0051" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Consiglio Nazionale delle Ricerche, Istituto di Scienze Marine (CNR-ISMAR), 00133 Rome, Italy
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Christian Marchese <a href="https://orcid.org/0000-0002-2414-9251" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Consiglio Nazionale delle Ricerche, Istituto di Scienze Marine (CNR-ISMAR), 00133 Rome, Italy
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Laurent Barillé <a href="https://orcid.org/0000-0001-5138-2684" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Institut des Substances et Organismes de la Mer, ISOMer, Nantes Université, UR 2160, F-44000 Nantes, France
                      </p>
                  </div>
                    </div>
        
        <div class="quarto-title-meta">

                      
                <div>
            <div class="quarto-title-meta-heading">Published</div>
            <div class="quarto-title-meta-contents">
              <p class="date">July 23, 2025</p>
            </div>
          </div>
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>

    <div>
      <div class="abstract">
        <div class="block-title">Abstract</div>
        <p>TBD</p>
      </div>
    </div>

    <div>
      <div class="keywords">
        <div class="block-title">Keywords</div>
        <p>Remote Sensing, Heatwaves</p>
      </div>
    </div>

    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#material-methods" id="toc-material-methods" class="nav-link" data-scroll-target="#material-methods"><span class="header-section-number">2</span> Material &amp; Methods</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="header-section-number">3</span> Results</a>
  <ul class="collapse">
  <li><a href="#sst-phenology" id="toc-sst-phenology" class="nav-link" data-scroll-target="#sst-phenology"><span class="header-section-number">3.1</span> SST phenology</a></li>
  <li><a href="#heatwaves-by-regions" id="toc-heatwaves-by-regions" class="nav-link" data-scroll-target="#heatwaves-by-regions"><span class="header-section-number">3.2</span> Heatwaves by regions</a></li>
  <li><a href="#heatwaves-pixel-per-pixels" id="toc-heatwaves-pixel-per-pixels" class="nav-link" data-scroll-target="#heatwaves-pixel-per-pixels"><span class="header-section-number">3.3</span> Heatwaves Pixel per Pixels</a>
  <ul class="collapse">
  <li><a href="#number-of-event-per-year" id="toc-number-of-event-per-year" class="nav-link" data-scroll-target="#number-of-event-per-year"><span class="header-section-number">3.3.1</span> Number of Event per year</a></li>
  <li><a href="#intensity" id="toc-intensity" class="nav-link" data-scroll-target="#intensity"><span class="header-section-number">3.3.2</span> Intensity</a></li>
  <li><a href="#duration" id="toc-duration" class="nav-link" data-scroll-target="#duration"><span class="header-section-number">3.3.3</span> Duration</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">      

       <div class="cell-container"><div class="cell-decorator"><pre>In [1]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.2     ✔ tibble    3.2.1
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.0.4     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyterra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attachement du package : 'tidyterra'

L'objet suivant est masqué depuis 'package:stats':

    filter</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>terra 1.8.50

Attachement du package : 'terra'

L'objet suivant est masqué depuis 'package:tidyr':

    extract</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attachement du package : 'patchwork'

L'objet suivant est masqué depuis 'package:terra':

    area</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(png)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attachement du package : 'gridExtra'

L'objet suivant est masqué depuis 'package:dplyr':

    combine</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggnewscale)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrastr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: le package 'ggrastr' a été compilé avec la version R 4.5.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attachement du package : 'ggrastr'

L'objet suivant est masqué depuis 'package:terra':

    rasterize</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Utilities.Package)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Le chargement a nécessité le package : cowplot

Attachement du package : 'cowplot'

L'objet suivant est masqué depuis 'package:patchwork':

    align_plots

L'objet suivant est masqué depuis 'package:lubridate':

    stamp

Le chargement a nécessité le package : magrittr

Attachement du package : 'magrittr'

Les objets suivants sont masqués depuis 'package:terra':

    extract, inset

L'objet suivant est masqué depuis 'package:purrr':

    set_names

L'objet suivant est masqué depuis 'package:tidyr':

    extract</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>region_col <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># greens</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Levantine Sea"</span> <span class="ot">=</span> <span class="st">"#008F1A"</span>,   <span class="co"># brighter pine-green</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Adriatic sea"</span>  <span class="ot">=</span> <span class="st">"#6B9C3C"</span>,   <span class="co"># vivid olive-sage</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># blues / teals / purples</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Alboran Sea"</span>   <span class="ot">=</span> <span class="st">"#414E7C"</span>,   <span class="co"># richer slate-blue</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Gulf of Lyon"</span>  <span class="ot">=</span> <span class="st">"#266A78"</span>,   <span class="co"># clearer Mediterranean teal</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sea of Sicily"</span> <span class="ot">=</span> <span class="st">"#583C68"</span>,   <span class="co"># deeper indigo-violet</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yellows / ochres</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Balearic Sea"</span>  <span class="ot">=</span> <span class="st">"#A98C3D"</span>,   <span class="co"># crisp mustard-ochre</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Aegean Sea"</span>    <span class="ot">=</span> <span class="st">"#D7A543"</span>,   <span class="co"># sun-baked golden-ochre</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reds / oranges / browns</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tyrrhenian Sea"</span><span class="ot">=</span> <span class="st">"#A02A2A"</span>,   <span class="co"># vivid brick-red</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Algerian Sea"</span>  <span class="ot">=</span> <span class="st">"#DF5513"</span>,   <span class="co"># bright burnt-orange</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ionian Sea"</span>    <span class="ot">=</span> <span class="st">"#705943"</span>    <span class="co"># warmer earthy-taupe</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Marine heatwaves (MHWs) are discrete and prolonged periods of anomalously high sea temperatures that significantly exceed historical baseline conditions. Specifically, a marine heatwave is generally defined as an event lasting five or more consecutive days during which sea temperatures exceed the 90th percentile threshold based on a 30-year historical climatological period (<a href="#fig-HW_explain" class="quarto-xref">Figure&nbsp;1</a>). These events can vary in terms of duration, intensity, and spatial extent, making a flexible yet rigorous approach necessary for accurate characterization and comparison.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [2]:</pre></div><div id="cell-fig-HW_explain" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figs/plot_Tmax_flame.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-HW_explain" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-HW_explain-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="">
<a href="Figs/plot_Tmax_flame.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Exemple of heatwaves detection in Quiberon, France during the summer 2021"><img src="Figs/plot_Tmax_flame.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-HW_explain-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Exemple of heatwaves detection in Quiberon, France during the summer 2021
</figcaption>
</figure>
</div>
</div>
</div></div>
<p>The importance of studying marine heatwaves arises from their profound ecological and socioeconomic impacts. They have been associated with widespread disruptions to marine ecosystems, including shifts in species distribution, local extinctions, significant mortality events, and changes in primary productivity. Such ecological disturbances subsequently affect fisheries, aquaculture, and biodiversity, highlighting the broad-reaching implications of these events.</p>
<p>The Mediterranean Sea, characterized as a climate change hotspot, has witnessed an increased frequency and intensity of marine heatwaves, especially over recent decades. Mediterranean MHWs often coincide with atmospheric heatwaves, further exacerbating their intensity and ecological impacts. Concurrent atmospheric and marine heatwaves amplify sea surface temperature anomalies, leading to intense ocean stratification and extensive ecological disruption, including mass mortalities of benthic invertebrates and seagrass decline.</p>
<p>In the Mediterranean, particularly in the Adriatic Sea, studies have documented variable responses of primary productivity to MHW events. In coastal and eutrophic regions, such as areas influenced by riverine nutrient input, MHWs have resulted in increased phytoplankton biomass. Conversely, offshore and oligotrophic regions typically exhibit reduced chlorophyll-a concentrations during heatwaves, indicating a potential decline in phytoplankton productivity. Such spatial heterogeneity emphasizes the complexity of ecological responses and underscores the importance of localized assessments.</p>
<p>Understanding marine heatwaves, particularly in sensitive regions like the Mediterranean Sea, is crucial for developing informed management strategies aimed at mitigating their ecological and socioeconomic consequences. This necessity is heightened by projections indicating further increases in MHW frequency, duration, and intensity, driven by ongoing climate change.</p>
</section>
<section id="material-methods" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Material &amp; Methods</h1>
<p>Daily Sea Surface Temperature (SST) time series for the Mediterranean Sea, spanning from 1982 onwards, were obtained from the Copernicus Marine Environment Monitoring Service (CMEMS) platform <span class="citation" data-cites="Copernicus_Sentinel pisano2016new embury2024satellite">(<a href="#ref-Copernicus_Sentinel" role="doc-biblioref">Copernicus, 2024</a>; <a href="#ref-embury2024satellite" role="doc-biblioref">Embury et al., 2024</a>; <a href="#ref-pisano2016new" role="doc-biblioref">Pisano et al., 2016</a>)</span>. Heatwave events were detected using the HeatwaveR package in R <span class="citation" data-cites="heatwaveR">(<a href="#ref-heatwaveR" role="doc-biblioref">Schlegel and Smit, 2018</a>)</span>, adhering to the marine heatwave definition provided by <span class="citation" data-cites="hobday2016hierarchical">Hobday et al. (<a href="#ref-hobday2016hierarchical" role="doc-biblioref">2016</a>)</span> and <span class="citation" data-cites="hobday2018categorizing">Hobday et al. (<a href="#ref-hobday2018categorizing" role="doc-biblioref">2018</a>)</span>.</p>
<p>To establish a reference climatology, the first 30 years of the dataset were utilized for each pixel within the Mediterranean Sea. Daily SST values were subsequently compared against this baseline climatology. A heatwave event was identified whenever the daily SST exceeded the 90th percentile of the corresponding climatological distribution. Additionally, consecutive events separated by fewer than two days were merged and treated as a single continuous heatwave event.</p>
<p>Results are presented as annual maps of key heatwave metrics: the total number of days classified as heatwave, the number of distinct heatwave events, and the cumulative intensity of these events, defined as the sum of daily SST exceedances above the climatological 90th percentile threshold.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [3]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your shapefile (replace with your path)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"Black"</span>))</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Get world land polygons</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>plot_medsea <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot land as grey</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot Mediterranean regions, each with a different color</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> med_regions, <span class="fu">aes</span>(<span class="at">fill =</span> name), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Customize colors</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">""</span>,<span class="at">values =</span> region_col)  <span class="sc">+</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── horizontal guide with title on top ──────────────────────</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncol =</span> <span class="dv">1</span>,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">byrow      =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.position =</span> <span class="st">"right"</span>,            <span class="co"># optional – labels below bar</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="fl">0.7</span>, <span class="st">"cm"</span>),       <span class="co"># tweak length</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.7</span>, <span class="st">"cm"</span>)<span class="co"># tweak thickness</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── map extent ──────────────────────────────────────────────</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">40</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">47</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── *** scale bar *** ───────────────────────────────────────</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotation_scale</span>(</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">location   =</span> <span class="st">"bl"</span>,   <span class="co"># bottom-left</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">width_hint =</span> <span class="fl">0.25</span>,   <span class="co"># ≈25 % of the map width</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">line_width =</span> <span class="fl">0.6</span>,</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">text_cex   =</span> <span class="dv">2</span>,</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad_x      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad_y      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── theme ───────────────────────────────────────────────────</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid        =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background  =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>),</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># move legend INSIDE, upper-left; anchor by its top-left corner</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),   <span class="co"># npc coords (x = 2 %, y = 98 %)</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># legend.direction      = "horizontal",</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"vertical"</span>,      <span class="co"># keeps items vertical</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title.align    =</span> <span class="fl">0.5</span>,             <span class="co"># centre title</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># give legend a white background &amp; a bit of padding</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>,<span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>plot_medsea</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/Map_MedSea.png"</span>, plot_medsea, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">645</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [4]:</pre></div><div id="cell-fig-MapMedSea" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figs/Map_MedSea.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MapMedSea" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MapMedSea-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="">
<a href="Figs/Map_MedSea.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: Region of Mediterranean Sea as definied by Marine Strategy Framework Directive."><img src="Figs/Map_MedSea.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MapMedSea-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Region of Mediterranean Sea as definied by Marine Strategy Framework Directive.
</figcaption>
</figure>
</div>
</div>
</div></div>
<p>HW metrics where summerised for each regions of the Mediterranean sea, following the nomenclature defined by the Marine Strategy Framework Directive (MSFD, <a href="#fig-MapMedSea" class="quarto-xref">Figure&nbsp;2</a>).</p>
</section>
<section id="results" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Results</h1>
<section id="sst-phenology" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="sst-phenology"><span class="header-section-number">3.1</span> SST phenology</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [5]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dtplyr)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(duckdb)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>List_HW_csv <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/Cropped_CSV/"</span>, <span class="at">pattern =</span> <span class="st">".csv"</span>,<span class="at">recursive =</span> T, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">filename =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date =</span> <span class="fu">as.Date</span>(<span class="fu">substr</span>(filename,<span class="dv">1</span>,<span class="dv">8</span>), <span class="at">format =</span> <span class="st">"%Y%m%d"</span>), </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">doy =</span> <span class="fu">yday</span>(Date))</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(List_HW_csv<span class="sc">$</span>doy)) {</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  List <span class="ot">&lt;-</span> List_HW_csv <span class="sc">%&gt;%</span> </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(doy <span class="sc">==</span> i)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a progress bar</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  pb <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fu">nrow</span>(List), <span class="at">style =</span> <span class="dv">3</span>)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Efficiently read all CSV files and combine them into a single data.table with progress bar</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  all_data <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(<span class="fu">lapply</span>(<span class="fu">seq_along</span>(List<span class="sc">$</span>path), <span class="cf">function</span>(i) {</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the progress bar</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setTxtProgressBar</span>(pb, i)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the CSV file</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fread</span>(List<span class="sc">$</span>path[i])</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  }), <span class="at">use.names =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Close the progress bar</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(pb)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  split1 <span class="ot">&lt;-</span> all_data <span class="sc">%&gt;%</span> </span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">&lt;=</span> <span class="dv">1991</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">split =</span> <span class="st">"1982-1991"</span>)</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  split2 <span class="ot">&lt;-</span> all_data <span class="sc">%&gt;%</span> </span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">&gt;</span> <span class="dv">1991</span> <span class="sc">&amp;</span> year <span class="sc">&lt;=</span> <span class="dv">2001</span>)<span class="sc">%&gt;%</span> </span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">split =</span> <span class="st">"1992-2001"</span>)</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>  split3 <span class="ot">&lt;-</span> all_data <span class="sc">%&gt;%</span> </span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">&gt;</span> <span class="dv">2001</span> <span class="sc">&amp;</span> year <span class="sc">&lt;=</span> <span class="dv">2011</span>)<span class="sc">%&gt;%</span> </span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">split =</span> <span class="st">"2002-2011"</span>)</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>  split4 <span class="ot">&lt;-</span> all_data <span class="sc">%&gt;%</span> </span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">&gt;</span> <span class="dv">2011</span>)<span class="sc">%&gt;%</span> </span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">split =</span> <span class="st">"2012-2024"</span>)</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>  df_by_split <span class="ot">&lt;-</span> all_data <span class="sc">%&gt;%</span> </span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>           <span class="at">split =</span> <span class="st">"all"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(split1, split2, split3, split4)</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pheno_date &lt;- df_by_split %&gt;% </span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   group_by(x,y,split) %&gt;% </span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   reframe(mean = mean(analysed_sst, na.rm = T),</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           median = median(analysed_sst, na.rm = T),</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           sd = sd(analysed_sst, na.rm = T),</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           p05 = quantile(analysed_sst, probs = 0.05),</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           p25 = quantile(analysed_sst, probs = 0.25),</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           p75 = quantile(analysed_sst, probs = 0.75),</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           p95 = quantile(analysed_sst, probs = 0.95)</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># )</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a temporary DuckDB connection</span></span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), <span class="at">dbdir =</span> <span class="st">":memory:"</span>)</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy the tibble to DuckDB as a lazy table</span></span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>df_lazy <span class="ot">&lt;-</span> <span class="fu">copy_to</span>(con, df_by_split, <span class="at">temporary =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Now summarise using lazy evaluation</span></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>pheno_date <span class="ot">&lt;-</span> df_lazy <span class="sc">%&gt;%</span></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(x, y, split) <span class="sc">%&gt;%</span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean   =</span> <span class="fu">mean</span>(analysed_sst, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">median =</span> <span class="fu">median</span>(analysed_sst, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd     =</span> <span class="fu">sd</span>(analysed_sst, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">p05    =</span> <span class="fu">quantile</span>(analysed_sst, <span class="fl">0.05</span>),</span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">p25    =</span> <span class="fu">quantile</span>(analysed_sst, <span class="fl">0.25</span>),</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">p75    =</span> <span class="fu">quantile</span>(analysed_sst, <span class="fl">0.75</span>),</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">p95    =</span> <span class="fu">quantile</span>(analysed_sst, <span class="fl">0.95</span>),</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">doy =</span> i)<span class="co"># Pull results back into R</span></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(con)</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(df_lazy)</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a><span class="fu">fwrite</span>(pheno_date, <span class="fu">paste0</span>(<span class="st">"Outputs/SST/SST_Phenology/doy/"</span>, <span class="st">"SST_Pheno_DOY_"</span>,i,<span class="st">".csv"</span>))</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [6]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyterra)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpp)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>filelist <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/doy/"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">doy =</span> <span class="fu">gsub</span>(<span class="st">"[^0-9]"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(doy)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize min and max</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>global_min <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>global_max <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through files</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> filelist<span class="sc">$</span>path) {</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read only the column you need (e.g., "SST")</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">fread</span>(file, <span class="at">select =</span> <span class="st">"mean"</span>, <span class="at">showProgress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update global min and max</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  global_min <span class="ot">&lt;-</span> <span class="fu">min</span>(global_min, <span class="fu">min</span>(dt<span class="sc">$</span>mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  global_max <span class="ot">&lt;-</span> <span class="fu">max</span>(global_max, <span class="fu">max</span>(dt<span class="sc">$</span>mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Output</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Global min SST:"</span>, global_min, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Global max SST:"</span>, global_max, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your shapefile (replace with your path)</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"Black"</span>))</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Get world land polygons</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plot clock </span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Define DOY</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>doy <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">366</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> doy,</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">angle =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (doy <span class="sc">/</span> <span class="dv">366</span>) <span class="sc">+</span> pi<span class="sc">/</span><span class="dv">2</span>,   <span class="co"># clockwise + 90° rotation</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># angle = -2 * pi * (doy / 366), </span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">cos</span>(angle),</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">sin</span>(angle)</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Define 15th of each month</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="fu">ymd</span>(<span class="st">"2024-01-15"</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">11</span>)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>month_labels <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(dates, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">locale =</span> <span class="st">"UTC"</span>),</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> <span class="fu">yday</span>(dates),</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">angle =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (doy <span class="sc">/</span> <span class="dv">366</span>) <span class="sc">+</span> pi<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">cos</span>(angle),  <span class="co"># inside the circle</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">sin</span>(angle)</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Ticks at 1st of each month</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>dates_ticks <span class="ot">&lt;-</span> <span class="fu">ymd</span>(<span class="st">"2024-01-01"</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">11</span>)</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>month_ticks <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> <span class="fu">yday</span>(dates_ticks),</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">angle =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (doy <span class="sc">/</span> <span class="dv">366</span>) <span class="sc">+</span> pi<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_start =</span> <span class="fl">0.95</span> <span class="sc">*</span> <span class="fu">cos</span>(angle),</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_start =</span> <span class="fl">0.95</span> <span class="sc">*</span> <span class="fu">sin</span>(angle),</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_end =</span> <span class="fl">1.05</span> <span class="sc">*</span> <span class="fu">cos</span>(angle),</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_end =</span> <span class="fl">1.05</span> <span class="sc">*</span> <span class="fu">sin</span>(angle)</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>raw_clock <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> month_ticks, <span class="fu">aes</span>(<span class="at">x =</span> x_start, <span class="at">y =</span> y_start, <span class="at">xend =</span> x_end, <span class="at">yend =</span> y_end),</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> month_labels, <span class="fu">aes</span>(<span class="at">label =</span> month), <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>output_plots <span class="ot">&lt;-</span> <span class="st">"Outputs/SST/SST_Phenology/plots/"</span></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> filelist<span class="sc">$</span>doy) {</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">fread</span>(filelist<span class="sc">$</span>path[i])</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>  angle_today <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (i <span class="sc">/</span> <span class="dv">366</span>) <span class="sc">+</span> pi<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>  point_today <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">1.0</span> <span class="sc">*</span> <span class="fu">cos</span>(angle_today),</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fl">1.0</span> <span class="sc">*</span> <span class="fu">sin</span>(angle_today)</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>  )  </span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>  plot_clock <span class="ot">&lt;-</span> raw_clock <span class="sc">+</span> </span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">data =</span> point_today, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>) </span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>  clock_grob <span class="ot">&lt;-</span> <span class="fu">ggplotGrob</span>(plot_clock)</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (ii <span class="cf">in</span> <span class="fu">unique</span>(df<span class="sc">$</span>split)) {</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>    df_split <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(split <span class="sc">==</span> ii)</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_tile</span>(<span class="at">data =</span> df_split, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> mean))<span class="sc">+</span></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_grass_c</span>(<span class="st">"celsius"</span>,</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>                         <span class="at">use_grass_range =</span> <span class="cn">FALSE</span>,</span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>                         <span class="at">limits =</span> <span class="fu">c</span>(global_min,global_max),</span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>                         <span class="at">name     =</span> <span class="fu">paste0</span>(<span class="st">"Avg SST ("</span>, ii, <span class="st">")"</span>))<span class="sc">+</span></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>      <span class="do">## ── colour scales ───────────────────────────────────────────</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>      <span class="co"># scale_fill_gradientn(</span></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   colours  = turbo(5),</span></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   na.value = "transparent",</span></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   name     = "Avg number of Event per Year",</span></span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   limits = c(10,15)</span></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>      <span class="co"># ) +</span></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>        <span class="do">## ── horizontal guide with title on top ──────────────────────</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>          <span class="at">direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>          <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>          <span class="at">label.position =</span> <span class="st">"bottom"</span>,            <span class="co"># optional – labels below bar</span></span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>          <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="fl">9.5</span>, <span class="st">"cm"</span>),       <span class="co"># tweak length</span></span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>          <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.45</span>, <span class="st">"cm"</span>)     <span class="co"># tweak thickness</span></span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>      <span class="do">## ── map extent ──────────────────────────────────────────────</span></span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">40</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">47</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>      <span class="do">## ── *** scale bar *** ───────────────────────────────────────</span></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>      <span class="fu">annotation_scale</span>(</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>        <span class="at">location   =</span> <span class="st">"bl"</span>,   <span class="co"># bottom-left</span></span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>        <span class="at">width_hint =</span> <span class="fl">0.25</span>,   <span class="co"># ≈25 % of the map width</span></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>        <span class="at">line_width =</span> <span class="fl">0.6</span>,</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>        <span class="at">text_cex   =</span> <span class="dv">2</span>,</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>        <span class="at">pad_x      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>        <span class="at">pad_y      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>      <span class="do">## ── theme ───────────────────────────────────────────────────</span></span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid        =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.background  =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>),</span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>        <span class="co"># move legend INSIDE, upper-left; anchor by its top-left corner</span></span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),   <span class="co"># npc coords (x = 2 %, y = 98 %)</span></span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title.align    =</span> <span class="fl">0.5</span>,             <span class="co"># centre title</span></span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>        <span class="co"># give legend a white background &amp; a bit of padding</span></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>,<span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_blank</span>()</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotation_custom</span>(</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>    <span class="at">grob  =</span> clock_grob,</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin  =</span> <span class="sc">-</span><span class="dv">9</span>,   <span class="co"># change as needed for position</span></span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmax  =</span> <span class="sc">-</span><span class="dv">1</span>,   <span class="co"># define width</span></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymin  =</span> <span class="dv">36</span>,   <span class="co"># change as needed for vertical placement</span></span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymax  =</span> <span class="dv">44</span>    <span class="co"># define height</span></span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">paste0</span>(output_plots,<span class="st">"/"</span>,ii,<span class="st">"/map_"</span>,ii,<span class="st">"_DOY_"</span>,i,<span class="st">".png"</span>),map,<span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [7]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magick)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/plots/1982-1991"</span>, <span class="at">pattern =</span> <span class="st">".png"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">num =</span> <span class="fu">gsub</span>(<span class="st">".*_"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">".png"</span>,<span class="st">""</span>,.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(num) <span class="sc">%&gt;%</span> </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(path)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>gifski<span class="sc">::</span><span class="fu">gifski</span>(files, <span class="at">gif_file =</span> <span class="st">"Outputs/SST/SST_Phenology/plots/gif/GIF_1982-1991.gif"</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">delay =</span> <span class="fl">0.1</span>, <span class="at">loop =</span> <span class="cn">TRUE</span>, <span class="at">progress =</span> <span class="cn">TRUE</span>,<span class="at">width=</span><span class="dv">3957</span><span class="sc">/</span><span class="dv">4</span>,<span class="at">height=</span><span class="dv">1725</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/plots/1992-2001"</span>, <span class="at">pattern =</span> <span class="st">".png"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">num =</span> <span class="fu">gsub</span>(<span class="st">".*_"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">".png"</span>,<span class="st">""</span>,.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(num) <span class="sc">%&gt;%</span> </span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(path)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>gifski<span class="sc">::</span><span class="fu">gifski</span>(files, <span class="at">gif_file =</span> <span class="st">"Outputs/SST/SST_Phenology/plots/gif/GIF_1992-2001.gif"</span>,</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>               <span class="at">delay =</span> <span class="fl">0.1</span>, <span class="at">loop =</span> <span class="cn">TRUE</span>, <span class="at">progress =</span> <span class="cn">TRUE</span>,<span class="at">width=</span><span class="dv">3957</span><span class="sc">/</span><span class="dv">4</span>,<span class="at">height=</span><span class="dv">1725</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/plots/2002-2011"</span>, <span class="at">pattern =</span> <span class="st">".png"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">num =</span> <span class="fu">gsub</span>(<span class="st">".*_"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">".png"</span>,<span class="st">""</span>,.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(num) <span class="sc">%&gt;%</span> </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(path)</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>gifski<span class="sc">::</span><span class="fu">gifski</span>(files, <span class="at">gif_file =</span> <span class="st">"Outputs/SST/SST_Phenology/plots/gif/GIF_2002-2011.gif"</span>,</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>               <span class="at">delay =</span> <span class="fl">0.1</span>, <span class="at">loop =</span> <span class="cn">TRUE</span>, <span class="at">progress =</span> <span class="cn">TRUE</span>,<span class="at">width=</span><span class="dv">3957</span><span class="sc">/</span><span class="dv">4</span>,<span class="at">height=</span><span class="dv">1725</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/plots/2012-2024"</span>, <span class="at">pattern =</span> <span class="st">".png"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">num =</span> <span class="fu">gsub</span>(<span class="st">".*_"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">".png"</span>,<span class="st">""</span>,.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(num) <span class="sc">%&gt;%</span> </span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(path)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>gifski<span class="sc">::</span><span class="fu">gifski</span>(files, <span class="at">gif_file =</span> <span class="st">"Outputs/SST/SST_Phenology/plots/gif/GIF_2012-2024.gif"</span>,</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>               <span class="at">delay =</span> <span class="fl">0.1</span>, <span class="at">loop =</span> <span class="cn">TRUE</span>, <span class="at">progress =</span> <span class="cn">TRUE</span>,<span class="at">width=</span><span class="dv">3957</span><span class="sc">/</span><span class="dv">4</span>,<span class="at">height=</span><span class="dv">1725</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="do">#### COmbine </span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>gif_list1 <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/plots/1982-1991"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">split1 =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,split1),</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>         <span class="at">num =</span> <span class="fu">gsub</span>(<span class="st">".*_"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">".png"</span>,<span class="st">""</span>,.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(num) <span class="sc">%&gt;%</span> </span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>file)</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>gif_list2 <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/plots/2012-2024"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">split2 =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,split2),</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>         <span class="at">num =</span> <span class="fu">gsub</span>(<span class="st">".*_"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">".png"</span>,<span class="st">""</span>,.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(num) <span class="sc">%&gt;%</span> </span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>file)</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>df_list <span class="ot">&lt;-</span> gif_list1 <span class="sc">%&gt;%</span> </span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(gif_list2, <span class="at">by =</span> <span class="st">"num"</span>)</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> df_list<span class="sc">$</span>num) {</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>  img1 <span class="ot">&lt;-</span> <span class="fu">image_read</span>(df_list<span class="sc">$</span>split1[i])</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>  img2 <span class="ot">&lt;-</span> <span class="fu">image_read</span>(df_list<span class="sc">$</span>split2[i])</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>  combo <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(img1, img2),   <span class="at">stack =</span> <span class="cn">TRUE</span>)   <span class="co"># one above the other</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_write</span>(combo, <span class="at">path =</span> <span class="fu">paste0</span>(<span class="st">"Outputs/SST/SST_Phenology/plots/Merged/combo_"</span>,i,<span class="st">".png"</span>))</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/plots/Merged"</span>, <span class="at">pattern =</span> <span class="st">".png"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>         <span class="at">num =</span> <span class="fu">gsub</span>(<span class="st">".*_"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">".png"</span>,<span class="st">""</span>,.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(num) <span class="sc">%&gt;%</span> </span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(path)</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>gifski<span class="sc">::</span><span class="fu">gifski</span>(files, <span class="at">gif_file =</span> <span class="st">"Outputs/SST/SST_Phenology/plots/gif/Merged_1982-1991-2012-2024.gif"</span>,</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>               <span class="at">delay =</span> <span class="fl">0.1</span>, <span class="at">loop =</span> <span class="cn">TRUE</span>, <span class="at">progress =</span> <span class="cn">TRUE</span>,<span class="at">width=</span><span class="dv">3957</span><span class="sc">/</span><span class="dv">2</span>,<span class="at">height=</span><span class="dv">3450</span><span class="sc">/</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [8]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridisLite)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Utilities.Package)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyterra)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>filelist <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/doy/"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">doy =</span> <span class="fu">gsub</span>(<span class="st">"[^0-9]"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(doy)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> filelist<span class="sc">$</span>doy) {</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">fread</span>(filelist<span class="sc">$</span>path[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(split <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"1982-1991"</span>,<span class="st">"2012-2024"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(x,y,split,mean) <span class="sc">%&gt;%</span> </span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> split, <span class="at">values_from =</span> mean) <span class="sc">%&gt;%</span> </span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">diff =</span> <span class="st">`</span><span class="at">2012-2024</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">1982-1991</span><span class="st">`</span>, </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">doy =</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(x,y,diff,doy)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fwrite</span>(df,<span class="fu">paste0</span>(<span class="st">"Outputs/SST/SST_Phenology/diff_splits/Diff_1982-1991-2012-2024_DOY_"</span>,i,<span class="st">".csv"</span>))</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>filelist <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/diff_splits/"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">doy =</span> <span class="fu">gsub</span>(<span class="st">".*_"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">".csv"</span>,<span class="st">""</span>,.) <span class="sc">%&gt;%</span> </span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(doy)</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize min and max</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>global_min <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>global_max <span class="ot">&lt;-</span> <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through files</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> filelist<span class="sc">$</span>path) {</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read only the column you need (e.g., "SST")</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">fread</span>(file, <span class="at">select =</span> <span class="st">"diff"</span>, <span class="at">showProgress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update global min and max</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>  global_min <span class="ot">&lt;-</span> <span class="fu">min</span>(global_min, <span class="fu">min</span>(dt<span class="sc">$</span>diff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>  global_max <span class="ot">&lt;-</span> <span class="fu">max</span>(global_max, <span class="fu">max</span>(dt<span class="sc">$</span>diff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your shapefile (replace with your path)</span></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"Black"</span>))</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Get world land polygons</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a><span class="do">#### Plot clock </span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Define DOY</span></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>doy <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">366</span></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> doy,</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">angle =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (doy <span class="sc">/</span> <span class="dv">366</span>) <span class="sc">+</span> pi<span class="sc">/</span><span class="dv">2</span>,   <span class="co"># clockwise + 90° rotation</span></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># angle = -2 * pi * (doy / 366), </span></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">cos</span>(angle),</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">sin</span>(angle)</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Define 15th of each month</span></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="fu">ymd</span>(<span class="st">"2024-01-15"</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">11</span>)</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>month_labels <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(dates, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">locale =</span> <span class="st">"UTC"</span>),</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> <span class="fu">yday</span>(dates),</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">angle =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (doy <span class="sc">/</span> <span class="dv">366</span>) <span class="sc">+</span> pi<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">cos</span>(angle),  <span class="co"># inside the circle</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">sin</span>(angle)</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Ticks at 1st of each month</span></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>dates_ticks <span class="ot">&lt;-</span> <span class="fu">ymd</span>(<span class="st">"2024-01-01"</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">11</span>)</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>month_ticks <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> <span class="fu">yday</span>(dates_ticks),</span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">angle =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (doy <span class="sc">/</span> <span class="dv">366</span>) <span class="sc">+</span> pi<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_start =</span> <span class="fl">0.95</span> <span class="sc">*</span> <span class="fu">cos</span>(angle),</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_start =</span> <span class="fl">0.95</span> <span class="sc">*</span> <span class="fu">sin</span>(angle),</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_end =</span> <span class="fl">1.05</span> <span class="sc">*</span> <span class="fu">cos</span>(angle),</span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_end =</span> <span class="fl">1.05</span> <span class="sc">*</span> <span class="fu">sin</span>(angle)</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>raw_clock <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> month_ticks, <span class="fu">aes</span>(<span class="at">x =</span> x_start, <span class="at">y =</span> y_start, <span class="at">xend =</span> x_end, <span class="at">yend =</span> y_end),</span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> month_labels, <span class="fu">aes</span>(<span class="at">label =</span> month), <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>output_plots <span class="ot">&lt;-</span> <span class="st">"Outputs/SST/SST_Phenology/plots/"</span></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> filelist<span class="sc">$</span>doy) {</span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">fread</span>(filelist<span class="sc">$</span>path[i])</span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>  angle_today <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (i <span class="sc">/</span> <span class="dv">366</span>) <span class="sc">+</span> pi<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>  point_today <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">1.0</span> <span class="sc">*</span> <span class="fu">cos</span>(angle_today),</span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fl">1.0</span> <span class="sc">*</span> <span class="fu">sin</span>(angle_today)</span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>  )  </span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>  plot_clock <span class="ot">&lt;-</span> raw_clock <span class="sc">+</span> </span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">data =</span> point_today, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>) </span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>  clock_grob <span class="ot">&lt;-</span> <span class="fu">ggplotGrob</span>(plot_clock)</span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_tile</span>(<span class="at">data =</span> df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> diff))<span class="sc">+</span></span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_gradientn</span>(</span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"SST mean difference</span><span class="sc">\n</span><span class="st">1982–1991 to 2012–2024"</span>,</span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a>  <span class="at">colours =</span> <span class="fu">c</span>(<span class="st">"#2166AC"</span>, <span class="st">"#67A9CF"</span>, <span class="st">"#D1E5F0"</span>,  <span class="co"># Negative (dark to light blue)</span></span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>              <span class="st">"white"</span>,                         <span class="co"># Midpoint (0)</span></span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a>              <span class="st">"#4FF76B"</span>, <span class="st">"#088548"</span>,<span class="st">"#FFBA0A"</span>,<span class="st">"#D40B0B"</span>, <span class="st">"#990E99"</span>),<span class="co"># Positive (light to dark red)</span></span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>  <span class="at">values =</span> scales<span class="sc">::</span><span class="fu">rescale</span>(<span class="fu">c</span>(global_min, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="fl">0.1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">2</span>,<span class="dv">3</span>, global_max)),</span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>  <span class="at">limits =</span> <span class="fu">c</span>(global_min, global_max)</span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>)<span class="sc">+</span></span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(</span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a>          <span class="at">direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a>          <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a>          <span class="at">label.position =</span> <span class="st">"bottom"</span>,            <span class="co"># optional – labels below bar</span></span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a>          <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="fl">9.5</span>, <span class="st">"cm"</span>),       <span class="co"># tweak length</span></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a>          <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.45</span>, <span class="st">"cm"</span>)     <span class="co"># tweak thickness</span></span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a>      <span class="do">## ── map extent ──────────────────────────────────────────────</span></span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">40</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">47</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a>      <span class="do">## ── *** scale bar *** ───────────────────────────────────────</span></span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a>      <span class="fu">annotation_scale</span>(</span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a>        <span class="at">location   =</span> <span class="st">"bl"</span>,   <span class="co"># bottom-left</span></span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a>        <span class="at">width_hint =</span> <span class="fl">0.25</span>,   <span class="co"># ≈25 % of the map width</span></span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a>        <span class="at">line_width =</span> <span class="fl">0.6</span>,</span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a>        <span class="at">text_cex   =</span> <span class="dv">2</span>,</span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a>        <span class="at">pad_x      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a>        <span class="at">pad_y      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a>      <span class="do">## ── theme ───────────────────────────────────────────────────</span></span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid        =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.background  =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>),</span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a>        <span class="co"># move legend INSIDE, upper-left; anchor by its top-left corner</span></span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),   <span class="co"># npc coords (x = 2 %, y = 98 %)</span></span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title.align    =</span> <span class="fl">0.5</span>,             <span class="co"># centre title</span></span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a>        <span class="co"># give legend a white background &amp; a bit of padding</span></span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>,<span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_blank</span>()</span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb23-184"><a href="#cb23-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotation_custom</span>(</span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">grob  =</span> clock_grob,</span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin  =</span> <span class="sc">-</span><span class="dv">9</span>,   <span class="co"># change as needed for position</span></span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmax  =</span> <span class="sc">-</span><span class="dv">1</span>,   <span class="co"># define width</span></span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymin  =</span> <span class="fl">35.5</span>,   <span class="co"># change as needed for vertical placement</span></span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymax  =</span> <span class="fl">43.5</span>    <span class="co"># define height</span></span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">paste0</span>(output_plots,<span class="st">"/Difference/map_differences_DOY_"</span>,i,<span class="st">".png"</span>),map,<span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/plots/Difference"</span>, <span class="at">pattern =</span> <span class="st">".png"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a>         <span class="at">num =</span> <span class="fu">gsub</span>(<span class="st">".*_"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">".png"</span>,<span class="st">""</span>,.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(num) <span class="sc">%&gt;%</span> </span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(path)</span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a>gifski<span class="sc">::</span><span class="fu">gifski</span>(files, <span class="at">gif_file =</span> <span class="st">"Outputs/SST/SST_Phenology/plots/gif/Difference_1982-1991-2012-2024.gif"</span>,</span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a>               <span class="at">delay =</span> <span class="fl">0.1</span>, <span class="at">loop =</span> <span class="cn">TRUE</span>, <span class="at">progress =</span> <span class="cn">TRUE</span>,<span class="at">width=</span><span class="dv">3957</span><span class="sc">/</span><span class="dv">2</span>,<span class="at">height=</span><span class="dv">1725</span><span class="sc">/</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [9]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your shapefile (replace with your path)</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"Black"</span>))</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get world land polygons</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>model_rast <span class="ot">&lt;-</span> <span class="st">"Outputs/SST/nc/n_event_per_year/n_event_1982.nc"</span> <span class="sc">%&gt;%</span> </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>()</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(model_rast) <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(model_rast)<span class="ot">&lt;-</span> <span class="st">"val"</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>filelist <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/doy/"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">doy =</span> <span class="fu">gsub</span>(<span class="st">"[^0-9]"</span>,<span class="st">""</span>,file) <span class="sc">%&gt;%</span> </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(doy)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">215</span><span class="sc">:</span><span class="fu">max</span>(filelist<span class="sc">$</span>doy)) {</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  df_i <span class="ot">&lt;-</span> <span class="fu">fread</span>(filelist<span class="sc">$</span>path[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(split <span class="sc">!=</span> <span class="st">"all"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>doy)</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (ii <span class="cf">in</span> <span class="fu">unique</span>(df_i<span class="sc">$</span>split)) {</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    df_ii <span class="ot">&lt;-</span> df_i <span class="sc">%&gt;%</span> </span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(split <span class="sc">==</span> ii) <span class="sc">%&gt;%</span> </span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>split)</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    pts <span class="ot">&lt;-</span> <span class="fu">vect</span>(df_ii, <span class="at">geom =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="fu">crs</span>(model_rast))</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    rast_df <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>      pts,             <span class="co"># what to burn</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>      model_rast,         <span class="co"># target raster geometry</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">field =</span> <span class="fu">c</span>(<span class="st">"mean"</span>,   <span class="st">"median"</span> ,<span class="st">"sd"</span>   ,  <span class="st">"p05"</span>   , <span class="st">"p25"</span> ,   <span class="st">"p75"</span>  ,  <span class="st">"p95"</span>), <span class="co"># column to transfer</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">fun   =</span> <span class="st">"mean"</span>   <span class="co"># how to handle duplicate points (mean, max, sum, …)</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(rast_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mean"</span>,<span class="st">"median"</span>,<span class="st">"sd"</span>,<span class="st">"p05"</span>,<span class="st">"p25"</span>,<span class="st">"p75"</span>,<span class="st">"p95"</span>)</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeRaster</span>(rast_df, <span class="fu">paste0</span>(<span class="st">"Outputs/SST/SST_Phenology/Zonal_Statistics/rast/"</span>,ii,<span class="st">"/Rast_Pheno_"</span>,ii,<span class="st">"_DOY_"</span>,i,<span class="st">".tif"</span>),<span class="at">overwrite =</span> T)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [10]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(progress)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"Black"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Id) <span class="sc">%&gt;%</span> </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vect</span>()</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>med_regions_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"Black"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(Id)) <span class="sc">%&gt;%</span> </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span> geometry)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"poly_id"</span> <span class="sc">%in%</span> <span class="fu">names</span>(med_regions)) med_regions<span class="sc">$</span>poly_id <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(med_regions))</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"poly_id"</span> <span class="sc">%in%</span> <span class="fu">names</span>(med_regions_sf)) med_regions_sf<span class="sc">$</span>poly_id <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(med_regions_sf))</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>folderlist <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Outputs/SST/SST_Phenology/Zonal_Statistics/rast/"</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">split =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path))</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="co">#––––– OUTER progress bar (splits) –––––#</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>pb_split <span class="ot">&lt;-</span> progress_bar<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">total   =</span> <span class="fu">length</span>(folderlist<span class="sc">$</span>split),</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">clear   =</span> <span class="cn">FALSE</span>,</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">format  =</span> <span class="st">"Split :current/:total [:bar] :percent  elapsed=:elapsed"</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>first <span class="ot">&lt;-</span> <span class="cn">TRUE</span>   <span class="co"># flag to initialise df_out the first time</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (split <span class="cf">in</span> folderlist<span class="sc">$</span>split) {</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  pb_split<span class="sc">$</span><span class="fu">tick</span>()   <span class="co"># advance outer bar</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>  split_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Outputs"</span>, <span class="st">"SST"</span>, <span class="st">"SST_Phenology"</span>, <span class="st">"Zonal_Statistics"</span>, <span class="st">"rast"</span>, split</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>  filelist_split <span class="ot">&lt;-</span> <span class="fu">list.files</span>(split_path, <span class="at">full.names =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">path =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">file =</span> <span class="fu">basename</span>(path),</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">doy  =</span> <span class="fu">sub</span>(<span class="st">".*_(</span><span class="sc">\\</span><span class="st">d+)</span><span class="sc">\\</span><span class="st">.tif$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, file) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>()</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(doy)</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">#––––– INNER progress bar (doys within this split) –––––#</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>  pb_doy <span class="ot">&lt;-</span> progress_bar<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">total  =</span> <span class="fu">nrow</span>(filelist_split),</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">clear  =</span> <span class="cn">FALSE</span>,</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="fu">sprintf</span>(<span class="st">"  -&gt; %s :current/:total [:bar] :percent  elapsed=:elapsed"</span>, split)</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(filelist_split))) {</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>    pb_doy<span class="sc">$</span><span class="fu">tick</span>()   <span class="co"># advance inner bar</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    img <span class="ot">&lt;-</span> <span class="fu">rast</span>(filelist_split<span class="sc">$</span>path[i])</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    doy <span class="ot">&lt;-</span> filelist_split<span class="sc">$</span>doy[i]</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>           img, med_regions,</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>           <span class="at">fun =</span> mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>    p_means <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>                 med_regions_sf,</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>                 m[<span class="fu">match</span>(med_regions_sf<span class="sc">$</span>poly_id, m<span class="sc">$</span>ID), <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>               ) <span class="sc">%&gt;%</span> </span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mutate</span>(<span class="at">doy =</span> doy,</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>                      <span class="at">split =</span> split) <span class="sc">%&gt;%</span> </span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>               <span class="fu">select</span>(<span class="sc">-</span>poly_id)</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (first) {</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>      df_out <span class="ot">&lt;-</span> p_means</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>      first  <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>      df_out <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(df_out, p_means)</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>  pb_doy<span class="sc">$</span><span class="fu">terminate</span>()  <span class="co"># finish inner bar for this split</span></span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>pb_split<span class="sc">$</span><span class="fu">terminate</span>() </span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a><span class="fu">fwrite</span>(df_out,<span class="st">"Outputs/SST/SST_Phenology/Zonal_Statistics/zonal_stats_DOY_decades.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [11]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scico) </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"Outputs/SST/SST_Phenology/Zonal_Statistics/zonal_stats_DOY_decades.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> doy, <span class="at">y =</span> mean, <span class="at">color =</span> split, <span class="at">fill =</span> split)) <span class="sc">+</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> sd, <span class="at">ymax =</span> mean <span class="sc">+</span> sd), </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_scico_d</span>(<span class="at">palette =</span> <span class="st">"batlow"</span>) <span class="sc">+</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_scico_d</span>(<span class="at">palette =</span> <span class="st">"batlow"</span>) <span class="sc">+</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean SST (°C)"</span>,</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Period"</span>,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Period"</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Seasonal SST Trends with Variability Bands"</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> doy, <span class="at">y =</span> mean, <span class="at">color =</span> split)) <span class="sc">+</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name) <span class="sc">+</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_scico_d</span>(<span class="at">palette =</span> <span class="st">"batlow"</span>) <span class="sc">+</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean SST (°C)"</span>,</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Period"</span>,</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Smoothed Seasonal SST Trends by Region"</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [12]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(progress)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load regions</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">read_sf</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>med_regions<span class="sc">$</span>region_ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(med_regions)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># List all .nc files and extract date</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>nc_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"Data/SST"</span>, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.nc$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">path =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">basename</span>(path),</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">date =</span> <span class="fu">substr</span>(file, <span class="dv">1</span>, <span class="dv">8</span>))  <span class="co"># adapt if date format is different</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize list to store results</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>results_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">nrow</span>(nc_files))</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create progress bar</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>pb <span class="ot">&lt;-</span> progress_bar<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">total =</span> <span class="fu">nrow</span>(nc_files),</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">"[:bar] :percent | :current/:total files | ETA: :eta"</span>,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">clear =</span> <span class="cn">FALSE</span>,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">60</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop efficiently</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(nc_files))) {</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  pb<span class="sc">$</span><span class="fu">tick</span>()</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load raster</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  sst <span class="ot">&lt;-</span> <span class="fu">rast</span>(nc_files<span class="sc">$</span>path[i], <span class="at">subds =</span> <span class="dv">1</span>)</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract SST values by region</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  extracted <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(sst, med_regions)</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate statistics</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>  stats <span class="ot">&lt;-</span> extracted <span class="sc">%&gt;%</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">value =</span> <span class="dv">2</span>, <span class="at">region_ID =</span> ID) <span class="sc">%&gt;%</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(region_ID) <span class="sc">%&gt;%</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean   =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">median =</span> <span class="fu">median</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd     =</span> <span class="fu">sd</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">p10    =</span> <span class="fu">quantile</span>(value, <span class="fl">0.10</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">p25    =</span> <span class="fu">quantile</span>(value, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">p75    =</span> <span class="fu">quantile</span>(value, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">p90    =</span> <span class="fu">quantile</span>(value, <span class="fl">0.90</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> nc_files<span class="sc">$</span>date[i])</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>  results_list[[i]] <span class="ot">&lt;-</span> stats</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(sst, extracted, stats)</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()  <span class="co"># clean memory</span></span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all results</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>df_out <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_list)</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Add region names</span></span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>region_info <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(med_regions)[, <span class="fu">c</span>(<span class="st">"region_ID"</span>, <span class="st">"name"</span>)]</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>final_df <span class="ot">&lt;-</span> <span class="fu">left_join</span>(df_out, region_info, <span class="at">by =</span> <span class="st">"region_ID"</span>)</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Save results ----</span></span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(final_df, <span class="st">"Outputs/SST/region_stats.csv"</span>, <span class="at">row.names =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [13]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(trend) </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>df_simon <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"Outputs/SST/region_stats.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.character</span>(date) <span class="sc">%&gt;%</span> <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>),</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean =</span> mean <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">median =</span> median <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">p10 =</span> p10 <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">p25 =</span> p25 <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">p75 =</span> p75 <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">p90 =</span> p90 <span class="sc">-</span> <span class="fl">273.15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">region =</span> <span class="st">"name"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(region_ID,date,region), <span class="at">names_to =</span> <span class="st">"metric"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">region_ID =</span> <span class="fu">as.character</span>(region_ID)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">value_simon =</span> value)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>regionID <span class="ot">&lt;-</span> df_simon <span class="sc">%&gt;%</span> </span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region_ID) <span class="sc">%&gt;%</span> </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">region =</span> <span class="fu">unique</span>(region))</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>path_file_chouchou <span class="ot">&lt;-</span> rstudioapi<span class="sc">::</span><span class="fu">selectFile</span>()</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>df_chouchou <span class="ot">&lt;-</span><span class="fu">fread</span>(path_file_chouchou) <span class="sc">%&gt;%</span> </span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()<span class="sc">%&gt;%</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols       =</span> <span class="sc">-</span>Date,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to   =</span> <span class="fu">c</span>(<span class="st">"metric"</span>, <span class="st">"region_ID"</span>),</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_pattern =</span> <span class="st">"(.*)_region_(</span><span class="sc">\\</span><span class="st">d+)"</span>,</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to  =</span> <span class="st">"value"</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">date =</span> <span class="st">"Date"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(regionID, <span class="at">by =</span> <span class="st">"region_ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.character</span>(date) <span class="sc">%&gt;%</span> <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>),</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">metric =</span> <span class="fu">tolower</span>(metric),</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">metric =</span> <span class="fu">case_when</span>(metric <span class="sc">==</span> <span class="st">"std"</span> <span class="sc">~</span> <span class="st">"sd"</span>,</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>                            T <span class="sc">~</span> metric)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">value_chouchou =</span> value)</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>df_both <span class="ot">&lt;-</span> df_simon <span class="sc">%&gt;%</span> </span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_chouchou, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>,<span class="st">"metric"</span>,<span class="st">"region_ID"</span>,<span class="st">"region"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">difference =</span> (value_chouchou <span class="sc">-</span> value_simon) <span class="sc">/</span> value_simon <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> df_both <span class="sc">%&gt;%</span> </span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region,metric) <span class="sc">%&gt;%</span> </span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">avg =</span> <span class="fu">mean</span>(difference))</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="fu">fwrite</span>(df_both,<span class="fu">paste0</span>(rstudioapi<span class="sc">::</span><span class="fu">selectDirectory</span>(),<span class="st">"/compare_extraction.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [14]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attachement du package : 'zoo'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>L'objet suivant est masqué depuis 'package:terra':

    time&lt;-</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Les objets suivants sont masqués depuis 'package:base':

    as.Date, as.Date.numeric</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(trend) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: le package 'trend' a été compilé avec la version R 4.5.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attachement du package : 'data.table'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Les objets suivants sont masqués depuis 'package:zoo':

    yearmon, yearqtr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>L'objet suivant est masqué depuis 'package:terra':

    shift</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Les objets suivants sont masqués depuis 'package:lubridate':

    hour, isoweek, mday, minute, month, quarter, second, wday, week,
    yday, year</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Les objets suivants sont masqués depuis 'package:dplyr':

    between, first, last</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>L'objet suivant est masqué depuis 'package:purrr':

    transpose</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(heatwaveR)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"../Outputs/SST/region_stats.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.character</span>(date) <span class="sc">%&gt;%</span> <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean =</span> mean <span class="sc">-</span> <span class="fl">273.15</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(date,<span class="at">region =</span> <span class="st">"name"</span>,<span class="at">SST =</span> <span class="st">"mean"</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Your input df must have columns:</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   date   (Date), region (chr/fct), SST (numeric)</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1. Add year &amp; day-of-year ──────────────────────────────────────────────</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">yday =</span> <span class="fu">yday</span>(date)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2. Build climatology baseline (exclude most recent year) ───────────────</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>baseline <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&lt;=</span> <span class="fu">max</span>(year) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3. Compute region-specific warm-season threshold ───────────────────────</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     here using the 75th percentile of baseline SST per region</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>region_thresh <span class="ot">&lt;-</span> baseline <span class="sc">%&gt;%</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">warm_thresh =</span> <span class="fu">quantile</span>(SST, <span class="at">probs =</span> <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 4. Join threshold back onto full data &amp; compute anomalies ──────────────</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>df3 <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(region_thresh, <span class="at">by =</span> <span class="st">"region"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, yday) <span class="sc">%&gt;%</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">clim_mean =</span> <span class="fu">mean</span>(SST[year <span class="sc">&lt;=</span> <span class="fu">max</span>(year)<span class="sc">-</span><span class="dv">1</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">anomaly   =</span> SST <span class="sc">-</span> clim_mean</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a><span class="co"># head(df3)</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 5. Threshold-based dates using region-specific warm_thresh ────────────</span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>threshold_metrics <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, year) <span class="sc">%&gt;%</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">warm_onset =</span> {</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>      r <span class="ot">&lt;-</span> SST <span class="sc">&gt;</span> warm_thresh</span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>      dd <span class="ot">&lt;-</span> <span class="fu">rle</span>(r)</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>      ends  <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(dd<span class="sc">$</span>lengths)</span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>      starts<span class="ot">&lt;-</span> ends <span class="sc">-</span> dd<span class="sc">$</span>lengths <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>      idx   <span class="ot">&lt;-</span> <span class="fu">which</span>(dd<span class="sc">$</span>values <span class="sc">&amp;</span> dd<span class="sc">$</span>lengths <span class="sc">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(idx)) date[starts[idx[<span class="dv">1</span>]]] <span class="cf">else</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>)</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">warm_end =</span> {</span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>      sel <span class="ot">&lt;-</span> <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">11</span></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>      r   <span class="ot">&lt;-</span> sel <span class="sc">&amp;</span> (SST <span class="sc">&lt;</span> warm_thresh)</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>      dd  <span class="ot">&lt;-</span> <span class="fu">rle</span>(r)</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>      ends  <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(dd<span class="sc">$</span>lengths)</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>      starts<span class="ot">&lt;-</span> ends <span class="sc">-</span> dd<span class="sc">$</span>lengths <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>      idx   <span class="ot">&lt;-</span> <span class="fu">which</span>(dd<span class="sc">$</span>values <span class="sc">&amp;</span> dd<span class="sc">$</span>lengths <span class="sc">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(idx)) date[starts[idx[<span class="dv">1</span>]]] <span class="cf">else</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>)</span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 6. Cumulative-heat metrics (optional: can also use warm_thresh per region) ─</span></span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>cumulative_metrics <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, year) <span class="sc">%&gt;%</span></span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">DHD =</span> <span class="fu">sum</span>(<span class="fu">pmax</span>(<span class="dv">0</span>, SST <span class="sc">-</span> warm_thresh), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">DHW =</span> DHD <span class="sc">/</span> <span class="dv">7</span>,</span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 7. Marine heatwave metrics ─────────────────────────────────────────────</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 6a. Compute each region’s baseline period ───────────────────────────────</span></span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>region_clim <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># use all but the last year as “baseline”</span></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">clim_start =</span> <span class="fu">min</span>(date[year <span class="sc">&lt;=</span> <span class="fu">max</span>(year) <span class="sc">-</span> <span class="dv">1</span>]),</span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">clim_end   =</span> <span class="fu">max</span>(date[year <span class="sc">&lt;=</span> <span class="fu">max</span>(year) <span class="sc">-</span> <span class="dv">1</span>]),</span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect:</span></span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a><span class="co"># region_clim</span></span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 6b. Detect marine heatwaves over the full time‐series per region ────────</span></span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a>events_by_region <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do</span>({</span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> .</span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) full SST time‐series for this region</span></span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a>    ts_all <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">t =</span> d<span class="sc">$</span>date, <span class="at">temp =</span> d<span class="sc">$</span>SST)</span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) pick up the matching baseline window</span></span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a>    bc <span class="ot">&lt;-</span> region_clim <span class="sc">%&gt;%</span> <span class="fu">filter</span>(region <span class="sc">==</span> d<span class="sc">$</span>region[<span class="dv">1</span>])</span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) build climatology &amp; detect events</span></span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a>    cm <span class="ot">&lt;-</span> <span class="fu">ts2clm</span>(ts_all, <span class="at">climatologyPeriod =</span> <span class="fu">c</span>(bc<span class="sc">$</span>clim_start, bc<span class="sc">$</span>clim_end))</span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a>    ev <span class="ot">&lt;-</span> <span class="fu">detect_event</span>(cm)<span class="sc">$</span>event</span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(ev) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a>      <span class="co"># return empty tibble so we can right_join later</span></span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>()</span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a>      <span class="co"># tag each event with the calendar year it started</span></span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a>      ev <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date_start))</span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span></span>
<span id="cb42-114"><a href="#cb42-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb42-115"><a href="#cb42-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-116"><a href="#cb42-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect:</span></span>
<span id="cb42-117"><a href="#cb42-117" aria-hidden="true" tabindex="-1"></a><span class="co"># head(events_by_region)</span></span>
<span id="cb42-118"><a href="#cb42-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-119"><a href="#cb42-119" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 6c. Summarize events by region &amp; year ──────────────────────────────────</span></span>
<span id="cb42-120"><a href="#cb42-120" aria-hidden="true" tabindex="-1"></a>heatwave_metrics <span class="ot">&lt;-</span> events_by_region <span class="sc">%&gt;%</span></span>
<span id="cb42-121"><a href="#cb42-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, year) <span class="sc">%&gt;%</span></span>
<span id="cb42-122"><a href="#cb42-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb42-123"><a href="#cb42-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_count    =</span> <span class="fu">n</span>(),</span>
<span id="cb42-124"><a href="#cb42-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_mean_dur =</span> <span class="fu">mean</span>(duration,        <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-125"><a href="#cb42-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_max_dur  =</span> <span class="fu">max</span>(duration,         <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-126"><a href="#cb42-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_mean_int =</span> <span class="fu">mean</span>(intensity_max,   <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-127"><a href="#cb42-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_max_int  =</span> <span class="fu">max</span>(intensity_max,    <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-128"><a href="#cb42-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_cum_int  =</span> <span class="fu">sum</span>(intensity_cumulative,     <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-129"><a href="#cb42-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb42-130"><a href="#cb42-130" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb42-131"><a href="#cb42-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make sure years with zero events still appear</span></span>
<span id="cb42-132"><a href="#cb42-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(</span>
<span id="cb42-133"><a href="#cb42-133" aria-hidden="true" tabindex="-1"></a>    df3 <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(region, year),</span>
<span id="cb42-134"><a href="#cb42-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"region"</span>, <span class="st">"year"</span>)</span>
<span id="cb42-135"><a href="#cb42-135" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb42-136"><a href="#cb42-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(</span>
<span id="cb42-137"><a href="#cb42-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_count =</span> <span class="dv">0</span>,</span>
<span id="cb42-138"><a href="#cb42-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_mean_dur =</span> <span class="cn">NA</span>, <span class="at">mhw_max_dur =</span> <span class="cn">NA</span>,</span>
<span id="cb42-139"><a href="#cb42-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_mean_int =</span> <span class="cn">NA</span>, <span class="at">mhw_max_int =</span> <span class="cn">NA</span>,</span>
<span id="cb42-140"><a href="#cb42-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">mhw_cum_int =</span> <span class="dv">0</span></span>
<span id="cb42-141"><a href="#cb42-141" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb42-142"><a href="#cb42-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-143"><a href="#cb42-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-144"><a href="#cb42-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-145"><a href="#cb42-145" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 8. Seasonal-cycle stats ────────────────────────────────────────────────</span></span>
<span id="cb42-146"><a href="#cb42-146" aria-hidden="true" tabindex="-1"></a>seasonal_metrics <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb42-147"><a href="#cb42-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, year) <span class="sc">%&gt;%</span></span>
<span id="cb42-148"><a href="#cb42-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb42-149"><a href="#cb42-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_max     =</span> date[<span class="fu">which.max</span>(SST)],</span>
<span id="cb42-150"><a href="#cb42-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_min     =</span> date[<span class="fu">which.min</span>(SST)],</span>
<span id="cb42-151"><a href="#cb42-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">amplitude    =</span> <span class="fu">max</span>(SST) <span class="sc">-</span> <span class="fu">min</span>(SST),</span>
<span id="cb42-152"><a href="#cb42-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">warming_rate =</span> {</span>
<span id="cb42-153"><a href="#cb42-153" aria-hidden="true" tabindex="-1"></a>      sel <span class="ot">&lt;-</span> <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb42-154"><a href="#cb42-154" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">sum</span>(sel) <span class="sc">&gt;</span> <span class="dv">2</span>) <span class="fu">coef</span>(<span class="fu">lm</span>(SST[sel] <span class="sc">~</span> yday[sel]))[<span class="dv">2</span>] <span class="cf">else</span> <span class="cn">NA</span></span>
<span id="cb42-155"><a href="#cb42-155" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb42-156"><a href="#cb42-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">cooling_rate =</span> {</span>
<span id="cb42-157"><a href="#cb42-157" aria-hidden="true" tabindex="-1"></a>      sel <span class="ot">&lt;-</span> <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">11</span></span>
<span id="cb42-158"><a href="#cb42-158" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">sum</span>(sel) <span class="sc">&gt;</span> <span class="dv">2</span>) <span class="fu">coef</span>(<span class="fu">lm</span>(SST[sel] <span class="sc">~</span> yday[sel]))[<span class="dv">2</span>] <span class="cf">else</span> <span class="cn">NA</span></span>
<span id="cb42-159"><a href="#cb42-159" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb42-160"><a href="#cb42-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb42-161"><a href="#cb42-161" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [15]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>df_timeserie <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"../Outputs/SST/region_stats.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.character</span>(date) <span class="sc">%&gt;%</span> <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean =</span> mean <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">median =</span> median <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">p10 =</span> p10 <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">p25 =</span> p25 <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">p75 =</span> p75 <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">p90 =</span> p90 <span class="sc">-</span> <span class="fl">273.15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">doy =</span> <span class="fu">yday</span>(date),</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">year</span>(date))</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>df_minmax <span class="ot">&lt;-</span> df_timeserie <span class="sc">%&gt;%</span> </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name,year) <span class="sc">%&gt;%</span> </span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">min =</span> <span class="fu">min</span>(mean),</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">max =</span> <span class="fu">max</span>(mean)) <span class="sc">%&gt;%</span> </span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">max =</span> <span class="fu">lm</span>(max<span class="sc">~</span>year)<span class="sc">$</span>coefficients[[<span class="dv">2</span>]],</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">min =</span> <span class="fu">lm</span>(min<span class="sc">~</span>year)<span class="sc">$</span>coefficients[[<span class="dv">2</span>]], </span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>          <span class="at">diff =</span> (max <span class="sc">-</span> min)<span class="sc">/</span>max)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(df_minmax<span class="sc">$</span>diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3825375</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute breaks every 15 days (1, 16, 31, … up to 361)</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>doy_breaks_15 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">366</span>, <span class="at">by =</span> <span class="dv">60</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># generate labels like “Jan 01”, “Jan 16”, …</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>doy_labels_15 <span class="ot">&lt;-</span>  lubridate<span class="sc">::</span><span class="fu">month</span>(<span class="fu">as.Date</span>(doy_breaks_15 <span class="sc">-</span> <span class="dv">1</span>, <span class="at">origin =</span> <span class="fu">as.Date</span>(<span class="st">"2001-01-01"</span>)), <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">locale =</span> <span class="st">"UTC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.character</span>()</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>plot_timeserie <span class="ot">&lt;-</span> df_timeserie <span class="sc">%&gt;%</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(name == "Adriatic sea") %&gt;%</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> doy, <span class="at">y =</span> mean, <span class="at">color =</span> year, <span class="at">group =</span> year)) <span class="sc">+</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># points</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># smooth GAM curves</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">alpha=</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># facets</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> name, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> doy_breaks_15,</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> doy_labels_15)<span class="sc">+</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make the colorbar wide and move its title on top</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust    =</span> <span class="fl">0.5</span>,</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="dv">8</span>, <span class="st">"cm"</span>),</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># darkblue → darkred gradient</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient2</span>(</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Year"</span>,</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">low  =</span> <span class="st">"darkblue"</span>,</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">mid =</span> <span class="st">"white"</span>,</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">high =</span> <span class="st">"darkred"</span>,</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">midpoint =</span> <span class="fu">mean</span>(<span class="fu">c</span>(<span class="dv">2024</span>,<span class="dv">1982</span>)),</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># labels</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">x        =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">y        =</span> <span class="st">"Average SST (°C)"</span>,</span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.background      =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"gray90"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text            =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>),</span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># legend at bottom, horizontal</span></span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.8</span>,<span class="fl">0.1</span>),</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.box            =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a little breathing room below panels</span></span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin           =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">5</span>, <span class="at">r =</span> <span class="dv">5</span>, <span class="at">b =</span> <span class="dv">30</span>, <span class="at">l =</span> <span class="dv">5</span>),</span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grid tweaks</span></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major      =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray85"</span>),</span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor      =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: A numeric `legend.position` argument in `theme()` was deprecated in ggplot2
3.5.0.
ℹ Please use the `legend.position.inside` argument of `theme()` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("Manuscript/Figs/plot_time_serie.png",plot_timeserie, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Yearly SST time series for each of the 10 Mediterranean sub-regions are presented in <a href="#fig-MapMedSea_timeseries" class="quarto-xref">Figure&nbsp;3</a>. Across all regions, periods of minimum and maximum temperatures occur synchronously, with minima in February–March and maxima in July–August. Overall, every sub-region exhibits higher SST values in 2024 compared to 1982. The most significant increase in summer temperature maxima is observed in Adriatic sea, with a warming rate of 0.63 °C per decade. Similarly, the most substantial increase in winter temperature minima occurs in Aegean Sea showing a warming rate of 0.4 °C per decade.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [16]:</pre></div><div id="cell-fig-MapMedSea_timeseries" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figs/plot_time_serie.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MapMedSea_timeseries" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MapMedSea_timeseries-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="">
<a href="Figs/plot_time_serie.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;3: Seasonal cycle of average sea surface temperature (°C) for ten Mediterranean sub-regions. In each panel, semi-transparent points are daily SST average of the region and solid lines are GAM smooths of SST against day-of-year."><img src="Figs/plot_time_serie.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MapMedSea_timeseries-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Seasonal cycle of average sea surface temperature (°C) for ten Mediterranean sub-regions. In each panel, semi-transparent points are daily SST average of the region and solid lines are GAM smooths of SST against day-of-year.
</figcaption>
</figure>
</div>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [17]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>df_date_extrem <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, year) <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_min_sst =</span> yday[<span class="fu">which.min</span>(SST)],</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_sst     =</span> <span class="fu">min</span>(SST),</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_max_sst =</span> yday[<span class="fu">which.max</span>(SST)],</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_sst     =</span> <span class="fu">max</span>(SST),</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups     =</span> <span class="st">"drop"</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>df_lm_extrem <span class="ot">&lt;-</span> df_date_extrem <span class="sc">%&gt;%</span> </span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(doy_min_sst <span class="sc">&lt;</span> <span class="dv">120</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span> </span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">doy_min =</span> <span class="fu">lm</span>(doy_min_sst <span class="sc">~</span> year)<span class="sc">$</span>coefficients[[<span class="dv">2</span>]],</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">doy_max =</span> <span class="fu">lm</span>(doy_max_sst <span class="sc">~</span> year)<span class="sc">$</span>coefficients[[<span class="dv">2</span>]])</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="co"># compute breaks every 15 days (1, 16, 31, … up to 361)</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>doy_breaks_15 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">366</span>, <span class="at">by =</span> <span class="dv">30</span>)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="co"># generate labels like “Jan 01”, “Jan 16”, …</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>doy_labels_15 <span class="ot">&lt;-</span>  lubridate<span class="sc">::</span><span class="fu">month</span>(<span class="fu">as.Date</span>(doy_breaks_15 <span class="sc">-</span> <span class="dv">1</span>, <span class="at">origin =</span> <span class="fu">as.Date</span>(<span class="st">"2001-01-01"</span>)), <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">locale =</span> <span class="st">"UTC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.character</span>()</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>min <span class="ot">&lt;-</span> df_date_extrem <span class="sc">%&gt;%</span> </span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> doy_min_sst, <span class="at">color =</span> region))<span class="sc">+</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">show.legend =</span> F)<span class="sc">+</span></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">show.legend =</span> F)<span class="sc">+</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_col)<span class="sc">+</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">120</span>) <span class="sc">+</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># labels</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">x        =</span> <span class="st">"Year"</span>,</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">y        =</span> <span class="st">"Day of the year the minimum SST"</span>,</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> doy_breaks_15,</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> doy_labels_15,</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">120</span>)) <span class="sc">+</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.background      =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"gray90"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text            =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a little breathing room below panels</span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot.margin           = margin(t = 5, r = 5, b = 30, l = 5),</span></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grid tweaks</span></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major      =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray85"</span>),</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor      =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for y is already present.
Adding another scale for y, which will replace the existing scale.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>max <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, year) <span class="sc">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_min_sst =</span> yday[<span class="fu">which.min</span>(SST)],</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_sst     =</span> <span class="fu">min</span>(SST),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_max_sst =</span> yday[<span class="fu">which.max</span>(SST)],</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_sst     =</span> <span class="fu">max</span>(SST),</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups     =</span> <span class="st">"drop"</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> doy_max_sst, <span class="at">color =</span> region))<span class="sc">+</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span> )<span class="sc">+</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_col)<span class="sc">+</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># labels</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x        =</span> <span class="st">"Year"</span>,</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y        =</span> <span class="st">"Day of the year the maximum SST"</span>,</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> doy_breaks_15,</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> doy_labels_15) <span class="sc">+</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.background      =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"gray90"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text            =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a little breathing room below panels</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot.margin           = margin(t = 5, r = 5, b = 30, l = 5),</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grid tweaks</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major      =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray85"</span>),</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor      =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>min_max <span class="ot">&lt;-</span> min <span class="sc">+</span> max <span class="sc">&amp;</span> <span class="fu">plot_layout</span>(<span class="at">guide =</span> <span class="st">"collect"</span>)<span class="sc">&amp;</span>     <span class="co"># collect all legends</span></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>,               <span class="co"># put legend at bottom</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>) </span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("Manuscript/Figs/plot_min_max_SST.png",min_max, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Dates on which SST minima and maxima occur remain generally consistent over the study period for most regions (<a href="#fig-Med_minmax" class="quarto-xref">Figure&nbsp;4</a>). However, shifts are observed in some areas: the winter temperature minimum in Levantine Sea occurs progressively earlier by 3.32 days per decade, while in Balearic Sea it occurs progressively later by 3.76 days per decade. Regarding the timing of maximum SST, two regions stand out: Adriatic sea and Aegean Sea both show an earlier occurrence of their annual temperature maxima by 2.41 and 1.58 days per decade, respectively.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [18]:</pre></div><div id="cell-fig-Med_minmax" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figs/plot_min_max_SST.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Med_minmax" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Med_minmax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="">
<a href="Figs/plot_min_max_SST.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;4: Trends in the timing of annual minimum (left panel) and maximum (right panel) Sea Surface Temperature (SST) across ten Mediterranean sub-regions from 1982 to 2024. Linear regression lines and 95% confidence intervals illustrate the shifts in timing (day of the year), highlighting regions with earlier or later occurrences of annual temperature extremes over the studied period."><img src="Figs/plot_min_max_SST.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Med_minmax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Trends in the timing of annual minimum (left panel) and maximum (right panel) Sea Surface Temperature (SST) across ten Mediterranean sub-regions from 1982 to 2024. Linear regression lines and 95% confidence intervals illustrate the shifts in timing (day of the year), highlighting regions with earlier or later occurrences of annual temperature extremes over the studied period.
</figcaption>
</figure>
</div>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [19]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(trend) </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(heatwaveR)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"../Outputs/SST/region_stats.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.character</span>(date) <span class="sc">%&gt;%</span> <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>),</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean =</span> mean <span class="sc">-</span> <span class="fl">273.15</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(date,<span class="at">region =</span> <span class="st">"name"</span>,<span class="at">SST =</span> <span class="st">"mean"</span>)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Your input df must have columns:</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   date   (Date), region (chr/fct), SST (numeric)</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1. Add year &amp; day-of-year ──────────────────────────────────────────────</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">yday =</span> <span class="fu">yday</span>(date)</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2. Build climatology baseline (exclude most recent year) ───────────────</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>baseline <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&lt;=</span> <span class="fu">max</span>(year) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3. Compute region-specific warm-season threshold ───────────────────────</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     here using the 75th percentile of baseline SST per region</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>region_thresh <span class="ot">&lt;-</span> baseline <span class="sc">%&gt;%</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">warm_thresh =</span> <span class="fu">quantile</span>(SST, <span class="at">probs =</span> <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 4. Join threshold back onto full data &amp; compute anomalies ──────────────</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>df3 <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(region_thresh, <span class="at">by =</span> <span class="st">"region"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, yday) <span class="sc">%&gt;%</span></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">clim_mean =</span> <span class="fu">mean</span>(SST[year <span class="sc">&lt;=</span> <span class="fu">max</span>(year)<span class="sc">-</span><span class="dv">1</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">anomaly   =</span> SST <span class="sc">-</span> clim_mean</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a><span class="co"># head(df3)</span></span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 5. Threshold-based dates using region-specific warm_thresh ────────────</span></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>threshold_metrics <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, year) <span class="sc">%&gt;%</span></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">warm_onset =</span> {</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>      r <span class="ot">&lt;-</span> SST <span class="sc">&gt;</span> warm_thresh</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>      dd <span class="ot">&lt;-</span> <span class="fu">rle</span>(r)</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>      ends  <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(dd<span class="sc">$</span>lengths)</span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>      starts<span class="ot">&lt;-</span> ends <span class="sc">-</span> dd<span class="sc">$</span>lengths <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>      idx   <span class="ot">&lt;-</span> <span class="fu">which</span>(dd<span class="sc">$</span>values <span class="sc">&amp;</span> dd<span class="sc">$</span>lengths <span class="sc">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(idx)) date[starts[idx[<span class="dv">1</span>]]] <span class="cf">else</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>)</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">warm_end =</span> {</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>      sel <span class="ot">&lt;-</span> <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">11</span></span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>      r   <span class="ot">&lt;-</span> sel <span class="sc">&amp;</span> (SST <span class="sc">&lt;</span> warm_thresh)</span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>      dd  <span class="ot">&lt;-</span> <span class="fu">rle</span>(r)</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>      ends  <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(dd<span class="sc">$</span>lengths)</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>      starts<span class="ot">&lt;-</span> ends <span class="sc">-</span> dd<span class="sc">$</span>lengths <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>      idx   <span class="ot">&lt;-</span> <span class="fu">which</span>(dd<span class="sc">$</span>values <span class="sc">&amp;</span> dd<span class="sc">$</span>lengths <span class="sc">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(idx)) date[starts[idx[<span class="dv">1</span>]]] <span class="cf">else</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>)</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>lm_df_warm <span class="ot">&lt;-</span> threshold_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">doy_onset =</span> <span class="fu">yday</span>(warm_onset),</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>         <span class="at">doy_offset =</span> <span class="fu">yday</span>(warm_end), </span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>         <span class="at">length =</span> doy_offset <span class="sc">-</span> doy_onset) <span class="sc">%&gt;%</span> </span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span> </span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">rate_onset =</span> <span class="fu">lm</span>(doy_onset <span class="sc">~</span> year)<span class="sc">$</span>coefficients[[<span class="dv">2</span>]],</span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a>          <span class="at">rate_end =</span> <span class="fu">lm</span>(doy_offset <span class="sc">~</span> year)<span class="sc">$</span>coefficients[[<span class="dv">2</span>]],</span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a>          <span class="at">rate_length =</span> <span class="fu">lm</span>(length <span class="sc">~</span> year)<span class="sc">$</span>coefficients[[<span class="dv">2</span>]])</span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a><span class="co"># compute breaks every 15 days (1, 16, 31, … up to 361)</span></span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>doy_breaks_15 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">366</span>, <span class="at">by =</span> <span class="dv">15</span>)</span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a><span class="co"># generate labels like “Jan 01”, “Jan 16”, …</span></span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a>doy_labels_15 <span class="ot">&lt;-</span> <span class="fu">format</span>(</span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.Date</span>(doy_breaks_15 <span class="sc">-</span> <span class="dv">1</span>, <span class="at">origin =</span> <span class="fu">as.Date</span>(<span class="st">"2001-01-01"</span>)),</span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>  <span class="st">"%b %d"</span></span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a>plot_doy_warm_start <span class="ot">&lt;-</span> threshold_metrics <span class="sc">%&gt;%</span></span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_onset  =</span> <span class="fu">yday</span>(warm_onset),</span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_offset =</span> <span class="fu">yday</span>(warm_end),</span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">duration =</span> doy_offset <span class="sc">-</span> doy_onset</span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>warm_onset, <span class="sc">-</span>warm_end) <span class="sc">%&gt;%</span></span>
<span id="cb54-106"><a href="#cb54-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(region, year), <span class="at">names_to =</span> <span class="st">"metric"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-107"><a href="#cb54-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">metric =</span> <span class="fu">factor</span>(metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"doy_onset"</span>,<span class="st">"doy_offset"</span>, <span class="st">"duration"</span>),</span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Warm Onset"</span>,<span class="st">"Warm End"</span>,<span class="st">"Duration"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb54-109"><a href="#cb54-109" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(metric <span class="sc">==</span> <span class="st">"Warm Onset"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-110"><a href="#cb54-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(year, value, <span class="at">color =</span> region)) <span class="sc">+</span></span>
<span id="cb54-111"><a href="#cb54-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-112"><a href="#cb54-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb54-113"><a href="#cb54-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"glm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb54-114"><a href="#cb54-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-115"><a href="#cb54-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> metric, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb54-116"><a href="#cb54-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-117"><a href="#cb54-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> doy_breaks_15,</span>
<span id="cb54-118"><a href="#cb54-118" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> doy_labels_15) <span class="sc">+</span></span>
<span id="cb54-119"><a href="#cb54-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-120"><a href="#cb54-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">"Region"</span>) <span class="sc">+</span></span>
<span id="cb54-121"><a href="#cb54-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-122"><a href="#cb54-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># here’s the magic for label/key positions</span></span>
<span id="cb54-123"><a href="#cb54-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb54-124"><a href="#cb54-124" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction      =</span> <span class="st">"vertical"</span>,</span>
<span id="cb54-125"><a href="#cb54-125" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.position =</span> <span class="st">"left"</span>,   <span class="co"># move text left of the key</span></span>
<span id="cb54-126"><a href="#cb54-126" aria-hidden="true" tabindex="-1"></a>      <span class="at">key.position   =</span> <span class="st">"right"</span>,  <span class="co"># move key to the right of the text</span></span>
<span id="cb54-127"><a href="#cb54-127" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust     =</span> <span class="dv">0</span>,       <span class="co"># left-align the text</span></span>
<span id="cb54-128"><a href="#cb54-128" aria-hidden="true" tabindex="-1"></a>      <span class="at">keywidth        =</span> <span class="fu">unit</span>(<span class="fl">1.2</span>, <span class="st">"lines"</span>)</span>
<span id="cb54-129"><a href="#cb54-129" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb54-130"><a href="#cb54-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-131"><a href="#cb54-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="st">"Day of Year"</span>) <span class="sc">+</span></span>
<span id="cb54-132"><a href="#cb54-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-133"><a href="#cb54-133" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_family =</span> <span class="st">"Helvetica"</span>) <span class="sc">+</span></span>
<span id="cb54-134"><a href="#cb54-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb54-135"><a href="#cb54-135" aria-hidden="true" tabindex="-1"></a>      <span class="co"># place the whole legend inside the plot:</span></span>
<span id="cb54-136"><a href="#cb54-136" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position      =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.98</span>),</span>
<span id="cb54-137"><a href="#cb54-137" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb54-138"><a href="#cb54-138" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-139"><a href="#cb54-139" aria-hidden="true" tabindex="-1"></a>      <span class="co"># semi-transparent background so it sits atop your points</span></span>
<span id="cb54-140"><a href="#cb54-140" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.background    =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"white"</span>, <span class="fl">0.6</span>), <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb54-141"><a href="#cb54-141" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-142"><a href="#cb54-142" aria-hidden="true" tabindex="-1"></a>      <span class="co"># strip out the old bottom legend settings:</span></span>
<span id="cb54-143"><a href="#cb54-143" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction     =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-144"><a href="#cb54-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key.size      =</span> <span class="fu">unit</span>(<span class="fl">0.8</span>, <span class="st">"lines"</span>),</span>
<span id="cb54-145"><a href="#cb54-145" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title         =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb54-146"><a href="#cb54-146" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text          =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb54-147"><a href="#cb54-147" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-148"><a href="#cb54-148" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb54-149"><a href="#cb54-149" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text            =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">"gray30"</span>),</span>
<span id="cb54-150"><a href="#cb54-150" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb54-151"><a href="#cb54-151" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major     =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb54-152"><a href="#cb54-152" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor     =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb54-153"><a href="#cb54-153" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>,<span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb54-154"><a href="#cb54-154" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-155"><a href="#cb54-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-156"><a href="#cb54-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-157"><a href="#cb54-157" aria-hidden="true" tabindex="-1"></a>plot_doy_warm_end <span class="ot">&lt;-</span> threshold_metrics <span class="sc">%&gt;%</span></span>
<span id="cb54-158"><a href="#cb54-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb54-159"><a href="#cb54-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_onset  =</span> <span class="fu">yday</span>(warm_onset),</span>
<span id="cb54-160"><a href="#cb54-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_offset =</span> <span class="fu">yday</span>(warm_end),</span>
<span id="cb54-161"><a href="#cb54-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">duration =</span> doy_offset <span class="sc">-</span> doy_onset</span>
<span id="cb54-162"><a href="#cb54-162" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb54-163"><a href="#cb54-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>warm_onset, <span class="sc">-</span>warm_end) <span class="sc">%&gt;%</span></span>
<span id="cb54-164"><a href="#cb54-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(region, year), <span class="at">names_to =</span> <span class="st">"metric"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-165"><a href="#cb54-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">metric =</span> <span class="fu">factor</span>(metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"doy_onset"</span>,<span class="st">"doy_offset"</span>, <span class="st">"duration"</span>),</span>
<span id="cb54-166"><a href="#cb54-166" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Warm Onset"</span>,<span class="st">"Warm End"</span>,<span class="st">"Duration"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb54-167"><a href="#cb54-167" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(metric <span class="sc">==</span> <span class="st">"Warm End"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-168"><a href="#cb54-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(year, value, <span class="at">color =</span> region)) <span class="sc">+</span></span>
<span id="cb54-169"><a href="#cb54-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-170"><a href="#cb54-170" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb54-171"><a href="#cb54-171" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"glm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">show.legend =</span> F, <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb54-172"><a href="#cb54-172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-173"><a href="#cb54-173" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> metric, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb54-174"><a href="#cb54-174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-175"><a href="#cb54-175" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> doy_breaks_15,</span>
<span id="cb54-176"><a href="#cb54-176" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> doy_labels_15) <span class="sc">+</span></span>
<span id="cb54-177"><a href="#cb54-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-178"><a href="#cb54-178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">"Region"</span>) <span class="sc">+</span></span>
<span id="cb54-179"><a href="#cb54-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-180"><a href="#cb54-180" aria-hidden="true" tabindex="-1"></a>    <span class="co"># here’s the magic for label/key positions</span></span>
<span id="cb54-181"><a href="#cb54-181" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb54-182"><a href="#cb54-182" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction      =</span> <span class="st">"vertical"</span>,</span>
<span id="cb54-183"><a href="#cb54-183" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.position =</span> <span class="st">"left"</span>,   <span class="co"># move text left of the key</span></span>
<span id="cb54-184"><a href="#cb54-184" aria-hidden="true" tabindex="-1"></a>      <span class="at">key.position   =</span> <span class="st">"right"</span>,  <span class="co"># move key to the right of the text</span></span>
<span id="cb54-185"><a href="#cb54-185" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust     =</span> <span class="dv">0</span>,       <span class="co"># left-align the text</span></span>
<span id="cb54-186"><a href="#cb54-186" aria-hidden="true" tabindex="-1"></a>      <span class="at">keywidth        =</span> <span class="fu">unit</span>(<span class="fl">1.2</span>, <span class="st">"lines"</span>)</span>
<span id="cb54-187"><a href="#cb54-187" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb54-188"><a href="#cb54-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-189"><a href="#cb54-189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="st">"Day of Year"</span>) <span class="sc">+</span></span>
<span id="cb54-190"><a href="#cb54-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-191"><a href="#cb54-191" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_family =</span> <span class="st">"Helvetica"</span>) <span class="sc">+</span></span>
<span id="cb54-192"><a href="#cb54-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb54-193"><a href="#cb54-193" aria-hidden="true" tabindex="-1"></a>      <span class="co"># place the whole legend inside the plot:</span></span>
<span id="cb54-194"><a href="#cb54-194" aria-hidden="true" tabindex="-1"></a>      <span class="co"># legend.position      = c(0.3, 0.98),</span></span>
<span id="cb54-195"><a href="#cb54-195" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb54-196"><a href="#cb54-196" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-197"><a href="#cb54-197" aria-hidden="true" tabindex="-1"></a>      <span class="co"># semi-transparent background so it sits atop your points</span></span>
<span id="cb54-198"><a href="#cb54-198" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.background    =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"white"</span>, <span class="fl">0.6</span>), <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb54-199"><a href="#cb54-199" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-200"><a href="#cb54-200" aria-hidden="true" tabindex="-1"></a>      <span class="co"># strip out the old bottom legend settings:</span></span>
<span id="cb54-201"><a href="#cb54-201" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction     =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-202"><a href="#cb54-202" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key.size      =</span> <span class="fu">unit</span>(<span class="fl">0.8</span>, <span class="st">"lines"</span>),</span>
<span id="cb54-203"><a href="#cb54-203" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title         =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb54-204"><a href="#cb54-204" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text          =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb54-205"><a href="#cb54-205" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-206"><a href="#cb54-206" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb54-207"><a href="#cb54-207" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text            =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">"gray30"</span>),</span>
<span id="cb54-208"><a href="#cb54-208" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb54-209"><a href="#cb54-209" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major     =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb54-210"><a href="#cb54-210" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor     =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb54-211"><a href="#cb54-211" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>,<span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb54-212"><a href="#cb54-212" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-213"><a href="#cb54-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-214"><a href="#cb54-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-215"><a href="#cb54-215" aria-hidden="true" tabindex="-1"></a>plot_doy_warm_duration <span class="ot">&lt;-</span> threshold_metrics <span class="sc">%&gt;%</span></span>
<span id="cb54-216"><a href="#cb54-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb54-217"><a href="#cb54-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_onset  =</span> <span class="fu">yday</span>(warm_onset),</span>
<span id="cb54-218"><a href="#cb54-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_offset =</span> <span class="fu">yday</span>(warm_end),</span>
<span id="cb54-219"><a href="#cb54-219" aria-hidden="true" tabindex="-1"></a>    <span class="at">duration =</span> doy_offset <span class="sc">-</span> doy_onset</span>
<span id="cb54-220"><a href="#cb54-220" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb54-221"><a href="#cb54-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>warm_onset, <span class="sc">-</span>warm_end) <span class="sc">%&gt;%</span></span>
<span id="cb54-222"><a href="#cb54-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(region, year), <span class="at">names_to =</span> <span class="st">"metric"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-223"><a href="#cb54-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">metric =</span> <span class="fu">factor</span>(metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"doy_onset"</span>,<span class="st">"doy_offset"</span>, <span class="st">"duration"</span>),</span>
<span id="cb54-224"><a href="#cb54-224" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Warm Onset"</span>,<span class="st">"Warm End"</span>,<span class="st">"Duration of warm period"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb54-225"><a href="#cb54-225" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(metric <span class="sc">==</span> <span class="st">"Duration of warm period"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-226"><a href="#cb54-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(year, value, <span class="at">color =</span> region)) <span class="sc">+</span></span>
<span id="cb54-227"><a href="#cb54-227" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-228"><a href="#cb54-228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb54-229"><a href="#cb54-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"glm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">show.legend =</span> F, <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb54-230"><a href="#cb54-230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-231"><a href="#cb54-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> metric, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb54-232"><a href="#cb54-232" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-233"><a href="#cb54-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">"Region"</span>) <span class="sc">+</span></span>
<span id="cb54-234"><a href="#cb54-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-235"><a href="#cb54-235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># here’s the magic for label/key positions</span></span>
<span id="cb54-236"><a href="#cb54-236" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb54-237"><a href="#cb54-237" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction      =</span> <span class="st">"vertical"</span>,</span>
<span id="cb54-238"><a href="#cb54-238" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.position =</span> <span class="st">"left"</span>,   <span class="co"># move text left of the key</span></span>
<span id="cb54-239"><a href="#cb54-239" aria-hidden="true" tabindex="-1"></a>      <span class="at">key.position   =</span> <span class="st">"right"</span>,  <span class="co"># move key to the right of the text</span></span>
<span id="cb54-240"><a href="#cb54-240" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust     =</span> <span class="dv">0</span>,       <span class="co"># left-align the text</span></span>
<span id="cb54-241"><a href="#cb54-241" aria-hidden="true" tabindex="-1"></a>      <span class="at">keywidth        =</span> <span class="fu">unit</span>(<span class="fl">1.2</span>, <span class="st">"lines"</span>)</span>
<span id="cb54-242"><a href="#cb54-242" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb54-243"><a href="#cb54-243" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-244"><a href="#cb54-244" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="st">"Number of Days"</span>) <span class="sc">+</span></span>
<span id="cb54-245"><a href="#cb54-245" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-246"><a href="#cb54-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_family =</span> <span class="st">"Helvetica"</span>) <span class="sc">+</span></span>
<span id="cb54-247"><a href="#cb54-247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb54-248"><a href="#cb54-248" aria-hidden="true" tabindex="-1"></a>      <span class="co"># place the whole legend inside the plot:</span></span>
<span id="cb54-249"><a href="#cb54-249" aria-hidden="true" tabindex="-1"></a>      <span class="co"># legend.position      = c(0.3, 0.98),</span></span>
<span id="cb54-250"><a href="#cb54-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb54-251"><a href="#cb54-251" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-252"><a href="#cb54-252" aria-hidden="true" tabindex="-1"></a>      <span class="co"># semi-transparent background so it sits atop your points</span></span>
<span id="cb54-253"><a href="#cb54-253" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.background    =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"white"</span>, <span class="fl">0.6</span>), <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb54-254"><a href="#cb54-254" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-255"><a href="#cb54-255" aria-hidden="true" tabindex="-1"></a>      <span class="co"># strip out the old bottom legend settings:</span></span>
<span id="cb54-256"><a href="#cb54-256" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction     =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-257"><a href="#cb54-257" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key.size      =</span> <span class="fu">unit</span>(<span class="fl">0.8</span>, <span class="st">"lines"</span>),</span>
<span id="cb54-258"><a href="#cb54-258" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title         =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb54-259"><a href="#cb54-259" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text          =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb54-260"><a href="#cb54-260" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb54-261"><a href="#cb54-261" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb54-262"><a href="#cb54-262" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text            =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">"gray30"</span>),</span>
<span id="cb54-263"><a href="#cb54-263" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb54-264"><a href="#cb54-264" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major     =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb54-265"><a href="#cb54-265" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor     =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb54-266"><a href="#cb54-266" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>,<span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb54-267"><a href="#cb54-267" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-268"><a href="#cb54-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-269"><a href="#cb54-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-270"><a href="#cb54-270" aria-hidden="true" tabindex="-1"></a>plot_doy_warm_merged <span class="ot">&lt;-</span> (plot_doy_warm_start <span class="sc">+</span> plot_doy_warm_end) <span class="sc">+</span> plot_doy_warm_duration</span>
<span id="cb54-271"><a href="#cb54-271" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("Manuscript/Figs/plot_warm_season.png",plot_doy_warm_merged, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p><a href="#fig-Med_warm_metrics" class="quarto-xref">Figure&nbsp;5</a> (left) shows the start date of the warm season in all subregions of the Mediterranean Sea. The warm season begins when the daily SST exceeds the 75th percentile (p75) of the subregion’s SST for five consecutive days. A downward trend is evident across all subregions, indicating that the warm season now starts on average 5.66 days earlier per decade. The Levantine Sea shows the greatest advancement in onset, at 8.23 days per decade.</p>
<p>Regarding the end of the warm season, a consistent delay is observed across all subregions, with the season ending on average 3.69 days later per decade (<a href="#fig-Med_warm_metrics" class="quarto-xref">Figure&nbsp;5</a> middle). Two regions stand out—Levantine Sea and Aegean Sea— showing shifts of 7.01 and 5.33 days per decade, respectively.</p>
<p><a href="#fig-Med_warm_metrics" class="quarto-xref">Figure&nbsp;5</a> (right) shows the length of the warm season, defined as the interval between its end and start dates. Across the Mediterranean basin, the warm season is lengthening by 9.35 days per decade on average. All subregions exhibit this trend, except for Levantine Sea and Aegean Sea, which show increases of 15.24 and 11.48 days per decade, respectively.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [20]:</pre></div><div id="cell-fig-Med_warm_metrics" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figs/plot_warm_season.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Med_warm_metrics" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Med_warm_metrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="">
<a href="Figs/plot_warm_season.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5: Trends in the timing and duration of the warm season across ten Mediterranean sub-regions. Left panel (“Warm Onset”) shows the day of year when SST exceeds the p75 of temperature for more than 5 concecutive days, each year; central panel (“Warm End”) shows the day of year when SST falls bellow the p75 for more than 5 concecutive days; right panel (Duration of warm period) shows the amount of days between the start and the end of the warm season. Semi-transparent points are the annual onset/end dates for each region, and colored lines are per-region linear fits with 95% confidence bands. Downward slopes on the left indicate progressively earlier warm‐season starts, while upward slopes on the right indicate progressively later warm‐season terminations."><img src="Figs/plot_warm_season.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Med_warm_metrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Trends in the timing and duration of the warm season across ten Mediterranean sub-regions. Left panel (“Warm Onset”) shows the day of year when SST exceeds the p75 of temperature for more than 5 concecutive days, each year; central panel (“Warm End”) shows the day of year when SST falls bellow the p75 for more than 5 concecutive days; right panel (Duration of warm period) shows the amount of days between the start and the end of the warm season. Semi-transparent points are the annual onset/end dates for each region, and colored lines are per-region linear fits with 95% confidence bands. Downward slopes on the left indicate progressively earlier warm‐season starts, while upward slopes on the right indicate progressively later warm‐season terminations.
</figcaption>
</figure>
</div>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [21]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(trend) </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(heatwaveR)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 8. Seasonal-cycle stats ────────────────────────────────────────────────</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>seasonal_metrics <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, year) <span class="sc">%&gt;%</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_max     =</span> date[<span class="fu">which.max</span>(SST)],</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_min     =</span> date[<span class="fu">which.min</span>(SST)],</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">amplitude    =</span> <span class="fu">max</span>(SST) <span class="sc">-</span> <span class="fu">min</span>(SST),</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">warming_rate =</span> {</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>      sel <span class="ot">&lt;-</span> <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">sum</span>(sel) <span class="sc">&gt;</span> <span class="dv">2</span>) <span class="fu">coef</span>(<span class="fu">lm</span>(SST[sel] <span class="sc">~</span> yday[sel]))[<span class="dv">2</span>] <span class="cf">else</span> <span class="cn">NA</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">cooling_rate =</span> {</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>      sel <span class="ot">&lt;-</span> <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">11</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">sum</span>(sel) <span class="sc">&gt;</span> <span class="dv">2</span>) <span class="fu">coef</span>(<span class="fu">lm</span>(SST[sel] <span class="sc">~</span> yday[sel]))[<span class="dv">2</span>] <span class="cf">else</span> <span class="cn">NA</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>lm_df_amp <span class="ot">&lt;-</span> seasonal_metrics  <span class="sc">%&gt;%</span> </span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span> </span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">rate_amplitude =</span> <span class="fu">lm</span>(amplitude <span class="sc">~</span> year)<span class="sc">$</span>coefficients[[<span class="dv">2</span>]])</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>df_amp <span class="ot">&lt;-</span> seasonal_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span> </span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">mean =</span> <span class="fu">mean</span>(amplitude, <span class="at">na.rm =</span> T))</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>plot_amplitude <span class="ot">&lt;-</span> seasonal_meanplot_amplitude <span class="ot">&lt;-</span> seasonal_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> amplitude, <span class="at">color =</span> region))<span class="sc">+</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>)<span class="sc">+</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>,<span class="at">se =</span> T, <span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">"Region"</span>)<span class="sc">+</span></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="st">"Thermal amplitude (°C)"</span>) <span class="sc">+</span></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_family =</span> <span class="st">"Helvetica"</span>) <span class="sc">+</span></span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>      <span class="co"># place the whole legend inside the plot:</span></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>      <span class="co"># legend.position      = c(0.3, 0.98),</span></span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>      <span class="co"># semi-transparent background so it sits atop your points</span></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.background    =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"white"</span>, <span class="fl">0.6</span>), <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>      <span class="co"># strip out the old bottom legend settings:</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction     =</span> <span class="cn">NULL</span>,</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key.size      =</span> <span class="fu">unit</span>(<span class="fl">0.8</span>, <span class="st">"lines"</span>),</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title         =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text          =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text            =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">"gray30"</span>),</span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major     =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor     =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>,<span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("Manuscript/Figs/plot_amplitude.png",plot_amplitude, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>The thermic amplitude is defined as the difference between the minimum winter SST and the maximum summer SST. The subregion with the smallest thermal amplitude is Alboran Sea, averaging just 10.82°C between summer peaks and winter troughs. By contrast, Adriatic sea exhibits the largest thermal amplitude in the Mediterranean Sea, at 14.94. Across the entire basin, there is an increasing trend in thermic amplitude, averaging 0.17°C per decade. The region with the most pronounced rise is Adriatic sea where amplitude grows by 0.32°C each decade. This divergence stems from summer temperatures rising about 38 % faster than winter temperatures across the basin.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [22]:</pre></div><div id="cell-fig-Med_amplitude" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figs/plot_amplitude.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Med_amplitude" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Med_amplitude-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="">
<a href="Figs/plot_amplitude.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;6: Trends in the timing and duration of the warm season across ten Mediterranean sub-regions. Left panel (“Warm Onset”) shows the day of year when SST exceeds the p75 of temperature for more than 5 concecutive days, each year; central panel (“Warm End”) shows the day of year when SST falls bellow the p75 for more than 5 concecutive days; right panel (Duration of warm period) shows the amount of days between the start and the end of the warm season. Semi-transparent points are the annual onset/end dates for each region, and colored lines are per-region linear fits with 95% confidence bands. Downward slopes on the left indicate progressively earlier warm‐season starts, while upward slopes on the right indicate progressively later warm‐season terminations."><img src="Figs/plot_amplitude.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Med_amplitude-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Trends in the timing and duration of the warm season across ten Mediterranean sub-regions. Left panel (“Warm Onset”) shows the day of year when SST exceeds the p75 of temperature for more than 5 concecutive days, each year; central panel (“Warm End”) shows the day of year when SST falls bellow the p75 for more than 5 concecutive days; right panel (Duration of warm period) shows the amount of days between the start and the end of the warm season. Semi-transparent points are the annual onset/end dates for each region, and colored lines are per-region linear fits with 95% confidence bands. Downward slopes on the left indicate progressively earlier warm‐season starts, while upward slopes on the right indicate progressively later warm‐season terminations.
</figcaption>
</figure>
</div>
</div>
</div></div>
</section>
<section id="heatwaves-by-regions" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="heatwaves-by-regions"><span class="header-section-number">3.2</span> Heatwaves by regions</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [23]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(heatwaveR)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>df_timeserie <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"../Outputs/SST/region_stats.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.character</span>(date) <span class="sc">%&gt;%</span> <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>),</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">mean =</span> mean <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">median =</span> median <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">p10 =</span> p10 <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">p25 =</span> p25 <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">p75 =</span> p75 <span class="sc">-</span> <span class="fl">273.15</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">p90 =</span> p90 <span class="sc">-</span> <span class="fl">273.15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">doy =</span> <span class="fu">yday</span>(date),</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">year</span>(date))</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>df_timeserie <span class="sc">%&gt;%</span> </span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(name <span class="sc">==</span> <span class="st">"Adriatic sea"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ts2clm</span>(date,mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="heatwaves-pixel-per-pixels" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="heatwaves-pixel-per-pixels"><span class="header-section-number">3.3</span> Heatwaves Pixel per Pixels</h2>
<section id="number-of-event-per-year" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="number-of-event-per-year"><span class="header-section-number">3.3.1</span> Number of Event per year</h3>
<div class="cell-container"><div class="cell-decorator"><pre>In [24]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridisLite)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Utilities.Package)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>region_col <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># greens</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Levantine Sea"</span> <span class="ot">=</span> <span class="st">"#008F1A"</span>,   <span class="co"># brighter pine-green</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sea of Sicily"</span> <span class="ot">=</span> <span class="st">"#6B9C3C"</span>,   <span class="co"># vivid olive-sage</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># blues / teals / purples</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Alboran Sea"</span>   <span class="ot">=</span> <span class="st">"#414E7C"</span>,   <span class="co"># richer slate-blue</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Gulf of Lyon"</span>  <span class="ot">=</span> <span class="st">"#266A78"</span>,   <span class="co"># clearer Mediterranean teal</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Adriatic sea"</span>  <span class="ot">=</span> <span class="st">"#583C68"</span>,   <span class="co"># deeper indigo-violet</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yellows / ochres</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Balearic Sea"</span>  <span class="ot">=</span> <span class="st">"#A98C3D"</span>,   <span class="co"># crisp mustard-ochre</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Aegean Sea"</span>    <span class="ot">=</span> <span class="st">"#D7A543"</span>,   <span class="co"># sun-baked golden-ochre</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reds / oranges / browns</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tyrrhenian Sea"</span><span class="ot">=</span> <span class="st">"#A02A2A"</span>,   <span class="co"># vivid brick-red</span></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Algerian Sea"</span>  <span class="ot">=</span> <span class="st">"#DF5513"</span>,   <span class="co"># bright burnt-orange</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ionian Sea"</span>    <span class="ot">=</span> <span class="st">"#705943"</span>    <span class="co"># warmer earthy-taupe</span></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your shapefile (replace with your path)</span></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"Black"</span>))</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Get world land polygons</span></span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>filelist <span class="ot">&lt;-</span> <span class="st">"Outputs/SST/nc/n_event_per_year"</span> <span class="sc">%&gt;%</span> </span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(<span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">substr</span>(file,<span class="dv">9</span>,<span class="dv">12</span>))</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>stk <span class="ot">&lt;-</span> filelist<span class="sc">$</span>path <span class="sc">%&gt;%</span> </span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>()</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(stk) <span class="ot">&lt;-</span> filelist<span class="sc">$</span>year</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>stk_avg <span class="ot">&lt;-</span> <span class="fu">mean</span>(stk, <span class="at">na.rm =</span> T)</span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>map_n_event <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── data layers ─────────────────────────────────────────────</span></span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>  tidyterra<span class="sc">::</span><span class="fu">geom_spatraster</span>(<span class="at">data =</span> stk_avg,</span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">aes</span>(<span class="at">fill =</span> mean)) <span class="sc">+</span> </span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── colour scales ───────────────────────────────────────────</span></span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours  =</span> <span class="fu">turbo</span>(<span class="dv">10</span>),</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">name     =</span> <span class="st">"Avg number of Event per Year"</span></span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── horizontal guide with title on top ──────────────────────</span></span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.position =</span> <span class="st">"bottom"</span>,            <span class="co"># optional – labels below bar</span></span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="dv">5</span>, <span class="st">"cm"</span>),       <span class="co"># tweak length</span></span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.45</span>, <span class="st">"cm"</span>)     <span class="co"># tweak thickness</span></span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── map extent ──────────────────────────────────────────────</span></span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">40</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">47</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── *** scale bar *** ───────────────────────────────────────</span></span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotation_scale</span>(</span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">location   =</span> <span class="st">"bl"</span>,   <span class="co"># bottom-left</span></span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">width_hint =</span> <span class="fl">0.25</span>,   <span class="co"># ≈25 % of the map width</span></span>
<span id="cb59-80"><a href="#cb59-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">line_width =</span> <span class="fl">0.6</span>,</span>
<span id="cb59-81"><a href="#cb59-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">text_cex   =</span> <span class="dv">2</span>,</span>
<span id="cb59-82"><a href="#cb59-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad_x      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb59-83"><a href="#cb59-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad_y      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb59-84"><a href="#cb59-84" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-85"><a href="#cb59-85" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── theme ───────────────────────────────────────────────────</span></span>
<span id="cb59-86"><a href="#cb59-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb59-87"><a href="#cb59-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb59-88"><a href="#cb59-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid        =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb59-89"><a href="#cb59-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background  =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>),</span>
<span id="cb59-90"><a href="#cb59-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb59-91"><a href="#cb59-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-92"><a href="#cb59-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># move legend INSIDE, upper-left; anchor by its top-left corner</span></span>
<span id="cb59-93"><a href="#cb59-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),   <span class="co"># npc coords (x = 2 %, y = 98 %)</span></span>
<span id="cb59-94"><a href="#cb59-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb59-95"><a href="#cb59-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb59-96"><a href="#cb59-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-97"><a href="#cb59-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title.align    =</span> <span class="fl">0.5</span>,             <span class="co"># centre title</span></span>
<span id="cb59-98"><a href="#cb59-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb59-99"><a href="#cb59-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-100"><a href="#cb59-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># give legend a white background &amp; a bit of padding</span></span>
<span id="cb59-101"><a href="#cb59-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>,<span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb59-102"><a href="#cb59-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb59-103"><a href="#cb59-103" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-104"><a href="#cb59-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-105"><a href="#cb59-105" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/Map_MedSea_n_event.png"</span>, map_n_event, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb59-106"><a href="#cb59-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-107"><a href="#cb59-107" aria-hidden="true" tabindex="-1"></a><span class="do">############ Line plot by region</span></span>
<span id="cb59-108"><a href="#cb59-108" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(med_regions, <span class="fu">crs</span>(stk))</span>
<span id="cb59-109"><a href="#cb59-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-110"><a href="#cb59-110" aria-hidden="true" tabindex="-1"></a><span class="co"># med_regions &lt;- st_zm(med_regions)</span></span>
<span id="cb59-111"><a href="#cb59-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-112"><a href="#cb59-112" aria-hidden="true" tabindex="-1"></a>zone_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(med_regions, stk[[<span class="dv">1</span>]], <span class="at">field =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(med_regions))</span>
<span id="cb59-113"><a href="#cb59-113" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(zone_rast, <span class="st">"Data/mask_Med_Sea/region_of_the_med.tif"</span>)</span>
<span id="cb59-114"><a href="#cb59-114" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(zone_rast)</span>
<span id="cb59-115"><a href="#cb59-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that terra::zonal will apply: returns a 3-element vector</span></span>
<span id="cb59-116"><a href="#cb59-116" aria-hidden="true" tabindex="-1"></a>qfun <span class="ot">&lt;-</span> <span class="cf">function</span>(values, ...) {</span>
<span id="cb59-117"><a href="#cb59-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(values, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb59-118"><a href="#cb59-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-119"><a href="#cb59-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-120"><a href="#cb59-120" aria-hidden="true" tabindex="-1"></a><span class="co"># zonal() summarises **all layers at once**</span></span>
<span id="cb59-121"><a href="#cb59-121" aria-hidden="true" tabindex="-1"></a>z_raw <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(stk, zone_rast, <span class="at">fun =</span> qfun)</span>
<span id="cb59-122"><a href="#cb59-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-123"><a href="#cb59-123" aria-hidden="true" tabindex="-1"></a>z_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(z_raw)  <span class="sc">%&gt;%</span> </span>
<span id="cb59-124"><a href="#cb59-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">region =</span> med_regions<span class="sc">$</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb59-125"><a href="#cb59-125" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>layer) <span class="sc">%&gt;%</span> <span class="co"># attach names</span></span>
<span id="cb59-126"><a href="#cb59-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="sc">-</span>region),</span>
<span id="cb59-127"><a href="#cb59-127" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to   =</span> <span class="st">"year"</span>,</span>
<span id="cb59-128"><a href="#cb59-128" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"mean"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-129"><a href="#cb59-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year))</span>
<span id="cb59-130"><a href="#cb59-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-131"><a href="#cb59-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-132"><a href="#cb59-132" aria-hidden="true" tabindex="-1"></a>plot_lines <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(z_df, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> mean, <span class="at">colour =</span> region)) <span class="sc">+</span></span>
<span id="cb59-133"><a href="#cb59-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb59-134"><a href="#cb59-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb59-135"><a href="#cb59-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> region_col) <span class="sc">+</span></span>
<span id="cb59-136"><a href="#cb59-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-137"><a href="#cb59-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb59-138"><a href="#cb59-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">method    =</span> <span class="st">"gam"</span>,</span>
<span id="cb59-139"><a href="#cb59-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">1.2</span>,</span>
<span id="cb59-140"><a href="#cb59-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha     =</span> <span class="fl">0.05</span>,</span>
<span id="cb59-141"><a href="#cb59-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula     =</span> (y) <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">3</span>),  <span class="co"># &lt;-- k goes here</span></span>
<span id="cb59-142"><a href="#cb59-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb59-143"><a href="#cb59-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-144"><a href="#cb59-144" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── 1. force a ONE-column legend ────────────────────────────</span></span>
<span id="cb59-145"><a href="#cb59-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb59-146"><a href="#cb59-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">ncol =</span> <span class="dv">1</span>)   <span class="co"># 1 column, items stacked</span></span>
<span id="cb59-147"><a href="#cb59-147" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-148"><a href="#cb59-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">11.25</span>))<span class="sc">+</span></span>
<span id="cb59-149"><a href="#cb59-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-150"><a href="#cb59-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour =</span> <span class="st">"Regions"</span>, <span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="st">"Average number of HW event"</span>) <span class="sc">+</span></span>
<span id="cb59-151"><a href="#cb59-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-152"><a href="#cb59-152" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── 2. theme tweaks to pin legend inside, top-left ──────────</span></span>
<span id="cb59-153"><a href="#cb59-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb59-154"><a href="#cb59-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb59-155"><a href="#cb59-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb59-156"><a href="#cb59-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text       =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb59-157"><a href="#cb59-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-158"><a href="#cb59-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),   <span class="co"># (x, y) in npc units</span></span>
<span id="cb59-159"><a href="#cb59-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),         <span class="co"># anchor by its top-left corner</span></span>
<span id="cb59-160"><a href="#cb59-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"vertical"</span>,      <span class="co"># keeps items vertical</span></span>
<span id="cb59-161"><a href="#cb59-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb59-162"><a href="#cb59-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb59-163"><a href="#cb59-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-164"><a href="#cb59-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width      =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>)    <span class="co"># leave if you want wider keys</span></span>
<span id="cb59-165"><a href="#cb59-165" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-166"><a href="#cb59-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-167"><a href="#cb59-167" aria-hidden="true" tabindex="-1"></a>plot_lines</span>
<span id="cb59-168"><a href="#cb59-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-169"><a href="#cb59-169" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/line_n_event.png"</span>, plot_lines, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb59-170"><a href="#cb59-170" aria-hidden="true" tabindex="-1"></a><span class="do">###################### MAP of TREND</span></span>
<span id="cb59-171"><a href="#cb59-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-172"><a href="#cb59-172" aria-hidden="true" tabindex="-1"></a>df_map_freq_long <span class="ot">&lt;-</span> stk <span class="sc">%&gt;%</span></span>
<span id="cb59-173"><a href="#cb59-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb59-174"><a href="#cb59-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb59-175"><a href="#cb59-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(ID,x,y), <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"year"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-176"><a href="#cb59-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(value) <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb59-177"><a href="#cb59-177" aria-hidden="true" tabindex="-1"></a>                           T <span class="sc">~</span> value)) <span class="sc">%&gt;%</span> </span>
<span id="cb59-178"><a href="#cb59-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year)) <span class="sc">%&gt;%</span> </span>
<span id="cb59-179"><a href="#cb59-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb59-180"><a href="#cb59-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">trend =</span> <span class="fu">coef</span>(<span class="fu">lm</span>(value <span class="sc">~</span> year))[<span class="dv">2</span>])</span>
<span id="cb59-181"><a href="#cb59-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-182"><a href="#cb59-182" aria-hidden="true" tabindex="-1"></a>df_freq <span class="ot">&lt;-</span> stk <span class="sc">%&gt;%</span></span>
<span id="cb59-183"><a href="#cb59-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span>  </span>
<span id="cb59-184"><a href="#cb59-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb59-185"><a href="#cb59-185" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(x,y,ID))</span>
<span id="cb59-186"><a href="#cb59-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-187"><a href="#cb59-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-188"><a href="#cb59-188" aria-hidden="true" tabindex="-1"></a>df_trend <span class="ot">&lt;-</span> df_map_freq_long <span class="sc">%&gt;%</span> </span>
<span id="cb59-189"><a href="#cb59-189" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr::filter(trend &lt; quantile(trend, probs = 0.95)) %&gt;% </span></span>
<span id="cb59-190"><a href="#cb59-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_freq, <span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-191"><a href="#cb59-191" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>ID) <span class="sc">%&gt;%</span> </span>
<span id="cb59-192"><a href="#cb59-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(x,y,trend)</span>
<span id="cb59-193"><a href="#cb59-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-194"><a href="#cb59-194" aria-hidden="true" tabindex="-1"></a>rast_trend <span class="ot">&lt;-</span> stk<span class="sc">$</span><span class="st">`</span><span class="at">1982</span><span class="st">`</span></span>
<span id="cb59-195"><a href="#cb59-195" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(rast_trend) <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb59-196"><a href="#cb59-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-197"><a href="#cb59-197" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">vect</span>(df_trend, <span class="at">geom =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="fu">crs</span>(rast_trend))</span>
<span id="cb59-198"><a href="#cb59-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-199"><a href="#cb59-199" aria-hidden="true" tabindex="-1"></a>rast_trend <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(</span>
<span id="cb59-200"><a href="#cb59-200" aria-hidden="true" tabindex="-1"></a>  pts,             <span class="co"># what to burn</span></span>
<span id="cb59-201"><a href="#cb59-201" aria-hidden="true" tabindex="-1"></a>  rast_trend,         <span class="co"># target raster geometry</span></span>
<span id="cb59-202"><a href="#cb59-202" aria-hidden="true" tabindex="-1"></a>  <span class="at">field =</span> <span class="st">"trend"</span>, <span class="co"># column to transfer</span></span>
<span id="cb59-203"><a href="#cb59-203" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun   =</span> <span class="st">"mean"</span>   <span class="co"># how to handle duplicate points (mean, max, sum, …)</span></span>
<span id="cb59-204"><a href="#cb59-204" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-205"><a href="#cb59-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-206"><a href="#cb59-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that terra::zonal will apply: returns a 3-element vector</span></span>
<span id="cb59-207"><a href="#cb59-207" aria-hidden="true" tabindex="-1"></a>qfun <span class="ot">&lt;-</span> <span class="cf">function</span>(values, ...) {</span>
<span id="cb59-208"><a href="#cb59-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(values, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb59-209"><a href="#cb59-209" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-210"><a href="#cb59-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-211"><a href="#cb59-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-212"><a href="#cb59-212" aria-hidden="true" tabindex="-1"></a><span class="co"># zonal() summarises **all layers at once**</span></span>
<span id="cb59-213"><a href="#cb59-213" aria-hidden="true" tabindex="-1"></a>z_raw_trend <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(rast_trend, zone_rast, <span class="at">fun =</span> qfun)</span>
<span id="cb59-214"><a href="#cb59-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-215"><a href="#cb59-215" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.  Add centroid geometry and its coordinates to `med_regions`</span></span>
<span id="cb59-216"><a href="#cb59-216" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> med_regions <span class="sc">%&gt;%</span>                                 <span class="co"># already an sf multipolygon</span></span>
<span id="cb59-217"><a href="#cb59-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">centroid =</span> <span class="fu">st_centroid</span>(geometry),                     <span class="co"># geometry column is usually called `geometry`</span></span>
<span id="cb59-218"><a href="#cb59-218" aria-hidden="true" tabindex="-1"></a>         <span class="at">lon      =</span> <span class="fu">st_coordinates</span>(centroid)[, <span class="dv">1</span>],             <span class="co"># X</span></span>
<span id="cb59-219"><a href="#cb59-219" aria-hidden="true" tabindex="-1"></a>         <span class="at">lat      =</span> <span class="fu">st_coordinates</span>(centroid)[, <span class="dv">2</span>])             <span class="co"># Y</span></span>
<span id="cb59-220"><a href="#cb59-220" aria-hidden="true" tabindex="-1"></a><span class="co">#   └─&gt; use st_point_on_surface(geometry) instead of st_centroid() if you</span></span>
<span id="cb59-221"><a href="#cb59-221" aria-hidden="true" tabindex="-1"></a><span class="co">#       must ensure the point falls inside every (multi)polygon</span></span>
<span id="cb59-222"><a href="#cb59-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-223"><a href="#cb59-223" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.  Keep only what you want to join</span></span>
<span id="cb59-224"><a href="#cb59-224" aria-hidden="true" tabindex="-1"></a>centroids_tbl <span class="ot">&lt;-</span> med_regions <span class="sc">%&gt;%</span> </span>
<span id="cb59-225"><a href="#cb59-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span>                                       <span class="co"># drops *all* sf geometries</span></span>
<span id="cb59-226"><a href="#cb59-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name, lon, lat)  </span>
<span id="cb59-227"><a href="#cb59-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-228"><a href="#cb59-228" aria-hidden="true" tabindex="-1"></a>z_df_trend <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(z_raw_trend)  <span class="sc">%&gt;%</span> </span>
<span id="cb59-229"><a href="#cb59-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">region =</span> med_regions<span class="sc">$</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb59-230"><a href="#cb59-230" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>layer) <span class="sc">%&gt;%</span></span>
<span id="cb59-231"><a href="#cb59-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean =</span> <span class="fu">round</span>(mean,<span class="dv">3</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb59-232"><a href="#cb59-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(centroids_tbl, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"region"</span> <span class="ot">=</span> <span class="st">"name"</span>))</span>
<span id="cb59-233"><a href="#cb59-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-234"><a href="#cb59-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-235"><a href="#cb59-235" aria-hidden="true" tabindex="-1"></a>map_trend <span class="ot">&lt;-</span> df_map_freq_long <span class="sc">%&gt;%</span> </span>
<span id="cb59-236"><a href="#cb59-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_freq, <span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-237"><a href="#cb59-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb59-238"><a href="#cb59-238" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── data layers ───────────────────────────────────────────</span></span>
<span id="cb59-239"><a href="#cb59-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> trend)) <span class="sc">+</span></span>
<span id="cb59-240"><a href="#cb59-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb59-241"><a href="#cb59-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-242"><a href="#cb59-242" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── colour scale ──────────────────────────────────────────</span></span>
<span id="cb59-243"><a href="#cb59-243" aria-hidden="true" tabindex="-1"></a>    tidyterra<span class="sc">::</span><span class="fu">scale_fill_grass_c</span>(</span>
<span id="cb59-244"><a href="#cb59-244" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Trends of HW frequency (Event per year)"</span>,</span>
<span id="cb59-245"><a href="#cb59-245" aria-hidden="true" tabindex="-1"></a>      <span class="at">use_grass_range =</span> <span class="cn">FALSE</span></span>
<span id="cb59-246"><a href="#cb59-246" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb59-247"><a href="#cb59-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-248"><a href="#cb59-248" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── 1. horizontal colour bar, title on top ───────────────</span></span>
<span id="cb59-249"><a href="#cb59-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(</span>
<span id="cb59-250"><a href="#cb59-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb59-251"><a href="#cb59-251" aria-hidden="true" tabindex="-1"></a>        <span class="at">direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb59-252"><a href="#cb59-252" aria-hidden="true" tabindex="-1"></a>        <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb59-253"><a href="#cb59-253" aria-hidden="true" tabindex="-1"></a>        <span class="at">label.position =</span> <span class="st">"bottom"</span>,            <span class="co"># labels under the bar (optional)</span></span>
<span id="cb59-254"><a href="#cb59-254" aria-hidden="true" tabindex="-1"></a>        <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="dv">10</span>, <span class="st">"cm"</span>),       <span class="co"># adjust length</span></span>
<span id="cb59-255"><a href="#cb59-255" aria-hidden="true" tabindex="-1"></a>        <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.45</span>, <span class="st">"cm"</span>)     <span class="co"># adjust thickness</span></span>
<span id="cb59-256"><a href="#cb59-256" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb59-257"><a href="#cb59-257" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb59-258"><a href="#cb59-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-259"><a href="#cb59-259" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── map extent ───────────────────────────────────────────</span></span>
<span id="cb59-260"><a href="#cb59-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">40</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">47</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb59-261"><a href="#cb59-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-262"><a href="#cb59-262" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── region means &amp; colours ───────────────────────────────</span></span>
<span id="cb59-263"><a href="#cb59-263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="at">data =</span> z_df_trend,</span>
<span id="cb59-264"><a href="#cb59-264" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">label =</span> mean, <span class="at">colour =</span> region),</span>
<span id="cb59-265"><a href="#cb59-265" aria-hidden="true" tabindex="-1"></a>              <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.7</span>), <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb59-266"><a href="#cb59-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb59-267"><a href="#cb59-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-268"><a href="#cb59-268" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── scale bar ────────────────────────────────────────────</span></span>
<span id="cb59-269"><a href="#cb59-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotation_scale</span>(</span>
<span id="cb59-270"><a href="#cb59-270" aria-hidden="true" tabindex="-1"></a>      <span class="at">location   =</span> <span class="st">"bl"</span>,</span>
<span id="cb59-271"><a href="#cb59-271" aria-hidden="true" tabindex="-1"></a>      <span class="at">width_hint =</span> <span class="fl">0.25</span>,</span>
<span id="cb59-272"><a href="#cb59-272" aria-hidden="true" tabindex="-1"></a>      <span class="at">line_width =</span> <span class="fl">0.6</span>,</span>
<span id="cb59-273"><a href="#cb59-273" aria-hidden="true" tabindex="-1"></a>      <span class="at">text_cex   =</span> <span class="dv">2</span>,</span>
<span id="cb59-274"><a href="#cb59-274" aria-hidden="true" tabindex="-1"></a>      <span class="at">pad_x      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb59-275"><a href="#cb59-275" aria-hidden="true" tabindex="-1"></a>      <span class="at">pad_y      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb59-276"><a href="#cb59-276" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb59-277"><a href="#cb59-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-278"><a href="#cb59-278" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── theme ────────────────────────────────────────────────</span></span>
<span id="cb59-279"><a href="#cb59-279" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb59-280"><a href="#cb59-280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb59-281"><a href="#cb59-281" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid        =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"gray90"</span>),</span>
<span id="cb59-282"><a href="#cb59-282" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.background  =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>),</span>
<span id="cb59-283"><a href="#cb59-283" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb59-284"><a href="#cb59-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-285"><a href="#cb59-285" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2. park legend INSIDE, top-left</span></span>
<span id="cb59-286"><a href="#cb59-286" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),  <span class="co"># npc coords: 2 % from left, 98 % up</span></span>
<span id="cb59-287"><a href="#cb59-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),        <span class="co"># anchor by its top-left corner</span></span>
<span id="cb59-288"><a href="#cb59-288" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb59-289"><a href="#cb59-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-290"><a href="#cb59-290" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb59-291"><a href="#cb59-291" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb59-292"><a href="#cb59-292" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb59-293"><a href="#cb59-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-294"><a href="#cb59-294" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title            =</span> <span class="fu">element_blank</span>()</span>
<span id="cb59-295"><a href="#cb59-295" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-296"><a href="#cb59-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-297"><a href="#cb59-297" aria-hidden="true" tabindex="-1"></a>map_trend</span>
<span id="cb59-298"><a href="#cb59-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-299"><a href="#cb59-299" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/trend_frequency.png"</span>, map_trend, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb59-300"><a href="#cb59-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-301"><a href="#cb59-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-302"><a href="#cb59-302" aria-hidden="true" tabindex="-1"></a><span class="do">### BOXPLOT</span></span>
<span id="cb59-303"><a href="#cb59-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-304"><a href="#cb59-304" aria-hidden="true" tabindex="-1"></a><span class="co"># ── libraries ───────────────────────────────────────────────────────────</span></span>
<span id="cb59-305"><a href="#cb59-305" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)   <span class="co"># raster/terra objects</span></span>
<span id="cb59-306"><a href="#cb59-306" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)      <span class="co"># modern vector data</span></span>
<span id="cb59-307"><a href="#cb59-307" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># plotting</span></span>
<span id="cb59-308"><a href="#cb59-308" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)   <span class="co"># pipe-friendly helpers (optional)</span></span>
<span id="cb59-309"><a href="#cb59-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-310"><a href="#cb59-310" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1. load data ────────────────────────────────────────────────────────</span></span>
<span id="cb59-311"><a href="#cb59-311" aria-hidden="true" tabindex="-1"></a>r   <span class="ot">&lt;-</span> rast_trend         <span class="co"># single- or multi-band</span></span>
<span id="cb59-312"><a href="#cb59-312" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">&lt;-</span> med_regions           <span class="co"># polygons</span></span>
<span id="cb59-313"><a href="#cb59-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-314"><a href="#cb59-314" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure both layers share the same CRS</span></span>
<span id="cb59-315"><a href="#cb59-315" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(reg, <span class="fu">crs</span>(r))</span>
<span id="cb59-316"><a href="#cb59-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-317"><a href="#cb59-317" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2. extract values per polygon ───────────────────────────────────────</span></span>
<span id="cb59-318"><a href="#cb59-318" aria-hidden="true" tabindex="-1"></a><span class="co"># terra::extract() returns a data.frame: one row per cell per polygon</span></span>
<span id="cb59-319"><a href="#cb59-319" aria-hidden="true" tabindex="-1"></a><span class="co">#   ID   = polygon index (generated automatically)</span></span>
<span id="cb59-320"><a href="#cb59-320" aria-hidden="true" tabindex="-1"></a><span class="co">#   lyr1 = raster value (one column per raster layer)</span></span>
<span id="cb59-321"><a href="#cb59-321" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb59-322"><a href="#cb59-322" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(r, <span class="fu">vect</span>(reg))            <span class="co"># vect() converts sf → SpatVector</span></span>
<span id="cb59-323"><a href="#cb59-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-324"><a href="#cb59-324" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3. tidy up: attach region names / attributes ───────────────────────</span></span>
<span id="cb59-325"><a href="#cb59-325" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppose your regions layer has a column called "NAME"</span></span>
<span id="cb59-326"><a href="#cb59-326" aria-hidden="true" tabindex="-1"></a>ID_name <span class="ot">&lt;-</span> reg <span class="sc">%&gt;%</span> </span>
<span id="cb59-327"><a href="#cb59-327" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span>  </span>
<span id="cb59-328"><a href="#cb59-328" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),</span>
<span id="cb59-329"><a href="#cb59-329" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name =</span> <span class="fu">as_factor</span>(name))  <span class="sc">%&gt;%</span>       <span class="co"># ensure matching ID</span></span>
<span id="cb59-330"><a href="#cb59-330" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(ID, name)</span>
<span id="cb59-331"><a href="#cb59-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-332"><a href="#cb59-332" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> vals <span class="sc">%&gt;%</span> </span>
<span id="cb59-333"><a href="#cb59-333" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(ID_name,<span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-334"><a href="#cb59-334" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(mean <span class="sc">!=</span> <span class="dv">0</span>)<span class="sc">%&gt;%</span>                       <span class="co"># your summary data-frame</span></span>
<span id="cb59-335"><a href="#cb59-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb59-336"><a href="#cb59-336" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">fct_reorder</span>(name, mean, <span class="at">.desc =</span> <span class="cn">TRUE</span>)  <span class="co"># order by mean, descending</span></span>
<span id="cb59-337"><a href="#cb59-337" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-338"><a href="#cb59-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-339"><a href="#cb59-339" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 4. plot ─────────────────────────────────────────────────────────────</span></span>
<span id="cb59-340"><a href="#cb59-340" aria-hidden="true" tabindex="-1"></a>plot_boxplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb59-341"><a href="#cb59-341" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. data layer (legend suppressed)</span></span>
<span id="cb59-342"><a href="#cb59-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(</span>
<span id="cb59-343"><a href="#cb59-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">data          =</span> vals,</span>
<span id="cb59-344"><a href="#cb59-344" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> name, <span class="at">y =</span> mean, <span class="at">fill =</span> name),</span>
<span id="cb59-345"><a href="#cb59-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour        =</span> <span class="st">"black"</span>,</span>
<span id="cb59-346"><a href="#cb59-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth     =</span> <span class="fl">0.7</span>,</span>
<span id="cb59-347"><a href="#cb59-347" aria-hidden="true" tabindex="-1"></a>    <span class="co"># size = 2,</span></span>
<span id="cb59-348"><a href="#cb59-348" aria-hidden="true" tabindex="-1"></a>    <span class="co"># alpha         = .60,</span></span>
<span id="cb59-349"><a href="#cb59-349" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.shape =</span> <span class="dv">21</span>,</span>
<span id="cb59-350"><a href="#cb59-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.fill  =</span> <span class="cn">NA</span>,</span>
<span id="cb59-351"><a href="#cb59-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend   =</span> <span class="cn">FALSE</span></span>
<span id="cb59-352"><a href="#cb59-352" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-353"><a href="#cb59-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-354"><a href="#cb59-354" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. dummy layer that only feeds the legend (square keys)</span></span>
<span id="cb59-355"><a href="#cb59-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb59-356"><a href="#cb59-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">name =</span> <span class="fu">names</span>(region_col), <span class="at">x =</span> <span class="cn">NA_real_</span>, <span class="at">y =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb59-357"><a href="#cb59-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(x, y, <span class="at">fill =</span> name),</span>
<span id="cb59-358"><a href="#cb59-358" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape        =</span> <span class="dv">22</span>,        <span class="co"># solid square</span></span>
<span id="cb59-359"><a href="#cb59-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">size         =</span> <span class="dv">6</span>,</span>
<span id="cb59-360"><a href="#cb59-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">stroke       =</span> <span class="dv">0</span>,</span>
<span id="cb59-361"><a href="#cb59-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend  =</span> <span class="cn">TRUE</span>,</span>
<span id="cb59-362"><a href="#cb59-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes  =</span> <span class="cn">FALSE</span></span>
<span id="cb59-363"><a href="#cb59-363" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb59-364"><a href="#cb59-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-365"><a href="#cb59-365" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ---- scales -----------------------------------------------------------</span></span>
<span id="cb59-366"><a href="#cb59-366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">"Region"</span>) <span class="sc">+</span></span>
<span id="cb59-367"><a href="#cb59-367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> region_col, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb59-368"><a href="#cb59-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-369"><a href="#cb59-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb59-370"><a href="#cb59-370" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow       =</span> <span class="dv">2</span>,                 <span class="co"># 1 column ⇒ 4 rows</span></span>
<span id="cb59-371"><a href="#cb59-371" aria-hidden="true" tabindex="-1"></a>    <span class="at">byrow      =</span> <span class="cn">TRUE</span>,</span>
<span id="cb59-372"><a href="#cb59-372" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywidth   =</span> <span class="fu">unit</span>(<span class="fl">0.6</span>, <span class="st">"cm"</span>),   <span class="co"># square keys</span></span>
<span id="cb59-373"><a href="#cb59-373" aria-hidden="true" tabindex="-1"></a>    <span class="at">keyheight  =</span> <span class="fu">unit</span>(<span class="fl">0.6</span>, <span class="st">"cm"</span>)</span>
<span id="cb59-374"><a href="#cb59-374" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb59-375"><a href="#cb59-375" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ---- labels &amp; theme ---------------------------------------------------</span></span>
<span id="cb59-376"><a href="#cb59-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb59-377"><a href="#cb59-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb59-378"><a href="#cb59-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Trends of HW frequency (Event per year)"</span></span>
<span id="cb59-379"><a href="#cb59-379" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-380"><a href="#cb59-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb59-381"><a href="#cb59-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb59-382"><a href="#cb59-382" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb59-383"><a href="#cb59-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text       =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb59-384"><a href="#cb59-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-385"><a href="#cb59-385" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.15</span>),   <span class="co"># (x, y) in npc units</span></span>
<span id="cb59-386"><a href="#cb59-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),         <span class="co"># anchor by its top-left corner</span></span>
<span id="cb59-387"><a href="#cb59-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"vertical"</span>,      <span class="co"># keeps items vertical</span></span>
<span id="cb59-388"><a href="#cb59-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb59-389"><a href="#cb59-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb59-390"><a href="#cb59-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-391"><a href="#cb59-391" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width      =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>),    <span class="co"># leave if you want wider keys</span></span>
<span id="cb59-392"><a href="#cb59-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb59-393"><a href="#cb59-393" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb59-394"><a href="#cb59-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.23</span>))</span>
<span id="cb59-395"><a href="#cb59-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-396"><a href="#cb59-396" aria-hidden="true" tabindex="-1"></a>plot_boxplot</span>
<span id="cb59-397"><a href="#cb59-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-398"><a href="#cb59-398" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/trend_boxplot.png"</span>, plot_boxplot, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [25]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magick)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1. read the four individual plots ───────────────────────────────────</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>img_a <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/Map_MedSea_n_event.png"</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>img_b <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/line_n_event.png"</span>)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>img_c <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/trend_frequency.png"</span>)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>img_d <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/trend_boxplot.png"</span>)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2. add a corner label to each plot ──────────────────────────────────</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>stamp <span class="ot">&lt;-</span> <span class="cf">function</span>(img, letter,</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">80</span>,               <span class="co"># point size of the label</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gravity =</span> <span class="st">"northwest"</span>,   <span class="co"># top-left corner</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">offset  =</span> <span class="st">"+20+15"</span>) {    <span class="co"># x,y offset from the corner</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_annotate</span>(</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    img, letter,</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">font      =</span> <span class="st">"Helvetica-Bold"</span>,</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">size      =</span> size,</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">gravity   =</span> gravity,</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">location  =</span> offset,</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">color     =</span> <span class="st">"black"</span>,</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">boxcolor  =</span> <span class="st">"white"</span>,   <span class="co"># gives a small white rectangle behind the letter</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight    =</span> <span class="dv">700</span>        <span class="co"># ensures the stroke is bold</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>img_a <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_a, <span class="st">"A"</span>)</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>img_b <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_b, <span class="st">"B"</span>)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>img_c <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_c, <span class="st">"C"</span>)</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>img_d <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_d, <span class="st">"D"</span>)</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3. assemble the composite exactly as before ─────────────────────────</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>row1  <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(img_a, img_b), <span class="at">stack =</span> <span class="cn">FALSE</span>)  <span class="co"># side-by-side</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>row2  <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(img_c, img_d), <span class="at">stack =</span> <span class="cn">FALSE</span>)</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>combo <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(row1, row2),   <span class="at">stack =</span> <span class="cn">TRUE</span>)   <span class="co"># one above the other</span></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a><span class="fu">image_write</span>(combo, <span class="at">path =</span> <span class="st">"Manuscript/Figs/plot_n_events.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="intensity" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="intensity"><span class="header-section-number">3.3.2</span> Intensity</h3>
<div class="cell-container"><div class="cell-decorator"><pre>In [26]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridisLite)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Utilities.Package)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>region_col <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># greens</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Levantine Sea"</span> <span class="ot">=</span> <span class="st">"#008F1A"</span>,   <span class="co"># brighter pine-green</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sea of Sicily"</span> <span class="ot">=</span> <span class="st">"#6B9C3C"</span>,   <span class="co"># vivid olive-sage</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># blues / teals / purples</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Alboran Sea"</span>   <span class="ot">=</span> <span class="st">"#414E7C"</span>,   <span class="co"># richer slate-blue</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Gulf of Lyon"</span>  <span class="ot">=</span> <span class="st">"#266A78"</span>,   <span class="co"># clearer Mediterranean teal</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Adriatic sea"</span>  <span class="ot">=</span> <span class="st">"#583C68"</span>,   <span class="co"># deeper indigo-violet</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yellows / ochres</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Balearic Sea"</span>  <span class="ot">=</span> <span class="st">"#A98C3D"</span>,   <span class="co"># crisp mustard-ochre</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Aegean Sea"</span>    <span class="ot">=</span> <span class="st">"#D7A543"</span>,   <span class="co"># sun-baked golden-ochre</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reds / oranges / browns</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tyrrhenian Sea"</span><span class="ot">=</span> <span class="st">"#A02A2A"</span>,   <span class="co"># vivid brick-red</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Algerian Sea"</span>  <span class="ot">=</span> <span class="st">"#DF5513"</span>,   <span class="co"># bright burnt-orange</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ionian Sea"</span>    <span class="ot">=</span> <span class="st">"#705943"</span>    <span class="co"># warmer earthy-taupe</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your shapefile (replace with your path)</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"Black"</span>))</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Get world land polygons</span></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>filelist <span class="ot">&lt;-</span> <span class="st">"Outputs/SST/nc/intensity_mean"</span> <span class="sc">%&gt;%</span> </span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(<span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">substr</span>(file,<span class="dv">16</span>,<span class="dv">19</span>))</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>stk <span class="ot">&lt;-</span> filelist<span class="sc">$</span>path <span class="sc">%&gt;%</span> </span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>()</span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(stk) <span class="ot">&lt;-</span> filelist<span class="sc">$</span>year</span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>stk_avg <span class="ot">&lt;-</span> <span class="fu">mean</span>(stk, <span class="at">na.rm =</span> T)</span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>map_intensity <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── data layers ─────────────────────────────────────────────</span></span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a>  tidyterra<span class="sc">::</span><span class="fu">geom_spatraster</span>(<span class="at">data =</span> stk_avg,</span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">aes</span>(<span class="at">fill =</span> mean)) <span class="sc">+</span> </span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── colour scales ───────────────────────────────────────────</span></span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(</span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours  =</span> <span class="fu">turbo</span>(<span class="dv">10</span>),</span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">name     =</span> <span class="st">"Mean intensity of HW events (°C)"</span></span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── horizontal guide with title on top ──────────────────────</span></span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.position =</span> <span class="st">"bottom"</span>,            <span class="co"># optional – labels below bar</span></span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="dv">5</span>, <span class="st">"cm"</span>),       <span class="co"># tweak length</span></span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.45</span>, <span class="st">"cm"</span>)     <span class="co"># tweak thickness</span></span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── map extent ──────────────────────────────────────────────</span></span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">40</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">47</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── *** scale bar *** ───────────────────────────────────────</span></span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotation_scale</span>(</span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">location   =</span> <span class="st">"bl"</span>,   <span class="co"># bottom-left</span></span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">width_hint =</span> <span class="fl">0.25</span>,   <span class="co"># ≈25 % of the map width</span></span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">line_width =</span> <span class="fl">0.6</span>,</span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">text_cex   =</span> <span class="dv">2</span>,</span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad_x      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad_y      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── theme ───────────────────────────────────────────────────</span></span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid        =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background  =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>),</span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># move legend INSIDE, upper-left; anchor by its top-left corner</span></span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),   <span class="co"># npc coords (x = 2 %, y = 98 %)</span></span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title.align    =</span> <span class="fl">0.5</span>,             <span class="co"># centre title</span></span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># give legend a white background &amp; a bit of padding</span></span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>,<span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a>map_intensity</span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/Map_MedSea_intensity.png"</span>, map_intensity, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a><span class="do">############ Line plot by region</span></span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(med_regions, <span class="fu">crs</span>(stk))</span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a><span class="co"># med_regions &lt;- st_zm(med_regions)</span></span>
<span id="cb61-113"><a href="#cb61-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-114"><a href="#cb61-114" aria-hidden="true" tabindex="-1"></a>zone_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(med_regions, stk[[<span class="dv">1</span>]], <span class="at">field =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(med_regions))</span>
<span id="cb61-115"><a href="#cb61-115" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(zone_rast)</span>
<span id="cb61-116"><a href="#cb61-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that terra::zonal will apply: returns a 3-element vector</span></span>
<span id="cb61-117"><a href="#cb61-117" aria-hidden="true" tabindex="-1"></a>qfun <span class="ot">&lt;-</span> <span class="cf">function</span>(values, ...) {</span>
<span id="cb61-118"><a href="#cb61-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(values, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-119"><a href="#cb61-119" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-120"><a href="#cb61-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-121"><a href="#cb61-121" aria-hidden="true" tabindex="-1"></a><span class="co"># zonal() summarises **all layers at once**</span></span>
<span id="cb61-122"><a href="#cb61-122" aria-hidden="true" tabindex="-1"></a>z_raw <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(stk, zone_rast, <span class="at">fun =</span> qfun)</span>
<span id="cb61-123"><a href="#cb61-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-124"><a href="#cb61-124" aria-hidden="true" tabindex="-1"></a>z_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(z_raw)  <span class="sc">%&gt;%</span> </span>
<span id="cb61-125"><a href="#cb61-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">region =</span> med_regions<span class="sc">$</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb61-126"><a href="#cb61-126" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>layer) <span class="sc">%&gt;%</span> <span class="co"># attach names</span></span>
<span id="cb61-127"><a href="#cb61-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="sc">-</span>region),</span>
<span id="cb61-128"><a href="#cb61-128" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to   =</span> <span class="st">"year"</span>,</span>
<span id="cb61-129"><a href="#cb61-129" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"mean"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-130"><a href="#cb61-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year))</span>
<span id="cb61-131"><a href="#cb61-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-132"><a href="#cb61-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-133"><a href="#cb61-133" aria-hidden="true" tabindex="-1"></a>plot_lines <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(z_df, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> mean, <span class="at">colour =</span> region)) <span class="sc">+</span></span>
<span id="cb61-134"><a href="#cb61-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb61-135"><a href="#cb61-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb61-136"><a href="#cb61-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> region_col) <span class="sc">+</span></span>
<span id="cb61-137"><a href="#cb61-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-138"><a href="#cb61-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb61-139"><a href="#cb61-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">method    =</span> <span class="st">"glm"</span>,</span>
<span id="cb61-140"><a href="#cb61-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">1.2</span>,</span>
<span id="cb61-141"><a href="#cb61-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha     =</span> <span class="fl">0.05</span>,</span>
<span id="cb61-142"><a href="#cb61-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># formula     = (y) ~ s(x),  # &lt;-- k goes here</span></span>
<span id="cb61-143"><a href="#cb61-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb61-144"><a href="#cb61-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-145"><a href="#cb61-145" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── 1. force a ONE-column legend ────────────────────────────</span></span>
<span id="cb61-146"><a href="#cb61-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb61-147"><a href="#cb61-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">ncol =</span> <span class="dv">1</span>)   <span class="co"># 1 column, items stacked</span></span>
<span id="cb61-148"><a href="#cb61-148" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-149"><a href="#cb61-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ylim(c(0,11.25))+</span></span>
<span id="cb61-150"><a href="#cb61-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-151"><a href="#cb61-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour =</span> <span class="st">"Regions"</span>, <span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="st">"Mean intensity of HW event (°C)"</span>) <span class="sc">+</span></span>
<span id="cb61-152"><a href="#cb61-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-153"><a href="#cb61-153" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── 2. theme tweaks to pin legend inside, top-left ──────────</span></span>
<span id="cb61-154"><a href="#cb61-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb61-155"><a href="#cb61-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb61-156"><a href="#cb61-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb61-157"><a href="#cb61-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text       =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb61-158"><a href="#cb61-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-159"><a href="#cb61-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),   <span class="co"># (x, y) in npc units</span></span>
<span id="cb61-160"><a href="#cb61-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),         <span class="co"># anchor by its top-left corner</span></span>
<span id="cb61-161"><a href="#cb61-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"vertical"</span>,      <span class="co"># keeps items vertical</span></span>
<span id="cb61-162"><a href="#cb61-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb61-163"><a href="#cb61-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb61-164"><a href="#cb61-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-165"><a href="#cb61-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width      =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>)    <span class="co"># leave if you want wider keys</span></span>
<span id="cb61-166"><a href="#cb61-166" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-167"><a href="#cb61-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-168"><a href="#cb61-168" aria-hidden="true" tabindex="-1"></a>plot_lines</span>
<span id="cb61-169"><a href="#cb61-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-170"><a href="#cb61-170" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/line_intensity.png"</span>, plot_lines, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb61-171"><a href="#cb61-171" aria-hidden="true" tabindex="-1"></a><span class="do">###################### MAP of TREND</span></span>
<span id="cb61-172"><a href="#cb61-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-173"><a href="#cb61-173" aria-hidden="true" tabindex="-1"></a>df_map_intensity_long <span class="ot">&lt;-</span> stk <span class="sc">%&gt;%</span></span>
<span id="cb61-174"><a href="#cb61-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb61-175"><a href="#cb61-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb61-176"><a href="#cb61-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(ID,x,y), <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"year"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-177"><a href="#cb61-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(value) <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb61-178"><a href="#cb61-178" aria-hidden="true" tabindex="-1"></a>                           T <span class="sc">~</span> value)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-179"><a href="#cb61-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-180"><a href="#cb61-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb61-181"><a href="#cb61-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">trend =</span> <span class="fu">coef</span>(<span class="fu">lm</span>(value <span class="sc">~</span> year))[<span class="dv">2</span>])</span>
<span id="cb61-182"><a href="#cb61-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-183"><a href="#cb61-183" aria-hidden="true" tabindex="-1"></a>df_intensity <span class="ot">&lt;-</span> stk <span class="sc">%&gt;%</span></span>
<span id="cb61-184"><a href="#cb61-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span>  </span>
<span id="cb61-185"><a href="#cb61-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb61-186"><a href="#cb61-186" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(x,y,ID))</span>
<span id="cb61-187"><a href="#cb61-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-188"><a href="#cb61-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-189"><a href="#cb61-189" aria-hidden="true" tabindex="-1"></a>df_trend <span class="ot">&lt;-</span> df_map_intensity_long <span class="sc">%&gt;%</span> </span>
<span id="cb61-190"><a href="#cb61-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr::filter(trend &lt; quantile(trend, probs = 0.95)) %&gt;% </span></span>
<span id="cb61-191"><a href="#cb61-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_intensity, <span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-192"><a href="#cb61-192" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>ID) <span class="sc">%&gt;%</span> </span>
<span id="cb61-193"><a href="#cb61-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(x,y,trend)</span>
<span id="cb61-194"><a href="#cb61-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-195"><a href="#cb61-195" aria-hidden="true" tabindex="-1"></a>rast_trend <span class="ot">&lt;-</span> stk<span class="sc">$</span><span class="st">`</span><span class="at">1982</span><span class="st">`</span></span>
<span id="cb61-196"><a href="#cb61-196" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(rast_trend) <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb61-197"><a href="#cb61-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-198"><a href="#cb61-198" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">vect</span>(df_trend, <span class="at">geom =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="fu">crs</span>(rast_trend))</span>
<span id="cb61-199"><a href="#cb61-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-200"><a href="#cb61-200" aria-hidden="true" tabindex="-1"></a>rast_trend <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(</span>
<span id="cb61-201"><a href="#cb61-201" aria-hidden="true" tabindex="-1"></a>  pts,             <span class="co"># what to burn</span></span>
<span id="cb61-202"><a href="#cb61-202" aria-hidden="true" tabindex="-1"></a>  rast_trend,         <span class="co"># target raster geometry</span></span>
<span id="cb61-203"><a href="#cb61-203" aria-hidden="true" tabindex="-1"></a>  <span class="at">field =</span> <span class="st">"trend"</span>, <span class="co"># column to transfer</span></span>
<span id="cb61-204"><a href="#cb61-204" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun   =</span> <span class="st">"mean"</span>   <span class="co"># how to handle duplicate points (mean, max, sum, …)</span></span>
<span id="cb61-205"><a href="#cb61-205" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-206"><a href="#cb61-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-207"><a href="#cb61-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that terra::zonal will apply: returns a 3-element vector</span></span>
<span id="cb61-208"><a href="#cb61-208" aria-hidden="true" tabindex="-1"></a>qfun <span class="ot">&lt;-</span> <span class="cf">function</span>(values, ...) {</span>
<span id="cb61-209"><a href="#cb61-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(values, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-210"><a href="#cb61-210" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-211"><a href="#cb61-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-212"><a href="#cb61-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-213"><a href="#cb61-213" aria-hidden="true" tabindex="-1"></a><span class="co"># zonal() summarises **all layers at once**</span></span>
<span id="cb61-214"><a href="#cb61-214" aria-hidden="true" tabindex="-1"></a>z_raw_trend <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(rast_trend, zone_rast, <span class="at">fun =</span> qfun)</span>
<span id="cb61-215"><a href="#cb61-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-216"><a href="#cb61-216" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.  Add centroid geometry and its coordinates to `med_regions`</span></span>
<span id="cb61-217"><a href="#cb61-217" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> med_regions <span class="sc">%&gt;%</span>                                 <span class="co"># already an sf multipolygon</span></span>
<span id="cb61-218"><a href="#cb61-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">centroid =</span> <span class="fu">st_centroid</span>(geometry),                     <span class="co"># geometry column is usually called `geometry`</span></span>
<span id="cb61-219"><a href="#cb61-219" aria-hidden="true" tabindex="-1"></a>         <span class="at">lon      =</span> <span class="fu">st_coordinates</span>(centroid)[, <span class="dv">1</span>],             <span class="co"># X</span></span>
<span id="cb61-220"><a href="#cb61-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">lat      =</span> <span class="fu">st_coordinates</span>(centroid)[, <span class="dv">2</span>])             <span class="co"># Y</span></span>
<span id="cb61-221"><a href="#cb61-221" aria-hidden="true" tabindex="-1"></a><span class="co">#   └─&gt; use st_point_on_surface(geometry) instead of st_centroid() if you</span></span>
<span id="cb61-222"><a href="#cb61-222" aria-hidden="true" tabindex="-1"></a><span class="co">#       must ensure the point falls inside every (multi)polygon</span></span>
<span id="cb61-223"><a href="#cb61-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-224"><a href="#cb61-224" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.  Keep only what you want to join</span></span>
<span id="cb61-225"><a href="#cb61-225" aria-hidden="true" tabindex="-1"></a>centroids_tbl <span class="ot">&lt;-</span> med_regions <span class="sc">%&gt;%</span> </span>
<span id="cb61-226"><a href="#cb61-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span>                                       <span class="co"># drops *all* sf geometries</span></span>
<span id="cb61-227"><a href="#cb61-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name, lon, lat)  </span>
<span id="cb61-228"><a href="#cb61-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-229"><a href="#cb61-229" aria-hidden="true" tabindex="-1"></a>z_df_trend <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(z_raw_trend)  <span class="sc">%&gt;%</span> </span>
<span id="cb61-230"><a href="#cb61-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">region =</span> med_regions<span class="sc">$</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb61-231"><a href="#cb61-231" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>layer) <span class="sc">%&gt;%</span></span>
<span id="cb61-232"><a href="#cb61-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean =</span> <span class="fu">round</span>(mean,<span class="dv">3</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-233"><a href="#cb61-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(centroids_tbl, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"region"</span> <span class="ot">=</span> <span class="st">"name"</span>))</span>
<span id="cb61-234"><a href="#cb61-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-235"><a href="#cb61-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-236"><a href="#cb61-236" aria-hidden="true" tabindex="-1"></a>map_trend <span class="ot">&lt;-</span> df_map_intensity_long <span class="sc">%&gt;%</span> </span>
<span id="cb61-237"><a href="#cb61-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_intensity, <span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-238"><a href="#cb61-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb61-239"><a href="#cb61-239" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── data layers ───────────────────────────────────────────</span></span>
<span id="cb61-240"><a href="#cb61-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> trend)) <span class="sc">+</span></span>
<span id="cb61-241"><a href="#cb61-241" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb61-242"><a href="#cb61-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-243"><a href="#cb61-243" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── colour scale ──────────────────────────────────────────</span></span>
<span id="cb61-244"><a href="#cb61-244" aria-hidden="true" tabindex="-1"></a>    tidyterra<span class="sc">::</span><span class="fu">scale_fill_grass_c</span>(</span>
<span id="cb61-245"><a href="#cb61-245" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Trends of HW intensity (°C per year)"</span>,</span>
<span id="cb61-246"><a href="#cb61-246" aria-hidden="true" tabindex="-1"></a>      <span class="at">use_grass_range =</span> <span class="cn">FALSE</span></span>
<span id="cb61-247"><a href="#cb61-247" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-248"><a href="#cb61-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-249"><a href="#cb61-249" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── 1. horizontal colour bar, title on top ───────────────</span></span>
<span id="cb61-250"><a href="#cb61-250" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(</span>
<span id="cb61-251"><a href="#cb61-251" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb61-252"><a href="#cb61-252" aria-hidden="true" tabindex="-1"></a>        <span class="at">direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb61-253"><a href="#cb61-253" aria-hidden="true" tabindex="-1"></a>        <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb61-254"><a href="#cb61-254" aria-hidden="true" tabindex="-1"></a>        <span class="at">label.position =</span> <span class="st">"bottom"</span>,            <span class="co"># labels under the bar (optional)</span></span>
<span id="cb61-255"><a href="#cb61-255" aria-hidden="true" tabindex="-1"></a>        <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="dv">10</span>, <span class="st">"cm"</span>),       <span class="co"># adjust length</span></span>
<span id="cb61-256"><a href="#cb61-256" aria-hidden="true" tabindex="-1"></a>        <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.45</span>, <span class="st">"cm"</span>)     <span class="co"># adjust thickness</span></span>
<span id="cb61-257"><a href="#cb61-257" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb61-258"><a href="#cb61-258" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-259"><a href="#cb61-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-260"><a href="#cb61-260" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── map extent ───────────────────────────────────────────</span></span>
<span id="cb61-261"><a href="#cb61-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">40</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">47</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb61-262"><a href="#cb61-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-263"><a href="#cb61-263" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── region means &amp; colours ───────────────────────────────</span></span>
<span id="cb61-264"><a href="#cb61-264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="at">data =</span> z_df_trend,</span>
<span id="cb61-265"><a href="#cb61-265" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">label =</span> mean, <span class="at">colour =</span> region),</span>
<span id="cb61-266"><a href="#cb61-266" aria-hidden="true" tabindex="-1"></a>              <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.7</span>), <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb61-267"><a href="#cb61-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb61-268"><a href="#cb61-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-269"><a href="#cb61-269" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── scale bar ────────────────────────────────────────────</span></span>
<span id="cb61-270"><a href="#cb61-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotation_scale</span>(</span>
<span id="cb61-271"><a href="#cb61-271" aria-hidden="true" tabindex="-1"></a>      <span class="at">location   =</span> <span class="st">"bl"</span>,</span>
<span id="cb61-272"><a href="#cb61-272" aria-hidden="true" tabindex="-1"></a>      <span class="at">width_hint =</span> <span class="fl">0.25</span>,</span>
<span id="cb61-273"><a href="#cb61-273" aria-hidden="true" tabindex="-1"></a>      <span class="at">line_width =</span> <span class="fl">0.6</span>,</span>
<span id="cb61-274"><a href="#cb61-274" aria-hidden="true" tabindex="-1"></a>      <span class="at">text_cex   =</span> <span class="dv">2</span>,</span>
<span id="cb61-275"><a href="#cb61-275" aria-hidden="true" tabindex="-1"></a>      <span class="at">pad_x      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb61-276"><a href="#cb61-276" aria-hidden="true" tabindex="-1"></a>      <span class="at">pad_y      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb61-277"><a href="#cb61-277" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-278"><a href="#cb61-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-279"><a href="#cb61-279" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── theme ────────────────────────────────────────────────</span></span>
<span id="cb61-280"><a href="#cb61-280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb61-281"><a href="#cb61-281" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb61-282"><a href="#cb61-282" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid        =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"gray90"</span>),</span>
<span id="cb61-283"><a href="#cb61-283" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.background  =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>),</span>
<span id="cb61-284"><a href="#cb61-284" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb61-285"><a href="#cb61-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-286"><a href="#cb61-286" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2. park legend INSIDE, top-left</span></span>
<span id="cb61-287"><a href="#cb61-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),  <span class="co"># npc coords: 2 % from left, 98 % up</span></span>
<span id="cb61-288"><a href="#cb61-288" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),        <span class="co"># anchor by its top-left corner</span></span>
<span id="cb61-289"><a href="#cb61-289" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb61-290"><a href="#cb61-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-291"><a href="#cb61-291" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb61-292"><a href="#cb61-292" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb61-293"><a href="#cb61-293" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb61-294"><a href="#cb61-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-295"><a href="#cb61-295" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title            =</span> <span class="fu">element_blank</span>()</span>
<span id="cb61-296"><a href="#cb61-296" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-297"><a href="#cb61-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-298"><a href="#cb61-298" aria-hidden="true" tabindex="-1"></a>map_trend</span>
<span id="cb61-299"><a href="#cb61-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-300"><a href="#cb61-300" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/trend_intensity.png"</span>, map_trend, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb61-301"><a href="#cb61-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-302"><a href="#cb61-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-303"><a href="#cb61-303" aria-hidden="true" tabindex="-1"></a><span class="do">### BOXPLOT</span></span>
<span id="cb61-304"><a href="#cb61-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-305"><a href="#cb61-305" aria-hidden="true" tabindex="-1"></a><span class="co"># ── libraries ───────────────────────────────────────────────────────────</span></span>
<span id="cb61-306"><a href="#cb61-306" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)   <span class="co"># raster/terra objects</span></span>
<span id="cb61-307"><a href="#cb61-307" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)      <span class="co"># modern vector data</span></span>
<span id="cb61-308"><a href="#cb61-308" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># plotting</span></span>
<span id="cb61-309"><a href="#cb61-309" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)   <span class="co"># pipe-friendly helpers (optional)</span></span>
<span id="cb61-310"><a href="#cb61-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-311"><a href="#cb61-311" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1. load data ────────────────────────────────────────────────────────</span></span>
<span id="cb61-312"><a href="#cb61-312" aria-hidden="true" tabindex="-1"></a>r   <span class="ot">&lt;-</span> rast_trend         <span class="co"># single- or multi-band</span></span>
<span id="cb61-313"><a href="#cb61-313" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">&lt;-</span> med_regions           <span class="co"># polygons</span></span>
<span id="cb61-314"><a href="#cb61-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-315"><a href="#cb61-315" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure both layers share the same CRS</span></span>
<span id="cb61-316"><a href="#cb61-316" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(reg, <span class="fu">crs</span>(r))</span>
<span id="cb61-317"><a href="#cb61-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-318"><a href="#cb61-318" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2. extract values per polygon ───────────────────────────────────────</span></span>
<span id="cb61-319"><a href="#cb61-319" aria-hidden="true" tabindex="-1"></a><span class="co"># terra::extract() returns a data.frame: one row per cell per polygon</span></span>
<span id="cb61-320"><a href="#cb61-320" aria-hidden="true" tabindex="-1"></a><span class="co">#   ID   = polygon index (generated automatically)</span></span>
<span id="cb61-321"><a href="#cb61-321" aria-hidden="true" tabindex="-1"></a><span class="co">#   lyr1 = raster value (one column per raster layer)</span></span>
<span id="cb61-322"><a href="#cb61-322" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb61-323"><a href="#cb61-323" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(r, <span class="fu">vect</span>(reg))            <span class="co"># vect() converts sf → SpatVector</span></span>
<span id="cb61-324"><a href="#cb61-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-325"><a href="#cb61-325" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3. tidy up: attach region names / attributes ───────────────────────</span></span>
<span id="cb61-326"><a href="#cb61-326" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppose your regions layer has a column called "NAME"</span></span>
<span id="cb61-327"><a href="#cb61-327" aria-hidden="true" tabindex="-1"></a>ID_name <span class="ot">&lt;-</span> reg <span class="sc">%&gt;%</span> </span>
<span id="cb61-328"><a href="#cb61-328" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span>  </span>
<span id="cb61-329"><a href="#cb61-329" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),</span>
<span id="cb61-330"><a href="#cb61-330" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name =</span> <span class="fu">as_factor</span>(name))  <span class="sc">%&gt;%</span>       <span class="co"># ensure matching ID</span></span>
<span id="cb61-331"><a href="#cb61-331" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(ID, name)</span>
<span id="cb61-332"><a href="#cb61-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-333"><a href="#cb61-333" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> vals <span class="sc">%&gt;%</span> </span>
<span id="cb61-334"><a href="#cb61-334" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(ID_name,<span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-335"><a href="#cb61-335" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(mean <span class="sc">!=</span> <span class="dv">0</span>)<span class="sc">%&gt;%</span>                       <span class="co"># your summary data-frame</span></span>
<span id="cb61-336"><a href="#cb61-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-337"><a href="#cb61-337" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">fct_reorder</span>(name, mean, <span class="at">.desc =</span> <span class="cn">TRUE</span>)  <span class="co"># order by mean, descending</span></span>
<span id="cb61-338"><a href="#cb61-338" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-339"><a href="#cb61-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-340"><a href="#cb61-340" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 4. plot ─────────────────────────────────────────────────────────────</span></span>
<span id="cb61-341"><a href="#cb61-341" aria-hidden="true" tabindex="-1"></a>plot_boxplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb61-342"><a href="#cb61-342" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. data layer (legend suppressed)</span></span>
<span id="cb61-343"><a href="#cb61-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(</span>
<span id="cb61-344"><a href="#cb61-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">data          =</span> vals,</span>
<span id="cb61-345"><a href="#cb61-345" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> name, <span class="at">y =</span> mean, <span class="at">fill =</span> name),</span>
<span id="cb61-346"><a href="#cb61-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour        =</span> <span class="st">"black"</span>,</span>
<span id="cb61-347"><a href="#cb61-347" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth     =</span> <span class="fl">0.7</span>,</span>
<span id="cb61-348"><a href="#cb61-348" aria-hidden="true" tabindex="-1"></a>    <span class="co"># size = 2,</span></span>
<span id="cb61-349"><a href="#cb61-349" aria-hidden="true" tabindex="-1"></a>    <span class="co"># alpha         = .60,</span></span>
<span id="cb61-350"><a href="#cb61-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.shape =</span> <span class="dv">21</span>,</span>
<span id="cb61-351"><a href="#cb61-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.fill  =</span> <span class="cn">NA</span>,</span>
<span id="cb61-352"><a href="#cb61-352" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend   =</span> <span class="cn">FALSE</span></span>
<span id="cb61-353"><a href="#cb61-353" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-354"><a href="#cb61-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-355"><a href="#cb61-355" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. dummy layer that only feeds the legend (square keys)</span></span>
<span id="cb61-356"><a href="#cb61-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb61-357"><a href="#cb61-357" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">name =</span> <span class="fu">names</span>(region_col), <span class="at">x =</span> <span class="cn">NA_real_</span>, <span class="at">y =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb61-358"><a href="#cb61-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(x, y, <span class="at">fill =</span> name),</span>
<span id="cb61-359"><a href="#cb61-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape        =</span> <span class="dv">22</span>,        <span class="co"># solid square</span></span>
<span id="cb61-360"><a href="#cb61-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">size         =</span> <span class="dv">6</span>,</span>
<span id="cb61-361"><a href="#cb61-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">stroke       =</span> <span class="dv">0</span>,</span>
<span id="cb61-362"><a href="#cb61-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend  =</span> <span class="cn">TRUE</span>,</span>
<span id="cb61-363"><a href="#cb61-363" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes  =</span> <span class="cn">FALSE</span></span>
<span id="cb61-364"><a href="#cb61-364" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb61-365"><a href="#cb61-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-366"><a href="#cb61-366" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ---- scales -----------------------------------------------------------</span></span>
<span id="cb61-367"><a href="#cb61-367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">"Region"</span>) <span class="sc">+</span></span>
<span id="cb61-368"><a href="#cb61-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> region_col, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb61-369"><a href="#cb61-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-370"><a href="#cb61-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb61-371"><a href="#cb61-371" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow       =</span> <span class="dv">2</span>,                 <span class="co"># 1 column ⇒ 4 rows</span></span>
<span id="cb61-372"><a href="#cb61-372" aria-hidden="true" tabindex="-1"></a>    <span class="at">byrow      =</span> <span class="cn">TRUE</span>,</span>
<span id="cb61-373"><a href="#cb61-373" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywidth   =</span> <span class="fu">unit</span>(<span class="fl">0.6</span>, <span class="st">"cm"</span>),   <span class="co"># square keys</span></span>
<span id="cb61-374"><a href="#cb61-374" aria-hidden="true" tabindex="-1"></a>    <span class="at">keyheight  =</span> <span class="fu">unit</span>(<span class="fl">0.6</span>, <span class="st">"cm"</span>)</span>
<span id="cb61-375"><a href="#cb61-375" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb61-376"><a href="#cb61-376" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ---- labels &amp; theme ---------------------------------------------------</span></span>
<span id="cb61-377"><a href="#cb61-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb61-378"><a href="#cb61-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb61-379"><a href="#cb61-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Trends of HW intensity (°C per year)"</span></span>
<span id="cb61-380"><a href="#cb61-380" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-381"><a href="#cb61-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb61-382"><a href="#cb61-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb61-383"><a href="#cb61-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb61-384"><a href="#cb61-384" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text       =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb61-385"><a href="#cb61-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-386"><a href="#cb61-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.15</span>),   <span class="co"># (x, y) in npc units</span></span>
<span id="cb61-387"><a href="#cb61-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),         <span class="co"># anchor by its top-left corner</span></span>
<span id="cb61-388"><a href="#cb61-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"vertical"</span>,      <span class="co"># keeps items vertical</span></span>
<span id="cb61-389"><a href="#cb61-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb61-390"><a href="#cb61-390" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb61-391"><a href="#cb61-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-392"><a href="#cb61-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width      =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>),    <span class="co"># leave if you want wider keys</span></span>
<span id="cb61-393"><a href="#cb61-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb61-394"><a href="#cb61-394" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-395"><a href="#cb61-395" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ylim(c(0,0.23))</span></span>
<span id="cb61-396"><a href="#cb61-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-397"><a href="#cb61-397" aria-hidden="true" tabindex="-1"></a>plot_boxplot</span>
<span id="cb61-398"><a href="#cb61-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-399"><a href="#cb61-399" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/trend_intensity_boxplot.png"</span>, plot_boxplot, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [27]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magick)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1. read the four individual plots ───────────────────────────────────</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>img_a <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/Map_MedSea_intensity.png"</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>img_b <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/line_intensity.png"</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>img_c <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/trend_intensity.png"</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>img_d <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/trend_intensity_boxplot.png"</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2. add a corner label to each plot ──────────────────────────────────</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>stamp <span class="ot">&lt;-</span> <span class="cf">function</span>(img, letter,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">80</span>,               <span class="co"># point size of the label</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gravity =</span> <span class="st">"northwest"</span>,   <span class="co"># top-left corner</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">offset  =</span> <span class="st">"+20+15"</span>) {    <span class="co"># x,y offset from the corner</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_annotate</span>(</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    img, letter,</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">font      =</span> <span class="st">"Helvetica-Bold"</span>,</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">size      =</span> size,</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">gravity   =</span> gravity,</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">location  =</span> offset,</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">color     =</span> <span class="st">"black"</span>,</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">boxcolor  =</span> <span class="st">"white"</span>,   <span class="co"># gives a small white rectangle behind the letter</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight    =</span> <span class="dv">700</span>        <span class="co"># ensures the stroke is bold</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>img_a <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_a, <span class="st">"A"</span>)</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>img_b <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_b, <span class="st">"B"</span>)</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>img_c <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_c, <span class="st">"C"</span>)</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>img_d <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_d, <span class="st">"D"</span>)</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3. assemble the composite exactly as before ─────────────────────────</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>row1  <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(img_a, img_b), <span class="at">stack =</span> <span class="cn">FALSE</span>)  <span class="co"># side-by-side</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>row2  <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(img_c, img_d), <span class="at">stack =</span> <span class="cn">FALSE</span>)</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>combo <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(row1, row2),   <span class="at">stack =</span> <span class="cn">TRUE</span>)   <span class="co"># one above the other</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a><span class="fu">image_write</span>(combo, <span class="at">path =</span> <span class="st">"Manuscript/Figs/plot_intensity.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="duration" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="duration"><span class="header-section-number">3.3.3</span> Duration</h3>
<div class="cell-container"><div class="cell-decorator"><pre>In [28]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridisLite)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggspatial)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Utilities.Package)</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>region_col <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># greens</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Levantine Sea"</span> <span class="ot">=</span> <span class="st">"#008F1A"</span>,   <span class="co"># brighter pine-green</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sea of Sicily"</span> <span class="ot">=</span> <span class="st">"#6B9C3C"</span>,   <span class="co"># vivid olive-sage</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># blues / teals / purples</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Alboran Sea"</span>   <span class="ot">=</span> <span class="st">"#414E7C"</span>,   <span class="co"># richer slate-blue</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Gulf of Lyon"</span>  <span class="ot">=</span> <span class="st">"#266A78"</span>,   <span class="co"># clearer Mediterranean teal</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Adriatic sea"</span>  <span class="ot">=</span> <span class="st">"#583C68"</span>,   <span class="co"># deeper indigo-violet</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># yellows / ochres</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Balearic Sea"</span>  <span class="ot">=</span> <span class="st">"#A98C3D"</span>,   <span class="co"># crisp mustard-ochre</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Aegean Sea"</span>    <span class="ot">=</span> <span class="st">"#D7A543"</span>,   <span class="co"># sun-baked golden-ochre</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reds / oranges / browns</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tyrrhenian Sea"</span><span class="ot">=</span> <span class="st">"#A02A2A"</span>,   <span class="co"># vivid brick-red</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Algerian Sea"</span>  <span class="ot">=</span> <span class="st">"#DF5513"</span>,   <span class="co"># bright burnt-orange</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ionian Sea"</span>    <span class="ot">=</span> <span class="st">"#705943"</span>    <span class="co"># warmer earthy-taupe</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your shapefile (replace with your path)</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"Data/mask_Med_Sea/More_regions_Med_Sea.shp"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"Black"</span>))</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Get world land polygons</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>filelist <span class="ot">&lt;-</span> <span class="st">"Outputs/SST/nc/duration_mean"</span> <span class="sc">%&gt;%</span> </span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(<span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">path =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">gsub</span>(<span class="st">".*/"</span>,<span class="st">""</span>,path),</span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">substr</span>(file,<span class="dv">15</span>,<span class="dv">18</span>))</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>stk <span class="ot">&lt;-</span> filelist<span class="sc">$</span>path <span class="sc">%&gt;%</span> </span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>() </span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(stk) <span class="ot">&lt;-</span> filelist<span class="sc">$</span>year</span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a><span class="co"># stk[is.na(stk)] &lt;- 0  </span></span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>stk_avg <span class="ot">&lt;-</span> <span class="fu">mean</span>(stk, <span class="at">na.rm =</span> T)</span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>map_duration <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── data layers ─────────────────────────────────────────────</span></span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>  tidyterra<span class="sc">::</span><span class="fu">geom_spatraster</span>(<span class="at">data =</span> stk_avg,</span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">aes</span>(<span class="at">fill =</span> mean)) <span class="sc">+</span> </span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── colour scales ───────────────────────────────────────────</span></span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(</span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours  =</span> <span class="fu">turbo</span>(<span class="dv">10</span>),</span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">name     =</span> <span class="st">"Mean duration of HW events (days)"</span></span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── horizontal guide with title on top ──────────────────────</span></span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.position =</span> <span class="st">"bottom"</span>,            <span class="co"># optional – labels below bar</span></span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="dv">5</span>, <span class="st">"cm"</span>),       <span class="co"># tweak length</span></span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.45</span>, <span class="st">"cm"</span>)     <span class="co"># tweak thickness</span></span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── map extent ──────────────────────────────────────────────</span></span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">40</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">47</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── *** scale bar *** ───────────────────────────────────────</span></span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotation_scale</span>(</span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">location   =</span> <span class="st">"bl"</span>,   <span class="co"># bottom-left</span></span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">width_hint =</span> <span class="fl">0.25</span>,   <span class="co"># ≈25 % of the map width</span></span>
<span id="cb63-83"><a href="#cb63-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">line_width =</span> <span class="fl">0.6</span>,</span>
<span id="cb63-84"><a href="#cb63-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">text_cex   =</span> <span class="dv">2</span>,</span>
<span id="cb63-85"><a href="#cb63-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad_x      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb63-86"><a href="#cb63-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad_y      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb63-87"><a href="#cb63-87" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb63-88"><a href="#cb63-88" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── theme ───────────────────────────────────────────────────</span></span>
<span id="cb63-89"><a href="#cb63-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb63-90"><a href="#cb63-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb63-91"><a href="#cb63-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid        =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>),</span>
<span id="cb63-92"><a href="#cb63-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background  =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>),</span>
<span id="cb63-93"><a href="#cb63-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb63-94"><a href="#cb63-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-95"><a href="#cb63-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># move legend INSIDE, upper-left; anchor by its top-left corner</span></span>
<span id="cb63-96"><a href="#cb63-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),   <span class="co"># npc coords (x = 2 %, y = 98 %)</span></span>
<span id="cb63-97"><a href="#cb63-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb63-98"><a href="#cb63-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb63-99"><a href="#cb63-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-100"><a href="#cb63-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title.align    =</span> <span class="fl">0.5</span>,             <span class="co"># centre title</span></span>
<span id="cb63-101"><a href="#cb63-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb63-102"><a href="#cb63-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-103"><a href="#cb63-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># give legend a white background &amp; a bit of padding</span></span>
<span id="cb63-104"><a href="#cb63-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>,<span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb63-105"><a href="#cb63-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb63-106"><a href="#cb63-106" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-107"><a href="#cb63-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-108"><a href="#cb63-108" aria-hidden="true" tabindex="-1"></a>map_duration</span>
<span id="cb63-109"><a href="#cb63-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-110"><a href="#cb63-110" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/Map_MedSea_duration.png"</span>, map_duration, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb63-111"><a href="#cb63-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-112"><a href="#cb63-112" aria-hidden="true" tabindex="-1"></a><span class="do">############ Line plot by region</span></span>
<span id="cb63-113"><a href="#cb63-113" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(med_regions, <span class="fu">crs</span>(stk))</span>
<span id="cb63-114"><a href="#cb63-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-115"><a href="#cb63-115" aria-hidden="true" tabindex="-1"></a><span class="co"># med_regions &lt;- st_zm(med_regions)</span></span>
<span id="cb63-116"><a href="#cb63-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-117"><a href="#cb63-117" aria-hidden="true" tabindex="-1"></a>zone_rast <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(med_regions, stk[[<span class="dv">1</span>]], <span class="at">field =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(med_regions))</span>
<span id="cb63-118"><a href="#cb63-118" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(zone_rast)</span>
<span id="cb63-119"><a href="#cb63-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that terra::zonal will apply: returns a 3-element vector</span></span>
<span id="cb63-120"><a href="#cb63-120" aria-hidden="true" tabindex="-1"></a>qfun <span class="ot">&lt;-</span> <span class="cf">function</span>(values, ...) {</span>
<span id="cb63-121"><a href="#cb63-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(values, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-122"><a href="#cb63-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-123"><a href="#cb63-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-124"><a href="#cb63-124" aria-hidden="true" tabindex="-1"></a><span class="co"># zonal() summarises **all layers at once**</span></span>
<span id="cb63-125"><a href="#cb63-125" aria-hidden="true" tabindex="-1"></a>z_raw <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(stk, zone_rast, <span class="at">fun =</span> qfun)</span>
<span id="cb63-126"><a href="#cb63-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-127"><a href="#cb63-127" aria-hidden="true" tabindex="-1"></a>z_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(z_raw)  <span class="sc">%&gt;%</span> </span>
<span id="cb63-128"><a href="#cb63-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">region =</span> med_regions<span class="sc">$</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb63-129"><a href="#cb63-129" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>layer) <span class="sc">%&gt;%</span> <span class="co"># attach names</span></span>
<span id="cb63-130"><a href="#cb63-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="sc">-</span>region),</span>
<span id="cb63-131"><a href="#cb63-131" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to   =</span> <span class="st">"year"</span>,</span>
<span id="cb63-132"><a href="#cb63-132" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"mean"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb63-133"><a href="#cb63-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year))</span>
<span id="cb63-134"><a href="#cb63-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-135"><a href="#cb63-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-136"><a href="#cb63-136" aria-hidden="true" tabindex="-1"></a>plot_lines <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(z_df, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> mean, <span class="at">colour =</span> region)) <span class="sc">+</span></span>
<span id="cb63-137"><a href="#cb63-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb63-138"><a href="#cb63-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb63-139"><a href="#cb63-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> region_col) <span class="sc">+</span></span>
<span id="cb63-140"><a href="#cb63-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-141"><a href="#cb63-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb63-142"><a href="#cb63-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">method    =</span> <span class="st">"gam"</span>,</span>
<span id="cb63-143"><a href="#cb63-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">1.2</span>,</span>
<span id="cb63-144"><a href="#cb63-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha     =</span> <span class="fl">0.05</span>,</span>
<span id="cb63-145"><a href="#cb63-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula     =</span> (y) <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">3</span>),  <span class="co"># &lt;-- k goes here</span></span>
<span id="cb63-146"><a href="#cb63-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb63-147"><a href="#cb63-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-148"><a href="#cb63-148" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── 1. force a ONE-column legend ────────────────────────────</span></span>
<span id="cb63-149"><a href="#cb63-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb63-150"><a href="#cb63-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">ncol =</span> <span class="dv">1</span>)   <span class="co"># 1 column, items stacked</span></span>
<span id="cb63-151"><a href="#cb63-151" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb63-152"><a href="#cb63-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ylim(c(0,11.25))+</span></span>
<span id="cb63-153"><a href="#cb63-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-154"><a href="#cb63-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour =</span> <span class="st">"Regions"</span>, <span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="st">"Mean duration of HW events (days)"</span>) <span class="sc">+</span></span>
<span id="cb63-155"><a href="#cb63-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-156"><a href="#cb63-156" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ── 2. theme tweaks to pin legend inside, top-left ──────────</span></span>
<span id="cb63-157"><a href="#cb63-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb63-158"><a href="#cb63-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb63-159"><a href="#cb63-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb63-160"><a href="#cb63-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text       =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb63-161"><a href="#cb63-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-162"><a href="#cb63-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),   <span class="co"># (x, y) in npc units</span></span>
<span id="cb63-163"><a href="#cb63-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),         <span class="co"># anchor by its top-left corner</span></span>
<span id="cb63-164"><a href="#cb63-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"vertical"</span>,      <span class="co"># keeps items vertical</span></span>
<span id="cb63-165"><a href="#cb63-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb63-166"><a href="#cb63-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb63-167"><a href="#cb63-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-168"><a href="#cb63-168" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width      =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>)    <span class="co"># leave if you want wider keys</span></span>
<span id="cb63-169"><a href="#cb63-169" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-170"><a href="#cb63-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-171"><a href="#cb63-171" aria-hidden="true" tabindex="-1"></a>plot_lines</span>
<span id="cb63-172"><a href="#cb63-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-173"><a href="#cb63-173" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/line_duration.png"</span>, plot_lines, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb63-174"><a href="#cb63-174" aria-hidden="true" tabindex="-1"></a><span class="do">###################### MAP of TREND</span></span>
<span id="cb63-175"><a href="#cb63-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-176"><a href="#cb63-176" aria-hidden="true" tabindex="-1"></a>df_map_duration_long <span class="ot">&lt;-</span> stk <span class="sc">%&gt;%</span></span>
<span id="cb63-177"><a href="#cb63-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb63-178"><a href="#cb63-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb63-179"><a href="#cb63-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(ID,x,y), <span class="at">values_to =</span> <span class="st">"value"</span>, <span class="at">names_to =</span> <span class="st">"year"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb63-180"><a href="#cb63-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(value) <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb63-181"><a href="#cb63-181" aria-hidden="true" tabindex="-1"></a>                           T <span class="sc">~</span> value)) <span class="sc">%&gt;%</span> </span>
<span id="cb63-182"><a href="#cb63-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year)) <span class="sc">%&gt;%</span> </span>
<span id="cb63-183"><a href="#cb63-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb63-184"><a href="#cb63-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">trend =</span> <span class="fu">coef</span>(<span class="fu">lm</span>(value <span class="sc">~</span> year))[<span class="dv">2</span>])</span>
<span id="cb63-185"><a href="#cb63-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-186"><a href="#cb63-186" aria-hidden="true" tabindex="-1"></a>df_duration <span class="ot">&lt;-</span> stk <span class="sc">%&gt;%</span></span>
<span id="cb63-187"><a href="#cb63-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="at">xy =</span> T) <span class="sc">%&gt;%</span>  </span>
<span id="cb63-188"><a href="#cb63-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb63-189"><a href="#cb63-189" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(x,y,ID))</span>
<span id="cb63-190"><a href="#cb63-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-191"><a href="#cb63-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-192"><a href="#cb63-192" aria-hidden="true" tabindex="-1"></a>df_trend <span class="ot">&lt;-</span> df_map_duration_long <span class="sc">%&gt;%</span> </span>
<span id="cb63-193"><a href="#cb63-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr::filter(trend &lt; quantile(trend, probs = 0.95)) %&gt;% </span></span>
<span id="cb63-194"><a href="#cb63-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_duration, <span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb63-195"><a href="#cb63-195" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>ID) <span class="sc">%&gt;%</span> </span>
<span id="cb63-196"><a href="#cb63-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(x,y,trend)</span>
<span id="cb63-197"><a href="#cb63-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-198"><a href="#cb63-198" aria-hidden="true" tabindex="-1"></a>rast_trend <span class="ot">&lt;-</span> stk<span class="sc">$</span><span class="st">`</span><span class="at">1982</span><span class="st">`</span></span>
<span id="cb63-199"><a href="#cb63-199" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(rast_trend) <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb63-200"><a href="#cb63-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-201"><a href="#cb63-201" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">vect</span>(df_trend, <span class="at">geom =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="fu">crs</span>(rast_trend))</span>
<span id="cb63-202"><a href="#cb63-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-203"><a href="#cb63-203" aria-hidden="true" tabindex="-1"></a>rast_trend <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rasterize</span>(</span>
<span id="cb63-204"><a href="#cb63-204" aria-hidden="true" tabindex="-1"></a>  pts,             <span class="co"># what to burn</span></span>
<span id="cb63-205"><a href="#cb63-205" aria-hidden="true" tabindex="-1"></a>  rast_trend,         <span class="co"># target raster geometry</span></span>
<span id="cb63-206"><a href="#cb63-206" aria-hidden="true" tabindex="-1"></a>  <span class="at">field =</span> <span class="st">"trend"</span>, <span class="co"># column to transfer</span></span>
<span id="cb63-207"><a href="#cb63-207" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun   =</span> <span class="st">"mean"</span>   <span class="co"># how to handle duplicate points (mean, max, sum, …)</span></span>
<span id="cb63-208"><a href="#cb63-208" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-209"><a href="#cb63-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-210"><a href="#cb63-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that terra::zonal will apply: returns a 3-element vector</span></span>
<span id="cb63-211"><a href="#cb63-211" aria-hidden="true" tabindex="-1"></a>qfun <span class="ot">&lt;-</span> <span class="cf">function</span>(values, ...) {</span>
<span id="cb63-212"><a href="#cb63-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(values, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-213"><a href="#cb63-213" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-214"><a href="#cb63-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-215"><a href="#cb63-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-216"><a href="#cb63-216" aria-hidden="true" tabindex="-1"></a><span class="co"># zonal() summarises **all layers at once**</span></span>
<span id="cb63-217"><a href="#cb63-217" aria-hidden="true" tabindex="-1"></a>z_raw_trend <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">zonal</span>(rast_trend, zone_rast, <span class="at">fun =</span> qfun)</span>
<span id="cb63-218"><a href="#cb63-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-219"><a href="#cb63-219" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.  Add centroid geometry and its coordinates to `med_regions`</span></span>
<span id="cb63-220"><a href="#cb63-220" aria-hidden="true" tabindex="-1"></a>med_regions <span class="ot">&lt;-</span> med_regions <span class="sc">%&gt;%</span>                                 <span class="co"># already an sf multipolygon</span></span>
<span id="cb63-221"><a href="#cb63-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">centroid =</span> <span class="fu">st_centroid</span>(geometry),                     <span class="co"># geometry column is usually called `geometry`</span></span>
<span id="cb63-222"><a href="#cb63-222" aria-hidden="true" tabindex="-1"></a>         <span class="at">lon      =</span> <span class="fu">st_coordinates</span>(centroid)[, <span class="dv">1</span>],             <span class="co"># X</span></span>
<span id="cb63-223"><a href="#cb63-223" aria-hidden="true" tabindex="-1"></a>         <span class="at">lat      =</span> <span class="fu">st_coordinates</span>(centroid)[, <span class="dv">2</span>])             <span class="co"># Y</span></span>
<span id="cb63-224"><a href="#cb63-224" aria-hidden="true" tabindex="-1"></a><span class="co">#   └─&gt; use st_point_on_surface(geometry) instead of st_centroid() if you</span></span>
<span id="cb63-225"><a href="#cb63-225" aria-hidden="true" tabindex="-1"></a><span class="co">#       must ensure the point falls inside every (multi)polygon</span></span>
<span id="cb63-226"><a href="#cb63-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-227"><a href="#cb63-227" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.  Keep only what you want to join</span></span>
<span id="cb63-228"><a href="#cb63-228" aria-hidden="true" tabindex="-1"></a>centroids_tbl <span class="ot">&lt;-</span> med_regions <span class="sc">%&gt;%</span> </span>
<span id="cb63-229"><a href="#cb63-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span>                                       <span class="co"># drops *all* sf geometries</span></span>
<span id="cb63-230"><a href="#cb63-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name, lon, lat)  </span>
<span id="cb63-231"><a href="#cb63-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-232"><a href="#cb63-232" aria-hidden="true" tabindex="-1"></a>z_df_trend <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(z_raw_trend)  <span class="sc">%&gt;%</span> </span>
<span id="cb63-233"><a href="#cb63-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">region =</span> med_regions<span class="sc">$</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb63-234"><a href="#cb63-234" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>layer) <span class="sc">%&gt;%</span></span>
<span id="cb63-235"><a href="#cb63-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean =</span> <span class="fu">round</span>(mean,<span class="dv">3</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb63-236"><a href="#cb63-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(centroids_tbl, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"region"</span> <span class="ot">=</span> <span class="st">"name"</span>))</span>
<span id="cb63-237"><a href="#cb63-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-238"><a href="#cb63-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-239"><a href="#cb63-239" aria-hidden="true" tabindex="-1"></a>map_trend <span class="ot">&lt;-</span> df_map_duration_long <span class="sc">%&gt;%</span> </span>
<span id="cb63-240"><a href="#cb63-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_duration, <span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb63-241"><a href="#cb63-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb63-242"><a href="#cb63-242" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── data layers ───────────────────────────────────────────</span></span>
<span id="cb63-243"><a href="#cb63-243" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> trend)) <span class="sc">+</span></span>
<span id="cb63-244"><a href="#cb63-244" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb63-245"><a href="#cb63-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-246"><a href="#cb63-246" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── colour scale ──────────────────────────────────────────</span></span>
<span id="cb63-247"><a href="#cb63-247" aria-hidden="true" tabindex="-1"></a>    tidyterra<span class="sc">::</span><span class="fu">scale_fill_grass_c</span>(</span>
<span id="cb63-248"><a href="#cb63-248" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Trends of HW duration (days per year)"</span>,</span>
<span id="cb63-249"><a href="#cb63-249" aria-hidden="true" tabindex="-1"></a>      <span class="at">use_grass_range =</span> <span class="cn">FALSE</span> </span>
<span id="cb63-250"><a href="#cb63-250" aria-hidden="true" tabindex="-1"></a>      <span class="co"># trans = "asn"</span></span>
<span id="cb63-251"><a href="#cb63-251" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb63-252"><a href="#cb63-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-253"><a href="#cb63-253" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── 1. horizontal colour bar, title on top ───────────────</span></span>
<span id="cb63-254"><a href="#cb63-254" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(</span>
<span id="cb63-255"><a href="#cb63-255" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb63-256"><a href="#cb63-256" aria-hidden="true" tabindex="-1"></a>        <span class="at">direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb63-257"><a href="#cb63-257" aria-hidden="true" tabindex="-1"></a>        <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb63-258"><a href="#cb63-258" aria-hidden="true" tabindex="-1"></a>        <span class="at">label.position =</span> <span class="st">"bottom"</span>,            <span class="co"># labels under the bar (optional)</span></span>
<span id="cb63-259"><a href="#cb63-259" aria-hidden="true" tabindex="-1"></a>        <span class="at">barwidth       =</span> <span class="fu">unit</span>(<span class="dv">10</span>, <span class="st">"cm"</span>),       <span class="co"># adjust length</span></span>
<span id="cb63-260"><a href="#cb63-260" aria-hidden="true" tabindex="-1"></a>        <span class="at">barheight      =</span> <span class="fu">unit</span>(<span class="fl">0.45</span>, <span class="st">"cm"</span>)     <span class="co"># adjust thickness</span></span>
<span id="cb63-261"><a href="#cb63-261" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-262"><a href="#cb63-262" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb63-263"><a href="#cb63-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-264"><a href="#cb63-264" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── map extent ───────────────────────────────────────────</span></span>
<span id="cb63-265"><a href="#cb63-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">40</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">47</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb63-266"><a href="#cb63-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-267"><a href="#cb63-267" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── region means &amp; colours ───────────────────────────────</span></span>
<span id="cb63-268"><a href="#cb63-268" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="at">data =</span> z_df_trend,</span>
<span id="cb63-269"><a href="#cb63-269" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">label =</span> mean, <span class="at">colour =</span> region),</span>
<span id="cb63-270"><a href="#cb63-270" aria-hidden="true" tabindex="-1"></a>              <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.7</span>), <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb63-271"><a href="#cb63-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb63-272"><a href="#cb63-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-273"><a href="#cb63-273" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── scale bar ────────────────────────────────────────────</span></span>
<span id="cb63-274"><a href="#cb63-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotation_scale</span>(</span>
<span id="cb63-275"><a href="#cb63-275" aria-hidden="true" tabindex="-1"></a>      <span class="at">location   =</span> <span class="st">"bl"</span>,</span>
<span id="cb63-276"><a href="#cb63-276" aria-hidden="true" tabindex="-1"></a>      <span class="at">width_hint =</span> <span class="fl">0.25</span>,</span>
<span id="cb63-277"><a href="#cb63-277" aria-hidden="true" tabindex="-1"></a>      <span class="at">line_width =</span> <span class="fl">0.6</span>,</span>
<span id="cb63-278"><a href="#cb63-278" aria-hidden="true" tabindex="-1"></a>      <span class="at">text_cex   =</span> <span class="dv">2</span>,</span>
<span id="cb63-279"><a href="#cb63-279" aria-hidden="true" tabindex="-1"></a>      <span class="at">pad_x      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb63-280"><a href="#cb63-280" aria-hidden="true" tabindex="-1"></a>      <span class="at">pad_y      =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>)</span>
<span id="cb63-281"><a href="#cb63-281" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb63-282"><a href="#cb63-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-283"><a href="#cb63-283" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ── theme ────────────────────────────────────────────────</span></span>
<span id="cb63-284"><a href="#cb63-284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb63-285"><a href="#cb63-285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb63-286"><a href="#cb63-286" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid        =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"gray90"</span>),</span>
<span id="cb63-287"><a href="#cb63-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.background  =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>),</span>
<span id="cb63-288"><a href="#cb63-288" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb63-289"><a href="#cb63-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-290"><a href="#cb63-290" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2. park legend INSIDE, top-left</span></span>
<span id="cb63-291"><a href="#cb63-291" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.98</span>),  <span class="co"># npc coords: 2 % from left, 98 % up</span></span>
<span id="cb63-292"><a href="#cb63-292" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),        <span class="co"># anchor by its top-left corner</span></span>
<span id="cb63-293"><a href="#cb63-293" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction      =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb63-294"><a href="#cb63-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-295"><a href="#cb63-295" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text           =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb63-296"><a href="#cb63-296" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb63-297"><a href="#cb63-297" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb63-298"><a href="#cb63-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-299"><a href="#cb63-299" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title            =</span> <span class="fu">element_blank</span>()</span>
<span id="cb63-300"><a href="#cb63-300" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-301"><a href="#cb63-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-302"><a href="#cb63-302" aria-hidden="true" tabindex="-1"></a>map_trend</span>
<span id="cb63-303"><a href="#cb63-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-304"><a href="#cb63-304" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/trend_duration.png"</span>, map_trend, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span>
<span id="cb63-305"><a href="#cb63-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-306"><a href="#cb63-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-307"><a href="#cb63-307" aria-hidden="true" tabindex="-1"></a><span class="do">### BOXPLOT</span></span>
<span id="cb63-308"><a href="#cb63-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-309"><a href="#cb63-309" aria-hidden="true" tabindex="-1"></a><span class="co"># ── libraries ───────────────────────────────────────────────────────────</span></span>
<span id="cb63-310"><a href="#cb63-310" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)   <span class="co"># raster/terra objects</span></span>
<span id="cb63-311"><a href="#cb63-311" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)      <span class="co"># modern vector data</span></span>
<span id="cb63-312"><a href="#cb63-312" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># plotting</span></span>
<span id="cb63-313"><a href="#cb63-313" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)   <span class="co"># pipe-friendly helpers (optional)</span></span>
<span id="cb63-314"><a href="#cb63-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-315"><a href="#cb63-315" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1. load data ────────────────────────────────────────────────────────</span></span>
<span id="cb63-316"><a href="#cb63-316" aria-hidden="true" tabindex="-1"></a>r   <span class="ot">&lt;-</span> rast_trend         <span class="co"># single- or multi-band</span></span>
<span id="cb63-317"><a href="#cb63-317" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">&lt;-</span> med_regions           <span class="co"># polygons</span></span>
<span id="cb63-318"><a href="#cb63-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-319"><a href="#cb63-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure both layers share the same CRS</span></span>
<span id="cb63-320"><a href="#cb63-320" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(reg, <span class="fu">crs</span>(r))</span>
<span id="cb63-321"><a href="#cb63-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-322"><a href="#cb63-322" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2. extract values per polygon ───────────────────────────────────────</span></span>
<span id="cb63-323"><a href="#cb63-323" aria-hidden="true" tabindex="-1"></a><span class="co"># terra::extract() returns a data.frame: one row per cell per polygon</span></span>
<span id="cb63-324"><a href="#cb63-324" aria-hidden="true" tabindex="-1"></a><span class="co">#   ID   = polygon index (generated automatically)</span></span>
<span id="cb63-325"><a href="#cb63-325" aria-hidden="true" tabindex="-1"></a><span class="co">#   lyr1 = raster value (one column per raster layer)</span></span>
<span id="cb63-326"><a href="#cb63-326" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb63-327"><a href="#cb63-327" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(r, <span class="fu">vect</span>(reg))            <span class="co"># vect() converts sf → SpatVector</span></span>
<span id="cb63-328"><a href="#cb63-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-329"><a href="#cb63-329" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3. tidy up: attach region names / attributes ───────────────────────</span></span>
<span id="cb63-330"><a href="#cb63-330" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppose your regions layer has a column called "NAME"</span></span>
<span id="cb63-331"><a href="#cb63-331" aria-hidden="true" tabindex="-1"></a>ID_name <span class="ot">&lt;-</span> reg <span class="sc">%&gt;%</span> </span>
<span id="cb63-332"><a href="#cb63-332" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span>  </span>
<span id="cb63-333"><a href="#cb63-333" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),</span>
<span id="cb63-334"><a href="#cb63-334" aria-hidden="true" tabindex="-1"></a>                    <span class="at">name =</span> <span class="fu">as_factor</span>(name))  <span class="sc">%&gt;%</span>       <span class="co"># ensure matching ID</span></span>
<span id="cb63-335"><a href="#cb63-335" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(ID, name)</span>
<span id="cb63-336"><a href="#cb63-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-337"><a href="#cb63-337" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> vals <span class="sc">%&gt;%</span> </span>
<span id="cb63-338"><a href="#cb63-338" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(ID_name,<span class="at">by =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb63-339"><a href="#cb63-339" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(mean <span class="sc">!=</span> <span class="dv">0</span>)<span class="sc">%&gt;%</span>                       <span class="co"># your summary data-frame</span></span>
<span id="cb63-340"><a href="#cb63-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-341"><a href="#cb63-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">fct_reorder</span>(name, mean, <span class="at">.desc =</span> <span class="cn">TRUE</span>)  <span class="co"># order by mean, descending</span></span>
<span id="cb63-342"><a href="#cb63-342" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-343"><a href="#cb63-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-344"><a href="#cb63-344" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 4. plot ─────────────────────────────────────────────────────────────</span></span>
<span id="cb63-345"><a href="#cb63-345" aria-hidden="true" tabindex="-1"></a>plot_boxplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb63-346"><a href="#cb63-346" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. data layer (legend suppressed)</span></span>
<span id="cb63-347"><a href="#cb63-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(</span>
<span id="cb63-348"><a href="#cb63-348" aria-hidden="true" tabindex="-1"></a>    <span class="at">data          =</span> vals,</span>
<span id="cb63-349"><a href="#cb63-349" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> name, <span class="at">y =</span> mean, <span class="at">fill =</span> name),</span>
<span id="cb63-350"><a href="#cb63-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour        =</span> <span class="st">"black"</span>,</span>
<span id="cb63-351"><a href="#cb63-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth     =</span> <span class="fl">0.7</span>,</span>
<span id="cb63-352"><a href="#cb63-352" aria-hidden="true" tabindex="-1"></a>    <span class="co"># size = 2,</span></span>
<span id="cb63-353"><a href="#cb63-353" aria-hidden="true" tabindex="-1"></a>    <span class="co"># alpha         = .60,</span></span>
<span id="cb63-354"><a href="#cb63-354" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.shape =</span> <span class="dv">21</span>,</span>
<span id="cb63-355"><a href="#cb63-355" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier.fill  =</span> <span class="cn">NA</span>,</span>
<span id="cb63-356"><a href="#cb63-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend   =</span> <span class="cn">FALSE</span></span>
<span id="cb63-357"><a href="#cb63-357" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb63-358"><a href="#cb63-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-359"><a href="#cb63-359" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. dummy layer that only feeds the legend (square keys)</span></span>
<span id="cb63-360"><a href="#cb63-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb63-361"><a href="#cb63-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">name =</span> <span class="fu">names</span>(region_col), <span class="at">x =</span> <span class="cn">NA_real_</span>, <span class="at">y =</span> <span class="cn">NA_real_</span>),</span>
<span id="cb63-362"><a href="#cb63-362" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(x, y, <span class="at">fill =</span> name),</span>
<span id="cb63-363"><a href="#cb63-363" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape        =</span> <span class="dv">22</span>,        <span class="co"># solid square</span></span>
<span id="cb63-364"><a href="#cb63-364" aria-hidden="true" tabindex="-1"></a>    <span class="at">size         =</span> <span class="dv">6</span>,</span>
<span id="cb63-365"><a href="#cb63-365" aria-hidden="true" tabindex="-1"></a>    <span class="at">stroke       =</span> <span class="dv">0</span>,</span>
<span id="cb63-366"><a href="#cb63-366" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend  =</span> <span class="cn">TRUE</span>,</span>
<span id="cb63-367"><a href="#cb63-367" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes  =</span> <span class="cn">FALSE</span></span>
<span id="cb63-368"><a href="#cb63-368" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb63-369"><a href="#cb63-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-370"><a href="#cb63-370" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ---- scales -----------------------------------------------------------</span></span>
<span id="cb63-371"><a href="#cb63-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> region_col, <span class="at">name =</span> <span class="st">"Region"</span>) <span class="sc">+</span></span>
<span id="cb63-372"><a href="#cb63-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> region_col, <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb63-373"><a href="#cb63-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-374"><a href="#cb63-374" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb63-375"><a href="#cb63-375" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow       =</span> <span class="dv">2</span>,                 <span class="co"># 1 column ⇒ 4 rows</span></span>
<span id="cb63-376"><a href="#cb63-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">byrow      =</span> <span class="cn">TRUE</span>,</span>
<span id="cb63-377"><a href="#cb63-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywidth   =</span> <span class="fu">unit</span>(<span class="fl">0.6</span>, <span class="st">"cm"</span>),   <span class="co"># square keys</span></span>
<span id="cb63-378"><a href="#cb63-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">keyheight  =</span> <span class="fu">unit</span>(<span class="fl">0.6</span>, <span class="st">"cm"</span>)</span>
<span id="cb63-379"><a href="#cb63-379" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb63-380"><a href="#cb63-380" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ---- labels &amp; theme ---------------------------------------------------</span></span>
<span id="cb63-381"><a href="#cb63-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb63-382"><a href="#cb63-382" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb63-383"><a href="#cb63-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Trends of HW duration (days per year)"</span></span>
<span id="cb63-384"><a href="#cb63-384" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb63-385"><a href="#cb63-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb63-386"><a href="#cb63-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb63-387"><a href="#cb63-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background   =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb63-388"><a href="#cb63-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text       =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb63-389"><a href="#cb63-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-390"><a href="#cb63-390" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position       =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.15</span>),   <span class="co"># (x, y) in npc units</span></span>
<span id="cb63-391"><a href="#cb63-391" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification  =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),         <span class="co"># anchor by its top-left corner</span></span>
<span id="cb63-392"><a href="#cb63-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction      =</span> <span class="st">"vertical"</span>,      <span class="co"># keeps items vertical</span></span>
<span id="cb63-393"><a href="#cb63-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background     =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>),</span>
<span id="cb63-394"><a href="#cb63-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin         =</span> <span class="fu">margin</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb63-395"><a href="#cb63-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-396"><a href="#cb63-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width      =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>),    <span class="co"># leave if you want wider keys</span></span>
<span id="cb63-397"><a href="#cb63-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb63-398"><a href="#cb63-398" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-399"><a href="#cb63-399" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ylim(c(0,0.23))</span></span>
<span id="cb63-400"><a href="#cb63-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-401"><a href="#cb63-401" aria-hidden="true" tabindex="-1"></a>plot_boxplot</span>
<span id="cb63-402"><a href="#cb63-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-403"><a href="#cb63-403" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"Manuscript/Figs/trend_duration_boxplot.png"</span>, plot_boxplot, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">height =</span><span class="dv">575</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">width =</span> <span class="dv">1319</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">units =</span> <span class="st">"px"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [29]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magick)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1. read the four individual plots ───────────────────────────────────</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>img_a <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/Map_MedSea_duration.png"</span>)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>img_b <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/line_duration.png"</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>img_c <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/trend_duration.png"</span>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>img_d <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"Manuscript/Figs/trend_duration_boxplot.png"</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2. add a corner label to each plot ──────────────────────────────────</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>stamp <span class="ot">&lt;-</span> <span class="cf">function</span>(img, letter,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">80</span>,               <span class="co"># point size of the label</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gravity =</span> <span class="st">"northwest"</span>,   <span class="co"># top-left corner</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">offset  =</span> <span class="st">"+20+15"</span>) {    <span class="co"># x,y offset from the corner</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_annotate</span>(</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    img, letter,</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">font      =</span> <span class="st">"Helvetica-Bold"</span>,</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">size      =</span> size,</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">gravity   =</span> gravity,</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">location  =</span> offset,</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">color     =</span> <span class="st">"black"</span>,</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">boxcolor  =</span> <span class="st">"white"</span>,   <span class="co"># gives a small white rectangle behind the letter</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight    =</span> <span class="dv">700</span>        <span class="co"># ensures the stroke is bold</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>img_a <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_a, <span class="st">"A"</span>)</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>img_b <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_b, <span class="st">"B"</span>)</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>img_c <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_c, <span class="st">"C"</span>)</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>img_d <span class="ot">&lt;-</span> <span class="fu">stamp</span>(img_d, <span class="st">"D"</span>)</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3. assemble the composite exactly as before ─────────────────────────</span></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>row1  <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(img_a, img_b), <span class="at">stack =</span> <span class="cn">FALSE</span>)  <span class="co"># side-by-side</span></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a>row2  <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(img_c, img_d), <span class="at">stack =</span> <span class="cn">FALSE</span>)</span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>combo <span class="ot">&lt;-</span> <span class="fu">image_append</span>(<span class="fu">c</span>(row1, row2),   <span class="at">stack =</span> <span class="cn">TRUE</span>)   <span class="co"># one above the other</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a><span class="fu">image_write</span>(combo, <span class="at">path =</span> <span class="st">"Manuscript/Figs/plot_duration.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Copernicus_Sentinel" class="csl-entry" role="listitem">
Copernicus, 2024. <a href="https://browser.dataspace.copernicus.eu/">Copernicus open access hub</a>.
</div>
<div id="ref-embury2024satellite" class="csl-entry" role="listitem">
Embury, O., Merchant, C.J., Good, S.A., Rayner, N.A., Høyer, J.L., Atkinson, C., Block, T., Alerskans, E., Pearson, K.J., Worsfold, M., McCarroll, N., Donlon, C., 2024. Satellite-based time-series of sea-surface temperature since 1980 for climate applications. Scientific Data 11, 326. <a href="https://doi.org/10.1038/s41597-024-03147-w">https://doi.org/10.1038/s41597-024-03147-w</a>
</div>
<div id="ref-hobday2016hierarchical" class="csl-entry" role="listitem">
Hobday, A.J., Alexander, L.V., Perkins, S.E., Smale, D.A., Straub, S.C., Oliver, E.C., Benthuysen, J.A., Burrows, M.T., Donat, M.G., Feng, M., others, 2016. A hierarchical approach to defining marine heatwaves. Progress in oceanography 141, 227–238.
</div>
<div id="ref-hobday2018categorizing" class="csl-entry" role="listitem">
Hobday, A.J., Oliver, E.C., Gupta, A.S., Benthuysen, J.A., Burrows, M.T., Donat, M.G., Holbrook, N.J., Moore, P.J., Thomsen, M.S., Wernberg, T., others, 2018. Categorizing and naming marine heatwaves. Oceanography 31, 162–173.
</div>
<div id="ref-pisano2016new" class="csl-entry" role="listitem">
Pisano, A., Nardelli, B.B., Tronconi, C., Santoleri, R., 2016. The new mediterranean optimally interpolated pathfinder AVHRR SST dataset (1982–2012). Remote Sensing of Environment 176, 107–116. <a href="https://doi.org/10.1016/j.rse.2016.01.019">https://doi.org/10.1016/j.rse.2016.01.019</a>
</div>
<div id="ref-heatwaveR" class="csl-entry" role="listitem">
Schlegel, R.W., Smit, A.J., 2018. <span class="nocase">heatwaveR</span>: A central algorithm for the detection of heatwaves and cold-spells. Journal of Open Source Software 3, 821. <a href="https://doi.org/10.21105/joss.00821">https://doi.org/10.21105/joss.00821</a>
</div>
</div>
</section>
</section>
</section>
     </main>
<!-- /main column -->  <script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>  </div> <!-- /content -->  <script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script> 
  
</body></html>